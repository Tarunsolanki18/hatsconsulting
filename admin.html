<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- CSP Temporarily Disabled for Testing -->
    <!-- <meta http-equiv="Content-Security-Policy" content="..."> -->
    <title>Admin Dashboard - HATS Consulting</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script src="assets/config.js"></script>
    <script src="assets/app.js"></script>
    <script src="assets/security.js"></script>
    <script src="auth-fix.js"></script>
    <script>
        // Global error handler
        window.addEventListener('error', function(event) {
            console.error('Global error caught:', event.error);
            const errorMessage = event.error ? event.error.message : 'Unknown error occurred';
            showNotification('Error: ' + errorMessage, 'error');
            return false;
        });
        
        // Promise rejection handler
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
            const errorMessage = event.reason ? event.reason.message : 'Promise rejection occurred';
            showNotification('Error: ' + errorMessage, 'error');
            return false;
        });
        
        // Show notification function
        function showNotification(message, type = 'info') {
            // Create notification element if it doesn't exist
            let notification = document.getElementById('notification');
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'notification';
                notification.className = 'fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transform transition-transform duration-300 translate-x-full';
                document.body.appendChild(notification);
            }
            
            // Set notification type
            if (type === 'error') {
                notification.className = 'fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transform transition-transform duration-300 bg-red-100 border-l-4 border-red-500 text-red-700';
            } else if (type === 'success') {
                notification.className = 'fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transform transition-transform duration-300 bg-green-100 border-l-4 border-green-500 text-green-700';
            } else {
                notification.className = 'fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transform transition-transform duration-300 bg-blue-100 border-l-4 border-blue-500 text-blue-700';
            }
            
            // Set message
            notification.textContent = message;
            
            // Show notification
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // Hide notification after 5 seconds
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
            }, 5000);
        }
        
        function checkRedirectLoop() {
            const now = new Date().getTime();
            const lastRedirect = sessionStorage.getItem('lastAdminRedirect');
            const redirectCount = parseInt(sessionStorage.getItem('adminRedirectCount') || '0');
            
            // More lenient redirect loop detection
            if (lastRedirect && now - parseInt(lastRedirect) < 1000) {
                if (redirectCount > 5) {
                    console.warn('Potential redirect loop detected, clearing flags');
                    sessionStorage.removeItem('lastAdminRedirect');
                    sessionStorage.removeItem('adminRedirectCount');
                    return false;
                } else {
                    sessionStorage.setItem('adminRedirectCount', (redirectCount + 1).toString());
                }
            } else {
                sessionStorage.setItem('lastAdminRedirect', now.toString());
                sessionStorage.setItem('adminRedirectCount', '1');
            }
            return true;
        }
    </script>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-lg text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
            <p class="mt-4 text-gray-700">Loading...</p>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-md">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">Admin Dashboard</h1>
            <div class="flex items-center space-x-4">
                <span id="adminName" class="text-gray-600"></span>
                <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition">
                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <!-- 1. User & Earning Management Card -->
            <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">User & Earning Management</h2>
                    <i class="fas fa-users-cog text-blue-500 text-2xl"></i>
                </div>
                <p class="text-gray-600 mb-4">Manage users, edit/delete accounts, and control user earnings</p>
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <span id="userCount" class="text-lg font-semibold text-blue-500">Loading...</span>
                        <div class="text-sm text-gray-500">Total Users</div>
                    </div>
                    <div>
                        <span id="totalEarnings" class="text-lg font-semibold text-green-500">Loading...</span>
                        <div class="text-sm text-gray-500">Total Earnings</div>
                    </div>
                </div>
                <button onclick="openUserManagement()" class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition">
                    <i class="fas fa-arrow-right mr-2"></i>Manage Users & Earnings
                </button>
            </div>
            
            <!-- 2. Check Reports Card -->
            <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">Check Reports</h2>
                    <i class="fas fa-clipboard-check text-green-500 text-2xl"></i>
                </div>
                <p class="text-gray-600 mb-4">Review Trade Reports and Account Open Reports with approval system</p>
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <span id="tradeReportCount" class="text-lg font-semibold text-orange-500">Loading...</span>
                        <div class="text-sm text-gray-500">Trade Reports</div>
                    </div>
                    <div>
                        <span id="accountReportCount" class="text-lg font-semibold text-purple-500">Loading...</span>
                        <div class="text-sm text-gray-500">Account Reports</div>
                    </div>
                </div>
                <button onclick="openReportManagement()" class="w-full bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition relative">
                    <i class="fas fa-arrow-right mr-2"></i>Check & Approve Reports
                    <span id="newReportBadge" class="hidden absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-6 w-6 flex items-center justify-center animate-pulse">
                        <i class="fas fa-exclamation"></i>
                    </span>
                </button>
            </div>
            
            <!-- 3. Campaign Management Card -->
            <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">Campaign Management</h2>
                    <i class="fas fa-bullhorn text-purple-500 text-2xl"></i>
                </div>
                <p class="text-gray-600 mb-4">Add, delete, and manage campaigns that appear in user reports</p>
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <span id="campaignCount" class="text-lg font-semibold text-purple-500">Loading...</span>
                        <div class="text-sm text-gray-500">Active Campaigns</div>
                    </div>
                    <div>
                        <span id="pendingReportCount" class="text-lg font-semibold text-yellow-500">Loading...</span>
                        <div class="text-sm text-gray-500">Pending Reports</div>
                    </div>
                </div>
                <button onclick="openCampaignManagement()" class="w-full bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition">
                    <i class="fas fa-arrow-right mr-2"></i>Manage Campaigns
                </button>
            </div>
        </div>
        
        <!-- Management Sections (Hidden by default) -->
        
        <!-- 1. User & Earning Management Section -->
        <div id="userManagementSection" class="mt-8 bg-white rounded-lg shadow-md p-6 hidden">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-semibold text-gray-800">User & Earning Management</h2>
                <div class="flex gap-2">
                    <button onclick="loadUsersTable()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                    </button>
                    <button onclick="closeAllSections()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <!-- User Management Table -->
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white">
                    <thead>
                        <tr>
                            <th class="py-2 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">User</th>
                            <th class="py-2 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Email</th>
                            <th class="py-2 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Today</th>
                            <th class="py-2 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">7 Days</th>
                            <th class="py-2 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">30 Days</th>
                            <th class="py-2 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">All Time</th>
                            <th class="py-2 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Last Login</th>
                            <th class="py-2 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Status</th>
                            <th class="py-2 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTable">
                        <!-- Users data will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 2. Report Management Section -->
        <div id="reportManagementSection" class="mt-8 bg-white rounded-lg shadow-md p-6 hidden">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-semibold text-gray-800">Check Reports</h2>
                <div class="flex gap-2">
                    <button onclick="loadReportsTable()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                    </button>
                    <button onclick="closeAllSections()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <!-- Report Type Tabs -->
            <div class="flex border-b border-gray-200 mb-6">
                <button id="allReportsTab" onclick="switchReportTab('all')" class="flex-1 py-3 font-bold text-lg border-b-2 border-blue-500 text-blue-500">All Reports</button>
                <button id="tradeReportTab" onclick="switchReportTab('trade')" class="flex-1 py-3 font-bold text-lg border-b-2 border-transparent text-gray-500">Trade Reports</button>
                <button id="accountReportTab" onclick="switchReportTab('account_open')" class="flex-1 py-3 font-bold text-lg border-b-2 border-transparent text-gray-500">Account Open Reports</button>
            </div>

            <!-- Enhanced Filters -->
            <div class="grid grid-cols-1 md:grid-cols-6 gap-4 mb-6">
                <select id="userFilter" class="px-3 py-2 border border-gray-300 rounded-lg">
                    <option value="">All Users</option>
                </select>
                <select id="statusFilter" class="px-3 py-2 border border-gray-300 rounded-lg">
                    <option value="">All Status</option>
                    <option value="pending">Pending</option>
                    <option value="account open">Account Open</option>
                    <option value="Under Review">Under Review</option>
                    <option value="not_found">Not Found</option>
                    <option value="rejected">Rejected</option>
                    <option value="trade done">Trade Done</option>
                    <option value="trade not done">Trade Not Done</option>
                </select>
                <select id="campaignFilter" class="px-3 py-2 border border-gray-300 rounded-lg">
                    <option value="">All Campaigns</option>
                </select>
                <select id="paymentFilter" class="px-3 py-2 border border-gray-300 rounded-lg">
                    <option value="">All Payment</option>
                    <option value="paid">Paid</option>
                    <option value="not_paid">Not Paid</option>
                    <option value="partial">Partial Paid</option>
                    


                </select>
                <input type="date" id="submissionDateFilter" class="px-3 py-2 border border-gray-300 rounded-lg" placeholder="Submission Date">
                <button onclick="toggleDateRangeFilter()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-calendar-alt mr-2"></i>Date Range
                </button>
                <button onclick="applyReportFilters()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-filter mr-2"></i>Apply Filters
                </button>
                <button onclick="downloadReportsCSV()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-download mr-2"></i>Download CSV
                </button>
            </div>
            
            <!-- Date Range Filter Panel (Hidden by default) -->
            <div id="dateRangePanel" class="bg-gray-50 border border-gray-200 rounded-lg p-6 mb-6 hidden">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                        <i class="fas fa-calendar-alt text-purple-500 mr-2"></i>
                        Advanced Date Range Filter
                    </h3>
                    <button onclick="closeDateRangeFilter()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Date Range Inputs -->
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">From Date</label>
                            <input type="date" id="fromDateFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">To Date</label>
                            <input type="date" id="toDateFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                    </div>
                    
                    <!-- Quick Date Presets -->
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Quick Presets</label>
                        <div class="space-y-2">
                            <button onclick="setDatePreset('today')" class="w-full text-left px-3 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 text-sm">
                                <i class="fas fa-calendar-day text-blue-500 mr-2"></i>Today
                            </button>
                            <button onclick="setDatePreset('yesterday')" class="w-full text-left px-3 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 text-sm">
                                <i class="fas fa-calendar-minus text-green-500 mr-2"></i>Yesterday
                            </button>
                            <button onclick="setDatePreset('thisWeek')" class="w-full text-left px-3 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 text-sm">
                                <i class="fas fa-calendar-week text-purple-500 mr-2"></i>This Week
                            </button>
                            <button onclick="setDatePreset('lastWeek')" class="w-full text-left px-3 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 text-sm">
                                <i class="fas fa-calendar-week text-orange-500 mr-2"></i>Last Week
                            </button>
                            <button onclick="setDatePreset('thisMonth')" class="w-full text-left px-3 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 text-sm">
                                <i class="fas fa-calendar text-red-500 mr-2"></i>This Month
                            </button>
                            <button onclick="setDatePreset('lastMonth')" class="w-full text-left px-3 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 text-sm">
                                <i class="fas fa-calendar text-gray-500 mr-2"></i>Last Month
                            </button>
                        </div>
                    </div>
                    
                    <!-- Actions and Info -->
                    <div class="space-y-4">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h4 class="text-sm font-medium text-blue-800 mb-2">
                                <i class="fas fa-info-circle mr-1"></i>Filter Info
                            </h4>
                            <p class="text-sm text-blue-700 mb-2">
                                <span id="dateRangeInfo">No date range selected</span>
                            </p>
                            <p class="text-xs text-blue-600">
                                Leave "To Date" empty to filter from "From Date" onwards
                            </p>
                        </div>
                        
                        <div class="space-y-2">
                            <button onclick="applyDateRangeFilter()" class="w-full bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg">
                                <i class="fas fa-filter mr-2"></i>Apply Date Range
                            </button>
                            <button onclick="clearDateRangeFilter()" class="w-full bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                                <i class="fas fa-times mr-2"></i>Clear Range
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Reports Table -->
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white">
                    <thead>
                        <tr>
                            <th class="py-2 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">User</th>
                            <th class="py-2 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Type</th>
                            <th class="py-2 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Application</th>
                            <th class="py-2 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Customer</th>
                            <th class="py-2 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Mobile</th>
                            <th class="py-2 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Proof</th>
                            <th class="py-2 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Notes</th>
                            <th class="py-2 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Status</th>
                            <th class="py-2 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Payment</th>
                            <th class="py-2 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Date</th>
                            <th class="py-2 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="reportsTable">
                        <!-- Reports data will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 3. Campaign Management Section -->
        <div id="campaignManagementSection" class="mt-8 bg-white rounded-lg shadow-md p-6 hidden">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-semibold text-gray-800">Campaign Management</h2>
                <div class="flex gap-2">
                    <button onclick="openAddCampaignModal()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-plus mr-2"></i>Add Campaign
                    </button>
                    <button onclick="closeAllSections()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <!-- Campaigns Table -->
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white">
                    <thead>
                        <tr>
                            <th class="py-2 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Campaign Name</th>
                            <th class="py-2 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Type</th>
                            <th class="py-2 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Payout (With/Without Trade)</th>
                            <th class="py-2 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Links</th>
                            <th class="py-2 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Status</th>
                            <th class="py-2 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Created</th>
                            <th class="py-2 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="campaignsTable">
                        <!-- Campaigns data will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Modals -->
    
    <!-- Add Campaign Modal -->
    <div id="addCampaignModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-gray-800">Add New Campaign</h2>
                <button onclick="closeAddCampaignModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="addCampaignForm">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Campaign Name *</label>
                        <input type="text" id="campaignName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter campaign name">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Campaign Type *</label>
                        <select id="campaignType" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Select Type</option>
                            <option value="trade">Trade Report</option>
                            <option value="account_open">Account Open Report</option>
                            <option value="both">Both (Trade & Account Open)</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                        <select id="campaignStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Account Open Link</label>
                        <input type="url" id="accountOpenLink" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="https://example.com/signup">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Trade Video Link</label>
                        <input type="url" id="tradeVideoLink" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="https://youtube.com/watch?v=...">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Referral Link</label>
                        <input type="url" id="referralLink" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="https://example.com/ref/...">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Campaign Image URL</label>
                        <input type="url" id="campaignImage" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="https://example.com/image.jpg">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Payout with Trade (‚Çπ) *</label>
                        <input type="number" id="payoutWithTrade" required min="0" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="100">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Payout without Trade (‚Çπ) *</label>
                        <input type="number" id="payoutWithoutTrade" required min="0" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="50">
                    </div>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Campaign Description</label>
                    <textarea id="campaignDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Describe the campaign requirements and benefits..."></textarea>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Admin Notes (Internal)</label>
                    <textarea id="adminNotes" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Internal notes for admin reference..."></textarea>
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button type="submit" class="flex-1 bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                        <i class="fas fa-plus mr-2"></i>Add Campaign
                    </button>
                    <button type="button" onclick="closeAddCampaignModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                        <i class="fas fa-times mr-2"></i>Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Campaign Details Modal -->
    <div id="campaignDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-gray-800">Campaign Details</h2>
                <button onclick="closeCampaignDetailsModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="campaignDetailsContent">
                <!-- Campaign details will be loaded here -->
            </div>
            
            <div class="mt-6 pt-4 border-t">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">Admin Notes</h3>
                <textarea id="campaignAdminNotes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Add admin notes about this campaign..."></textarea>
                <div class="flex gap-3 mt-4">
                    <button onclick="saveCampaignNotes()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-save mr-2"></i>Save Notes
                    </button>
                    <button onclick="editCampaign(currentCampaignId)" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-edit mr-2"></i>Edit Campaign
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Campaign Modal -->
    <div id="editCampaignModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-gray-800">Edit Campaign</h2>
                <button onclick="closeEditCampaignModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="editCampaignForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Campaign Name *</label>
                        <input type="text" id="editCampaignName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Campaign Type *</label>
                        <select id="editCampaignType" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="trade">Trade Report</option>
                            <option value="account_open">Account Opening</option>
                            <option value="both">Both Types</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Status *</label>
                        <select id="editCampaignStatus" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Reward Amount *</label>
                        <input type="number" id="editPayoutWithTrade" step="0.01" min="0" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Account Open Link</label>
                        <input type="url" id="editAccountOpenLink" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Trade Video Link</label>
                        <input type="url" id="editTradeVideoLink" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Referral Link</label>
                        <input type="url" id="editReferralLink" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Campaign Image URL</label>
                        <input type="url" id="editCampaignImage" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Campaign Description</label>
                    <textarea id="editCampaignDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Admin Notes</label>
                    <textarea id="editAdminNotes" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg">
                        <i class="fas fa-save mr-2"></i>Update Campaign
                    </button>
                    <button type="button" onclick="closeEditCampaignModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg">
                        <i class="fas fa-times mr-2"></i>Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit User Earnings Modal -->
    <div id="editEarningsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-lg">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800">Edit User Earnings</h2>
                <button onclick="closeEditEarningsModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="editEarningsForm">
                <input type="hidden" id="editUserId">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">User Name</label>
                    <input type="text" id="editUserName" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100">
                </div>
                
                <!-- Time-based Earnings -->
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Today's Earnings (‚Çπ)</label>
                        <input type="number" id="editTodayEarnings" required min="0" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">7 Days Earnings (‚Çπ)</label>
                        <input type="number" id="edit7DayEarnings" required min="0" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">30 Days Earnings (‚Çπ)</label>
                        <input type="number" id="edit30DayEarnings" required min="0" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">All Time Earnings (‚Çπ)</label>
                        <input type="number" id="editAllTimeEarnings" required min="0" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                    <select id="editUserStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                        <option value="suspended">Suspended</option>
                    </select>
                </div>
                <div class="flex gap-2">
                    <button type="submit" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-save mr-2"></i>Save Changes
                    </button>
                    <button type="button" onclick="closeEditEarningsModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Report Details Modal -->
    <div id="reportDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-2xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800">Report Details</h2>
                <button onclick="closeReportDetailsModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="reportDetailsContent">
                <!-- Report details will be loaded here -->
            </div>
            <div class="mt-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Admin Notes (Visible to User)</label>
                <textarea id="adminNotes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Add notes that will be visible to the user..."></textarea>
            </div>
            <div class="flex gap-2 mt-6">
                <button onclick="saveAdminNotes()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-save mr-2"></i>Save Notes
                </button>
                <button onclick="deleteCurrentReport()" class="flex-1 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-trash mr-2"></i>Delete Report
                </button>
                <button onclick="closeReportDetailsModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Admin Notes Modal -->
    <div id="adminNotesModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-lg">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800">Admin Notes</h2>
                <button onclick="closeAdminNotesModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="adminNotesForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Add Note for User:</label>
                    <textarea id="adminNotesTextarea" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter your message for the user..."></textarea>
                </div>
                
                <div class="flex gap-3">
                    <button type="submit" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                        üîµ Save Notes
                    </button>
                    <button type="button" onclick="closeAdminNotesModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Supabase connection utility with retry logic
        async function supabaseWithRetry(operation, maxRetries = 3, delay = 1000) {
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    console.log(`üîÑ Supabase operation attempt ${attempt}/${maxRetries}`);
                    const result = await operation();
                    console.log(`‚úÖ Supabase operation successful on attempt ${attempt}`);
                    return result;
                } catch (error) {
                    console.error(`‚ùå Supabase operation failed on attempt ${attempt}:`, error);
                    
                    // Check if it's a connection error
                    if (error.message && (
                        error.message.includes('Failed to fetch') ||
                        error.message.includes('ERR_CONNECTION_CLOSED') ||
                        error.message.includes('NetworkError') ||
                        error.message.includes('fetch')
                    )) {
                        if (attempt < maxRetries) {
                            console.log(`‚è≥ Retrying in ${delay}ms...`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            delay *= 2; // Exponential backoff
                            continue;
                        } else {
                            // Show user-friendly error message
                            showNotification('üîå Database connection issue. Please check your internet connection and try again.', 'error');
                            throw new Error('Database connection failed after multiple attempts');
                        }
                    } else {
                        // Non-connection error, don't retry
                        throw error;
                    }
                }
            }
        }
        
        // Connection test function
        async function testSupabaseConnection() {
            try {
                console.log('üîç Testing Supabase connection...');
                
                // Test 1: Auth connection
                const { data: authData, error: authError } = await window.App.supabase.auth.getSession();
                if (authError) {
                    console.error('‚ùå Auth connection failed:', authError);
                    return false;
                }
                console.log('‚úÖ Auth connection successful');
                
                // Test 2: Database connection
                const { data, error } = await window.App.supabase
                    .from('profiles')
                    .select('count', { count: 'exact', head: true });
                    
                if (error) {
                    console.error('‚ùå Database connection failed:', error);
                    return false;
                }
                console.log('‚úÖ Database connection successful');
                return true;
                
            } catch (error) {
                console.error('‚ùå Connection test failed:', error);
                
                // Show troubleshooting tips
                if (error.message && error.message.includes('ERR_CONNECTION_CLOSED')) {
                    showNotification(`
                        üîå Connection Error! Try these steps:
                        1. Check your internet connection
                        2. Refresh the page (Ctrl+F5)
                        3. Clear browser cache
                        4. Try a different browser
                        5. Check if Supabase is down: status.supabase.com
                    `, 'error');
                }
                return false;
            }
        }
        
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Hide loading overlay after 3 seconds even if there's an error
                setTimeout(() => {
                    document.getElementById('loadingOverlay').style.display = 'none';
                }, 3000);
                
                // Test Supabase connection first
                const connectionOk = await testSupabaseConnection();
                if (!connectionOk) {
                    console.error('‚ùå Supabase connection failed, continuing in offline mode');
                }
                
                // Check if user is logged in and is admin
                try {
                    const session = await window.App.getSession();
                    const user = session?.user;
                    
                    if (!user) {
                        console.log('No user session found, redirecting to login');
                        if (checkRedirectLoop()) {
                            window.location.replace('login.html?force=true');
                        }
                        return;
                    }
                    
                    // Check if user is admin using the App.isAdmin function
                    if (!window.App.isAdmin(user)) {
                        console.log('User is not admin, checking profile...');
                        
                        // Fallback: check profile role in database
                        const { data: profile, error: profileError } = await window.App.supabase
                            .from('profiles')
                            .select('*')
                            .eq('id', user.id)
                            .single();
                        
                        if (profileError || !profile || (profile.role !== 'admin' && !window.App.isAdmin(user))) {
                            showNotification('Access denied. Admin privileges required.', 'error');
                            console.log('Redirecting non-admin user to dashboard');
                            setTimeout(() => {
                                window.location.replace('dashboard.html');
                            }, 2000);
                            return;
                        }
                    }
                    
                    // Set admin name
                    const displayName = user.user_metadata?.fullname || user.email;
                    document.getElementById('adminName').textContent = displayName;
                    console.log('Admin authenticated successfully:', displayName);
                    
                } catch (authError) {
                    console.error('Authentication error:', authError);
                    showNotification('Authentication error occurred.', 'error');
                    
                    // On auth error, redirect to login
                    setTimeout(() => {
                        window.location.replace('login.html?force=true');
                    }, 2000);
                    return;
                }
                
                // Load dashboard data with error handling
                await loadDashboardData();
                
                // Setup event listeners
                setupEventListeners();
                
                // Hide loading overlay
                document.getElementById('loadingOverlay').style.display = 'none';
                
            } catch (error) {
                console.error('Error initializing admin dashboard:', error);
                showNotification('Error loading dashboard. Using demo mode.', 'error');
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        });
        
        async function loadDashboardData() {
            try {
                // Load user count and earnings (exclude deleted users)
                const { data: users, error: usersError } = await supabaseWithRetry(() => 
                    window.App.supabase
                        .from('profiles')
                        .select('id')
                        .neq('status', 'deleted')
                );
                
                if (!usersError) {
                    document.getElementById('userCount').textContent = users.length;
                }
                
                // Load total earnings from all users
                const { data: earnings, error: earningsError } = await supabaseWithRetry(() =>
                    window.App.supabase
                        .from('earnings')
                        .select('today_earnings, week_earnings, month_earnings')
                );
                
                if (!earningsError) {
                    const totalEarnings = earnings.reduce((sum, item) => sum + (item.month_earnings || 0), 0);
                    document.getElementById('totalEarnings').textContent = '‚Çπ' + totalEarnings.toFixed(2);
                }
                
                // Load report counts by type
                const { data: reports, error: reportsError } = await supabaseWithRetry(() =>
                    window.App.supabase
                        .from('reports')
                        .select('report_type, status')
                );
                
                if (!reportsError) {
                    const tradeReports = reports.filter(r => r.report_type === 'trade').length;
                    const accountReports = reports.filter(r => r.report_type === 'account_open').length;
                    const pendingReports = reports.filter(r => r.status === 'pending').length;
                    
                    document.getElementById('tradeReportCount').textContent = tradeReports;
                    document.getElementById('accountReportCount').textContent = accountReports;
                    document.getElementById('pendingReportCount').textContent = pendingReports;
                    
                    // Show notification badge if there are pending reports
                    const badge = document.getElementById('newReportBadge');
                    if (pendingReports > 0) {
                        badge.classList.remove('hidden');
                        badge.title = `${pendingReports} pending report${pendingReports > 1 ? 's' : ''} waiting for approval`;
                        console.log(`üîî ${pendingReports} pending reports found`);
                    } else {
                        badge.classList.add('hidden');
                    }
                }
                
                // Load campaign count
                const { data: campaigns, error: campaignsError } = await window.App.supabase
                    .from('campaigns')
                    .select('id')
                    .eq('is_active', true);
                
                if (!campaignsError) {
                    document.getElementById('campaignCount').textContent = campaigns.length;
                }
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showNotification('Error loading dashboard data', 'error');
            }
        }
        
        // New Admin Panel Functions
        
        // Global variables
        let currentReportType = 'all';
        let currentReportId = null;
        let allReports = [];
        let allUsers = [];
        let allCampaigns = [];
        
        // Navigation Functions
        function openUserManagement() {
            closeAllSections();
            document.getElementById('userManagementSection').classList.remove('hidden');
            loadUsersTable();
            
            // Auto-refresh every 30 seconds when user management is open
            if (window.userManagementInterval) {
                clearInterval(window.userManagementInterval);
            }
            window.userManagementInterval = setInterval(() => {
                if (!document.getElementById('userManagementSection').classList.contains('hidden')) {
                    loadUsersTable();
                    console.log('Auto-refreshed user table');
                }
            }, 30000); // Refresh every 30 seconds
        }
        
        function openReportManagement() {
            closeAllSections();
            document.getElementById('reportManagementSection').classList.remove('hidden');
            
            // Reset to 'All Reports' tab
            currentReportType = 'all';
            switchReportTab('all');
            
            // Load reports
            loadReportsTable();
            
            // Start auto-refresh for new reports (every 30 seconds)
            if (window.reportRefreshInterval) {
                clearInterval(window.reportRefreshInterval);
            }
            window.reportRefreshInterval = setInterval(() => {
                console.log('Auto-refreshing reports...');
                loadReportsTable();
                loadDashboardData(); // Update counts
            }, 30000); // 30 seconds
        }
        
        function openCampaignManagement() {
            closeAllSections();
            document.getElementById('campaignManagementSection').classList.remove('hidden');
            loadCampaignsTable();
        }
        
        function closeAllSections() {
            document.getElementById('userManagementSection').classList.add('hidden');
            document.getElementById('reportManagementSection').classList.add('hidden');
            document.getElementById('campaignManagementSection').classList.add('hidden');
            
            // Stop auto-refresh when closing sections
            if (window.reportRefreshInterval) {
                clearInterval(window.reportRefreshInterval);
                window.reportRefreshInterval = null;
                console.log('Auto-refresh stopped');
            }
            
            // Clear auto-refresh interval when closing sections
            if (window.userManagementInterval) {
                clearInterval(window.userManagementInterval);
                window.userManagementInterval = null;
            }
        }
        
        // User Management Functions
        async function loadUsersTable() {
            try {
                console.log('Loading users table...');
                
                // Test Supabase connection first
                console.log('Testing Supabase connection...');
                console.log('Supabase URL:', window.APP_CONFIG?.SUPABASE_URL);
                console.log('Supabase Key exists:', !!window.APP_CONFIG?.SUPABASE_ANON_KEY);
                
                // Check if Supabase is properly initialized
                if (!window.App?.supabase) {
                    throw new Error('Supabase client not initialized. Check app.js loading.');
                }
                
                // Try the most basic connection test first
                try {
                    console.log('Attempting basic connection test...');
                    
                    // Try to get Supabase auth status first (this doesn't require tables)
                    const { data: authData, error: authError } = await window.App.supabase.auth.getSession();
                    console.log('Auth test result:', { authData: !!authData, authError });
                    
                    if (authError && authError.message.includes('Failed to fetch')) {
                        throw new Error('Network connection failed. Check your internet connection and Supabase URL.');
                    }
                    
                } catch (basicError) {
                    console.error('Basic connection test failed:', basicError);
                    throw new Error(`Network/CORS error: ${basicError.message}. Check Supabase configuration and network.`);
                }
                
                // Now try table access
                try {
                    const { data: testData, error: testError } = await window.App.supabase
                        .from('profiles')
                        .select('count', { count: 'exact', head: true });
                    
                    if (testError) {
                        console.error('Table access test failed:', testError);
                        
                        // Check if it's a table not found error
                        if (testError.message.includes('relation "profiles" does not exist') || 
                            testError.message.includes('table "profiles" does not exist')) {
                            throw new Error('Database table "profiles" does not exist. Please create the required database tables first.');
                        }
                        
                        throw new Error(`Database access failed: ${testError.message}`);
                    }
                    
                    console.log('Supabase connection and table access successful');
                    
                } catch (tableError) {
                    console.error('Table access failed:', tableError);
                    throw tableError;
                }
                
                // DIRECT BACKEND FETCH - Get ALL users from auth.users table
                console.log('üîç Fetching ALL users directly from backend...');
                
                let users = [];
                let usersError = null;
                
                try {
                    // DIRECT QUERY to public.profiles - Force fetch ALL users
                    console.log('üîç Querying public.profiles directly...');
                    
                    // Try multiple query approaches
                    let profileUsers = null;
                    let profileError = null;
                    
                    // Method 1A: Simple select all (bypass RLS for admin)
                    try {
                        // Check if current user is admin
                        const session = await window.App.getSession();
                        const isAdmin = session?.user && window.App.isAdmin(session.user);
                        console.log('üîê Current user admin status:', isAdmin);
                        
                        if (isAdmin) {
                            // Admin should see all users except deleted ones
                            const result1 = await window.App.supabase
                                .from('profiles')
                                .select('*')
                                .neq('status', 'deleted');
                            
                            profileUsers = result1.data;
                            profileError = result1.error;
                            console.log('üìä Method 1A - Admin select all result:', { 
                                data: profileUsers, 
                                error: profileError,
                                count: profileUsers?.length || 0 
                            });
                        } else {
                            console.log('‚ö†Ô∏è Not admin, skipping admin-only query');
                        }
                    } catch (e1) {
                        console.log('Method 1A failed:', e1);
                    }
                    
                    // Method 1B: If first method failed, try with specific columns
                    if (!profileUsers || profileError) {
                        try {
                            const result2 = await window.App.supabase
                                .from('profiles')
                                .select('id, email, full_name, status, last_sign_in_at, created_at, updated_at')
                                .neq('status', 'deleted');
                            
                            profileUsers = result2.data;
                            profileError = result2.error;
                            console.log('üìä Method 1B - Specific columns result:', { data: profileUsers, error: profileError });
                        } catch (e2) {
                            console.log('Method 1B failed:', e2);
                        }
                    }
                    
                    // Method 1C: Try with no ordering
                    if (!profileUsers || profileError) {
                        try {
                            const result3 = await window.App.supabase
                                .from('profiles')
                                .select('id, email, full_name, status, last_sign_in_at, created_at, updated_at')
                                .neq('status', 'deleted')
                                .limit(100);
                            
                            profileUsers = result3.data;
                            profileError = result3.error;
                            console.log('üìä Method 1C - No ordering result:', { data: profileUsers, error: profileError });
                        } catch (e3) {
                            console.log('Method 1C failed:', e3);
                        }
                    }
                    
                    console.log('üìä Final profiles query result:', profileUsers);
                    console.log('üìà Profiles found:', profileUsers?.length || 0);
                    
                    if (profileUsers && profileUsers.length > 0) {
                        users = profileUsers;
                        console.log('‚úÖ Using profiles table data - Found', profileUsers.length, 'users');
                        
                        // Log each user for debugging
                        profileUsers.forEach((user, index) => {
                            console.log(`User ${index + 1}:`, {
                                email: user.email,
                                name: user.full_name,
                                id: user.id?.substring(0, 8) + '...'
                            });
                        });
                    } else {
                        console.log('‚ö†Ô∏è No data in profiles table, trying direct auth fetch...');
                        
                        // Method 2: Direct SQL query to get auth users
                        const { data: authUsers, error: authError } = await window.App.supabase
                            .rpc('get_all_auth_users');
                        
                        if (authError) {
                            console.log('Auth RPC failed, trying alternative method...');
                            
                            // Method 3: Use raw SQL query
                            const { data: sqlUsers, error: sqlError } = await window.App.supabase
                                .from('auth.users')
                                .select('id, email, user_metadata, created_at, last_sign_in_at');
                            
                            if (sqlError) {
                                console.log('Direct auth query failed, creating from current session...');
                                
                                // Method 4: Get current session and create profile
                                const session = await window.App.getSession();
                                if (session?.user) {
                                    const currentUser = session.user;
                                    
                                    // Create profile for current user if not exists
                                    const profileData = {
                                        id: currentUser.id,
                                        email: currentUser.email,
                                        full_name: currentUser.user_metadata?.full_name || currentUser.user_metadata?.fullname || currentUser.email?.split('@')[0],
                                        status: 'active',
                                        last_sign_in_at: new Date().toISOString(),
                                        created_at: currentUser.created_at || new Date().toISOString(),
                                        updated_at: new Date().toISOString()
                                    };
                                    
                                    const { error: createError } = await window.App.supabase
                                        .from('profiles')
                                        .upsert(profileData, { onConflict: 'id' });
                                    
                                    if (!createError) {
                                        users = [profileData];
                                        console.log('‚úÖ Created profile for current user:', currentUser.email);
                                    }
                                }
                            } else {
                                // Convert auth users to profile format
                                users = sqlUsers.map(authUser => ({
                                    id: authUser.id,
                                    email: authUser.email,
                                    full_name: authUser.user_metadata?.full_name || authUser.user_metadata?.fullname || authUser.email?.split('@')[0],
                                    status: 'active',
                                    last_sign_in_at: authUser.last_sign_in_at,
                                    created_at: authUser.created_at,
                                    updated_at: new Date().toISOString()
                                }));
                                console.log('‚úÖ Using direct auth data');
                            }
                        } else {
                            users = authUsers;
                            console.log('‚úÖ Using RPC auth data');
                        }
                    }
                    
                } catch (fetchError) {
                    console.error('‚ùå All fetch methods failed:', fetchError);
                    usersError = fetchError;
                }
                
                console.log('üìä Final users data:', users);
                console.log('üìà Total users found:', users?.length || 0);
                
                if (users && users.length > 0) {
                    console.log('üë• User details:');
                    users.forEach((user, index) => {
                        const isAdmin = window.APP_CONFIG?.ADMIN_EMAILS?.includes(user.email?.toUpperCase());
                        console.log(`${index + 1}. ${user.email} (${isAdmin ? 'ADMIN' : 'USER'}) - ${user.full_name || 'No name'}`);
                    });
                } else {
                    console.log('‚ùå No users found in any source');
                }
                
                if (usersError) {
                    console.error('Error fetching users:', usersError);
                    throw new Error(`Failed to fetch users: ${usersError.message}`);
                }
                
                console.log('Users fetched:', users);
                
                const tableBody = document.getElementById('usersTable');
                tableBody.innerHTML = '';
                
                if (!users || users.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="9" class="py-8 text-center text-gray-500">
                                <i class="fas fa-users text-3xl mb-2"></i>
                                <div class="font-semibold">No users found</div>
                                <div class="text-sm mt-1">Users will appear here after they sign up</div>
                                <div class="text-xs mt-2 text-blue-600">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Both admin users and security code users will be displayed here
                                </div>
                            </td>
                        </tr>
                    `;
                    showNotification('No users found. Users will appear here after they sign up.', 'info');
                    return;
                }
                
                console.log(`Found ${users.length} users. Processing each user...`);
                
                // For each user, get their earnings separately
                for (const user of users) {
                    try {
                        // Get earnings for this user including all-time earnings
                        const { data: earnings, error: earningsError } = await window.App.supabase
                            .from('earnings')
                            .select('today_earnings, week_earnings, month_earnings, all_time_earnings')
                            .eq('user_id', user.id)
                            .order('updated_at', { ascending: false })
                            .limit(1);
                        
                        const latestEarnings = earnings && earnings.length > 0 ? earnings[0] : null;
                        const todayEarnings = latestEarnings?.today_earnings || 0;
                        const weekEarnings = latestEarnings?.week_earnings || 0;
                        const monthEarnings = latestEarnings?.month_earnings || 0;
                        const allTimeEarnings = latestEarnings?.all_time_earnings || 0;
                        const status = user.status || 'active';
                        const lastLogin = user.last_sign_in_at ? new Date(user.last_sign_in_at).toLocaleDateString() : 'Never';
                        
                        const row = document.createElement('tr');
                        
                        // Determine user type
                        const isAdmin = window.APP_CONFIG?.ADMIN_EMAILS?.includes(user.email?.toUpperCase());
                        const userType = isAdmin ? 'Admin' : 'User';
                        const userTypeClass = isAdmin ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800';
                        
                        // Create cells safely
                        const userNameCell = document.createElement('td');
                        userNameCell.className = 'py-2 px-4 border-b border-gray-200';
                        userNameCell.innerHTML = `
                            <div class="font-medium text-gray-900">${user.full_name || user.email?.split('@')[0] || 'Unknown'}</div>
                            <div class="text-xs mt-1">
                                <span class="px-2 py-1 rounded-full ${userTypeClass}">${userType}</span>
                            </div>
                        `;
                        
                        const emailCell = document.createElement('td');
                        emailCell.className = 'py-2 px-4 border-b border-gray-200 text-gray-600';
                        emailCell.textContent = user.email || 'No email';
                        
                        const todayCell = document.createElement('td');
                        todayCell.className = 'py-2 px-4 border-b border-gray-200 font-medium text-green-600';
                        todayCell.textContent = `‚Çπ${todayEarnings.toFixed(2)}`;
                        
                        const weekCell = document.createElement('td');
                        weekCell.className = 'py-2 px-4 border-b border-gray-200 font-medium text-blue-600';
                        weekCell.textContent = `‚Çπ${weekEarnings.toFixed(2)}`;
                        
                        const monthCell = document.createElement('td');
                        monthCell.className = 'py-2 px-4 border-b border-gray-200 font-medium text-purple-600';
                        monthCell.textContent = `‚Çπ${monthEarnings.toFixed(2)}`;
                        
                        const allTimeCell = document.createElement('td');
                        allTimeCell.className = 'py-2 px-4 border-b border-gray-200 font-medium text-orange-600';
                        allTimeCell.textContent = `‚Çπ${allTimeEarnings.toFixed(2)}`;
                        
                        const loginCell = document.createElement('td');
                        loginCell.className = 'py-2 px-4 border-b border-gray-200 text-sm text-gray-500';
                        loginCell.textContent = lastLogin;
                        
                        const statusCell = document.createElement('td');
                        statusCell.className = 'py-2 px-4 border-b border-gray-200';
                        const statusSpan = document.createElement('span');
                        statusSpan.className = `px-2 py-1 text-xs rounded-full ${status === 'active' ? 'bg-green-100 text-green-800' : status === 'inactive' ? 'bg-gray-100 text-gray-800' : 'bg-red-100 text-red-800'}`;
                        statusSpan.textContent = status;
                        statusCell.appendChild(statusSpan);
                        
                        const actionsCell = document.createElement('td');
                        actionsCell.className = 'py-2 px-4 border-b border-gray-200';
                        
                        const editBtn = document.createElement('button');
                        editBtn.className = 'bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs mr-1';
                        editBtn.innerHTML = '<i class="fas fa-edit"></i> Edit';
                        editBtn.onclick = () => editUserEarnings(user.id, user.full_name || user.email || 'Unknown', todayEarnings, weekEarnings, monthEarnings, allTimeEarnings, status);
                        
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs';
                        deleteBtn.innerHTML = '<i class="fas fa-trash"></i> Delete';
                        deleteBtn.onclick = () => confirmDeleteUser(user.id, user.email, userType);
                        
                        actionsCell.appendChild(editBtn);
                        actionsCell.appendChild(deleteBtn);
                        
                        row.appendChild(userNameCell);
                        row.appendChild(emailCell);
                        row.appendChild(todayCell);
                        row.appendChild(weekCell);
                        row.appendChild(monthCell);
                        row.appendChild(allTimeCell);
                        row.appendChild(loginCell);
                        row.appendChild(statusCell);
                        row.appendChild(actionsCell);
                        
                        tableBody.appendChild(row);
                    } catch (earningsError) {
                        console.error('Error loading earnings for user:', user.id, earningsError);
                        // Still show the user even if earnings fail - using same safe approach
                        const row = document.createElement('tr');
                        
                        const userNameCell = document.createElement('td');
                        userNameCell.className = 'py-2 px-4 border-b border-gray-200';
                        userNameCell.innerHTML = `<div class="font-medium text-gray-900">${user.full_name || user.email || 'Unknown'}</div>`;
                        
                        const emailCell = document.createElement('td');
                        emailCell.className = 'py-2 px-4 border-b border-gray-200 text-gray-600';
                        emailCell.textContent = user.email || 'No email';
                        
                        const todayCell = document.createElement('td');
                        todayCell.className = 'py-2 px-4 border-b border-gray-200 font-medium text-green-600';
                        todayCell.textContent = '‚Çπ0.00';
                        
                        const weekCell = document.createElement('td');
                        weekCell.className = 'py-2 px-4 border-b border-gray-200 font-medium text-blue-600';
                        weekCell.textContent = '‚Çπ0.00';
                        
                        const monthCell = document.createElement('td');
                        monthCell.className = 'py-2 px-4 border-b border-gray-200 font-medium text-purple-600';
                        monthCell.textContent = '‚Çπ0.00';
                        
                        const allTimeCell = document.createElement('td');
                        allTimeCell.className = 'py-2 px-4 border-b border-gray-200 font-medium text-orange-600';
                        allTimeCell.textContent = '‚Çπ0.00';
                        
                        const loginCell = document.createElement('td');
                        loginCell.className = 'py-2 px-4 border-b border-gray-200 text-sm text-gray-500';
                        loginCell.textContent = user.last_sign_in_at ? new Date(user.last_sign_in_at).toLocaleDateString() : 'Never';
                        
                        const statusCell = document.createElement('td');
                        statusCell.className = 'py-2 px-4 border-b border-gray-200';
                        const statusSpan = document.createElement('span');
                        statusSpan.className = 'px-2 py-1 text-xs rounded-full bg-green-100 text-green-800';
                        statusSpan.textContent = 'active';
                        statusCell.appendChild(statusSpan);
                        
                        const actionsCell = document.createElement('td');
                        actionsCell.className = 'py-2 px-4 border-b border-gray-200';
                        
                        const editBtn = document.createElement('button');
                        editBtn.className = 'bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs mr-1';
                        editBtn.innerHTML = '<i class="fas fa-edit"></i> Edit';
                        editBtn.onclick = () => editUserEarnings(user.id, user.full_name || user.email || 'Unknown', 0, 0, 0, 0, 'active');
                        
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs';
                        deleteBtn.innerHTML = '<i class="fas fa-trash"></i> Delete';
                        deleteBtn.onclick = () => deleteUser(user.id);
                        
                        actionsCell.appendChild(editBtn);
                        actionsCell.appendChild(deleteBtn);
                        
                        row.appendChild(userNameCell);
                        row.appendChild(emailCell);
                        row.appendChild(todayCell);
                        row.appendChild(weekCell);
                        row.appendChild(monthCell);
                        row.appendChild(allTimeCell);
                        row.appendChild(loginCell);
                        row.appendChild(statusCell);
                        row.appendChild(actionsCell);
                        
                        tableBody.appendChild(row);
                    }
                }
                
                console.log('Users table loaded successfully');
                showNotification('Users loaded successfully', 'success');
                
            } catch (error) {
                console.error('Error loading users:', error);
                showNotification(`Error loading users: ${error.message}`, 'error');
                
                // Show error in table with helpful message
                const tableBody = document.getElementById('usersTable');
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9" class="py-8 text-center">
                            <div class="text-red-500 mb-2">
                                <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                                <div class="font-semibold">Database Connection Error</div>
                            </div>
                            <div class="text-gray-600 text-sm mb-4">
                                ${error.message}
                            </div>
                            <div class="text-gray-500 text-xs">
                                <strong>Debugging Info:</strong><br>
                                ‚Ä¢ Supabase URL: ${window.APP_CONFIG?.SUPABASE_URL || 'Not configured'}<br>
                                ‚Ä¢ API Key: ${window.APP_CONFIG?.SUPABASE_ANON_KEY ? 'Configured' : 'Missing'}<br>
                                ‚Ä¢ App.js loaded: ${window.App ? 'Yes' : 'No'}<br>
                                ‚Ä¢ Supabase client: ${window.App?.supabase ? 'Initialized' : 'Not initialized'}<br><br>
                                <strong>Possible solutions:</strong><br>
                                1. Check network connection (WiFi/Internet)<br>
                                2. Verify Supabase URL and API key in config.js<br>
                                3. Check if Supabase project is active<br>
                                4. Try opening Supabase dashboard in browser<br>
                                5. Refresh page and check browser console
                            </div>
                            <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded text-xs text-left">
                                <strong>Quick Database Setup:</strong><br>
                                If tables don't exist, run these SQL commands in Supabase SQL Editor:<br><br>
                                <code class="bg-gray-100 p-1 block mt-1">
                                -- Create profiles table<br>
                                CREATE TABLE profiles (<br>
                                &nbsp;&nbsp;id UUID PRIMARY KEY DEFAULT gen_random_uuid(),<br>
                                &nbsp;&nbsp;email TEXT UNIQUE,<br>
                                &nbsp;&nbsp;full_name TEXT,<br>
                                &nbsp;&nbsp;status TEXT DEFAULT 'active',<br>
                                &nbsp;&nbsp;last_sign_in_at TIMESTAMP,<br>
                                &nbsp;&nbsp;created_at TIMESTAMP DEFAULT NOW(),<br>
                                &nbsp;&nbsp;updated_at TIMESTAMP DEFAULT NOW()<br>
                                );<br><br>
                                -- Create earnings table<br>
                                CREATE TABLE earnings (<br>
                                &nbsp;&nbsp;id UUID PRIMARY KEY DEFAULT gen_random_uuid(),<br>
                                &nbsp;&nbsp;user_id UUID REFERENCES profiles(id),<br>
                                &nbsp;&nbsp;today_earnings DECIMAL DEFAULT 0,<br>
                                &nbsp;&nbsp;week_earnings DECIMAL DEFAULT 0,<br>
                                &nbsp;&nbsp;month_earnings DECIMAL DEFAULT 0,<br>
                                &nbsp;&nbsp;updated_at TIMESTAMP DEFAULT NOW()<br>
                                );
                                </code>
                            </div>
                            <div class="mt-4 flex gap-2 justify-center flex-wrap">
                                <button onclick="testConnection()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-2 rounded text-sm">
                                    <i class="fas fa-wifi mr-1"></i>Test Connection
                                </button>
                                <button onclick="loadUsersTable()" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded text-sm">
                                    <i class="fas fa-sync-alt mr-1"></i>Retry
                                </button>
                                <button onclick="createDatabaseTables()" class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded text-sm">
                                    <i class="fas fa-database mr-1"></i>Fix Tables
                                </button>
                                <button onclick="createOrUpdateUserProfile()" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-2 rounded text-sm">
                                    <i class="fas fa-user-sync mr-1"></i>Sync Users
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }
        
        // Connection Test Function
        async function testConnection() {
            try {
                showNotification('Testing connection...', 'info');
                
                console.log('=== CONNECTION TEST START ===');
                console.log('1. Config check:', {
                    url: window.APP_CONFIG?.SUPABASE_URL,
                    keyExists: !!window.APP_CONFIG?.SUPABASE_ANON_KEY,
                    appLoaded: !!window.App,
                    supabaseLoaded: !!window.App?.supabase
                });
                
                if (!window.APP_CONFIG?.SUPABASE_URL) {
                    throw new Error('Supabase URL not configured in config.js');
                }
                
                if (!window.APP_CONFIG?.SUPABASE_ANON_KEY) {
                    throw new Error('Supabase API key not configured in config.js');
                }
                
                if (!window.App?.supabase) {
                    throw new Error('Supabase client not initialized. Check if app.js loaded properly.');
                }
                
                console.log('2. Testing basic auth endpoint...');
                const { data: authData, error: authError } = await window.App.supabase.auth.getSession();
                
                if (authError) {
                    console.error('Auth test failed:', authError);
                    throw new Error(`Auth endpoint failed: ${authError.message}`);
                }
                
                console.log('3. Auth endpoint working ‚úì');
                
                // Test if we can reach the database
                console.log('4. Testing database connection...');
                try {
                    const { data, error } = await window.App.supabase
                        .from('profiles')
                        .select('count', { count: 'exact', head: true });
                    
                    if (error) {
                        console.log('Database test result:', error);
                        if (error.message.includes('relation') && error.message.includes('does not exist')) {
                            showNotification('Connection OK! But tables need to be created.', 'warning');
                            return;
                        }
                        throw error;
                    }
                    
                    console.log('5. Database connection working ‚úì');
                    showNotification('Connection test successful! All systems working.', 'success');
                    
                } catch (dbError) {
                    console.log('Database test failed:', dbError);
                    showNotification(`Connection OK, but database issue: ${dbError.message}`, 'warning');
                }
                
                console.log('=== CONNECTION TEST END ===');
                
            } catch (error) {
                console.error('Connection test failed:', error);
                showNotification(`Connection test failed: ${error.message}`, 'error');
            }
        }
        
        // Database Setup Function
        async function createDatabaseTables() {
            try {
                showNotification('Checking and updating database structure...', 'info');
                
                // Since tables exist, let's add missing columns instead
                try {
                    // Add missing columns to profiles table if they don't exist
                    const addColumnsSQL = `
                        DO $$ 
                        BEGIN
                            -- Add status column if not exists
                            IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name='profiles' AND column_name='status') THEN
                                ALTER TABLE profiles ADD COLUMN status TEXT DEFAULT 'active';
                            END IF;
                            
                            -- Add last_sign_in_at column if not exists
                            IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name='profiles' AND column_name='last_sign_in_at') THEN
                                ALTER TABLE profiles ADD COLUMN last_sign_in_at TIMESTAMP;
                            END IF;
                            
                            -- Add full_name column if not exists
                            IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name='profiles' AND column_name='full_name') THEN
                                ALTER TABLE profiles ADD COLUMN full_name TEXT;
                            END IF;
                        END $$;
                    `;
                    
                    const { error: alterError } = await window.App.supabase.rpc('exec_sql', { sql: addColumnsSQL });
                    
                    if (alterError) {
                        console.log('Could not alter table structure:', alterError);
                    }
                    
                } catch (alterError) {
                    console.log('Table alteration not supported, tables may already be correct');
                }
                
                showNotification('Database structure verified! Tables already exist.', 'success');
                
                // Try loading users again
                setTimeout(() => {
                    loadUsersTable();
                }, 1000);
                
            } catch (error) {
                console.error('Error checking database structure:', error);
                showNotification(`Database exists but structure may be different. Try manual setup.`, 'warning');
                
                // Still try to load users
                setTimeout(() => {
                    loadUsersTable();
                }, 2000);
            }
        }
        
        // User Management Functions - Updated to include all-time earnings
        function editUserEarnings(userId, userName, todayEarnings, weekEarnings, monthEarnings, allTimeEarnings, status) {
            document.getElementById('editUserId').value = userId;
            document.getElementById('editUserName').value = userName;
            document.getElementById('editTodayEarnings').value = todayEarnings || 0;
            document.getElementById('edit7DayEarnings').value = weekEarnings || 0;
            document.getElementById('edit30DayEarnings').value = monthEarnings || 0;
            document.getElementById('editAllTimeEarnings').value = allTimeEarnings || 0;
            document.getElementById('editUserStatus').value = status || 'active';
            document.getElementById('editEarningsModal').classList.remove('hidden');
        }
        
        function closeEditEarningsModal() {
            document.getElementById('editEarningsModal').classList.add('hidden');
        }
        
        // REAL-TIME EARNINGS UPDATE with Counter Animation - Updated for All Time Earnings
        async function saveUserEarnings() {
            try {
                const userId = document.getElementById('editUserId').value;
                const userName = document.getElementById('editUserName').value;
                const todayEarnings = parseFloat(document.getElementById('editTodayEarnings').value) || 0;
                const weekEarnings = parseFloat(document.getElementById('edit7DayEarnings').value) || 0;
                const monthEarnings = parseFloat(document.getElementById('edit30DayEarnings').value) || 0;
                const allTimeEarnings = parseFloat(document.getElementById('editAllTimeEarnings').value) || 0;
                const status = document.getElementById('editUserStatus').value;
                
                if (!userId) {
                    throw new Error('User ID is required');
                }
                
                showNotification('üí∞ Updating earnings...', 'info');
                console.log(`üí∞ Updating earnings for: ${userName} (${userId})`);
                console.log(`üìà New values: Today: ‚Çπ${todayEarnings}, Week: ‚Çπ${weekEarnings}, Month: ‚Çπ${monthEarnings}, All Time: ‚Çπ${allTimeEarnings}`);
                
                // Step 1: Update earnings in database with all-time earnings
                const { error: earningsError } = await window.App.supabase
                    .from('earnings')
                    .upsert({
                        user_id: userId,
                        today_earnings: todayEarnings,
                        week_earnings: weekEarnings,
                        month_earnings: monthEarnings,
                        all_time_earnings: allTimeEarnings,
                        updated_at: new Date().toISOString()
                    }, { 
                        onConflict: 'user_id',
                        ignoreDuplicates: false 
                    });
                
                if (earningsError) {
                    throw new Error(`Failed to update earnings: ${earningsError.message}`);
                }
                
                console.log('‚úÖ Earnings updated in database');
                
                // Step 2: Update user status if changed
                const { error: statusError } = await window.App.supabase
                    .from('profiles')
                    .update({ 
                        status: status,
                        updated_at: new Date().toISOString() 
                    })
                    .eq('id', userId);
                
                if (statusError) {
                    console.log('‚ö†Ô∏è Status update failed:', statusError);
                } else {
                    console.log('‚úÖ User status updated');
                }
                
                // Step 3: Trigger real-time update for user dashboard
                // This will make the counter animation trigger on user's dashboard
                try {
                    // Send a real-time notification to the user (if they're online)
                    const { error: notifyError } = await window.App.supabase
                        .from('earnings')
                        .update({ 
                            updated_at: new Date().toISOString() 
                        })
                        .eq('user_id', userId);
                    
                    console.log('üì° Real-time update triggered for user dashboard');
                } catch (notifyError) {
                    console.log('‚ö†Ô∏è Real-time notification failed:', notifyError);
                }
                
                showNotification(`üéâ Earnings updated successfully for ${userName}!\nüí∞ Today: ‚Çπ${todayEarnings}\nüìÖ Week: ‚Çπ${weekEarnings}\nüìà Month: ‚Çπ${monthEarnings}\nüèÜ All Time: ‚Çπ${allTimeEarnings}`, 'success');
                
                // Step 4: Close modal and refresh table
                closeEditEarningsModal();
                
                // Refresh admin table to show new values
                setTimeout(() => {
                    loadUsersTable();
                }, 1000);
                
                // Step 5: Log for user dashboard counter animation
                console.log(`üéØ User ${userName} should see counter animation on their dashboard with new values:`);
                console.log(`   Today: ‚Çπ${todayEarnings}`);
                console.log(`   Week: ‚Çπ${weekEarnings}`);
                console.log(`   Month: ‚Çπ${monthEarnings}`);
                console.log(`   All Time: ‚Çπ${allTimeEarnings}`);
                
            } catch (error) {
                console.error('‚ùå Error updating earnings:', error);
                showNotification(`Failed to update earnings: ${error.message}`, 'error');
            }
        }
        
        // COMPLETE DELETE FUNCTION - Removes user from everywhere
        async function confirmDeleteUser(userId, userEmail, userType) {
            const isAdmin = userType === 'Admin';
            const warningMessage = isAdmin 
                ? `‚ö†Ô∏è WARNING: You are about to delete an ADMIN user!\n\nUser: ${userEmail}\nType: ${userType}\n\nThis will permanently remove:\n‚Ä¢ User profile\n‚Ä¢ All earnings data\n‚Ä¢ All reports\n‚Ä¢ All campaigns\n‚Ä¢ Auth account\n‚Ä¢ Admin access\n\nThis action CANNOT be undone!\n\nType "DELETE" to confirm:`
                : `Are you sure you want to delete this user?\n\nUser: ${userEmail}\nType: ${userType}\n\nThis will permanently remove:\n‚Ä¢ User profile\n‚Ä¢ All earnings data\n‚Ä¢ All reports\n‚Ä¢ All campaigns\n‚Ä¢ Auth account\n‚Ä¢ Dashboard access\n\nThis action cannot be undone!\n\nType "DELETE" to confirm:`;
            
            const confirmation = prompt(warningMessage);
            
            if (confirmation !== 'DELETE') {
                showNotification('User deletion cancelled.', 'info');
                return;
            }
            
            try {
                showNotification('üóëÔ∏è Deleting user from all systems...', 'info');
                console.log(`üóëÔ∏è Starting complete deletion for user: ${userEmail} (${userId})`);
                
                // Step 1: Delete user's earnings
                console.log('1Ô∏è‚É£ Deleting earnings data...');
                const { error: earningsError } = await window.App.supabase
                    .from('earnings')
                    .delete()
                    .eq('user_id', userId);
                
                if (earningsError) {
                    console.log('‚ö†Ô∏è Earnings deletion:', earningsError);
                } else {
                    console.log('‚úÖ Earnings deleted');
                }
                
                // Step 2: Delete user's reports
                console.log('2Ô∏è‚É£ Deleting reports data...');
                const { error: reportsError } = await window.App.supabase
                    .from('reports')
                    .delete()
                    .eq('user_id', userId);
                
                if (reportsError) {
                    console.log('‚ö†Ô∏è Reports deletion:', reportsError);
                } else {
                    console.log('‚úÖ Reports deleted');
                }
                
                // Step 3: Delete user's campaigns (if any)
                console.log('3Ô∏è‚É£ Deleting campaigns data...');
                try {
                    // Try multiple deletion methods for campaigns
                    let campaignsError;
                    
                    // Method 1: Try with created_by field
                    let result = await window.App.supabase
                        .from('campaigns')
                        .delete()
                        .eq('created_by', userId);
                    
                    campaignsError = result.error;
                    
                    // Method 2: If created_by doesn't exist, try with user_id field
                    if (campaignsError && (campaignsError.message.includes('created_by') || campaignsError.message.includes('column'))) {
                        console.log('‚ö†Ô∏è created_by column not found, trying user_id field...');
                        result = await window.App.supabase
                            .from('campaigns')
                            .delete()
                            .eq('user_id', userId);
                        
                        campaignsError = result.error;
                    }
                    
                    // Method 3: If still failing, skip campaign deletion
                    if (campaignsError) {
                        console.log('‚ö†Ô∏è Cannot delete campaigns for user:', campaignsError.message);
                        console.log('‚ÑπÔ∏è Skipping campaign deletion - table structure mismatch');
                    } else {
                        console.log('‚úÖ Campaigns deleted successfully');
                    }
                } catch (campaignError) {
                    console.log('‚ö†Ô∏è Campaign deletion error:', campaignError.message);
                    console.log('‚ÑπÔ∏è Continuing with user deletion despite campaign deletion failure');
                }
                
                // Step 4: Mark user as 'deleted' instead of actually deleting
                console.log('4Ô∏è‚É£ Marking user as deleted...');
                const { error: profileError } = await window.App.supabase
                    .from('profiles')
                    .update({ 
                        status: 'deleted',
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', userId);
                
                if (profileError) {
                    console.log('‚ö†Ô∏è Profile update error:', profileError.message);
                    // Continue even if profile update fails
                }
                console.log('‚úÖ User marked as deleted');
                
                // Note: We don't delete from auth so user can login again
                console.log('‚ÑπÔ∏è User can still login and will reappear in admin panel');
                
                showNotification(`üéâ User "${userEmail}" hidden from admin panel! Data deleted. User can login again to reappear.`, 'success');
                console.log(`‚úÖ Complete deletion finished for: ${userEmail}`);
                
                // Refresh everything
                setTimeout(() => {
                    loadUsersTable();
                    if (typeof loadDashboardData === 'function') {
                        loadDashboardData();
                    }
                }, 1500);
                
            } catch (error) {
                console.error('‚ùå Error in complete user deletion:', error);
                showNotification(`Failed to delete user: ${error.message}`, 'error');
            }
        }
        
        // Legacy function for backward compatibility
        async function deleteUser(userId) {
            return confirmDeleteUser(userId, 'Unknown User', 'User');
        }
        
        // Enhanced user profile sync with multiple methods
        async function createOrUpdateUserProfile() {
            try {
                showNotification('Fetching all users from backend...', 'info');
                
                console.log('üîÑ Starting comprehensive user sync...');
                
                // Method 1: Try admin.listUsers (requires service role key)
                try {
                    const { data: authUsers, error: authError } = await window.App.supabase.auth.admin.listUsers();
                    
                    if (!authError && authUsers?.users) {
                        console.log('‚úÖ Found auth users via admin API:', authUsers.users.length);
                        
                        for (const authUser of authUsers.users) {
                            const profileData = {
                                id: authUser.id,
                                email: authUser.email,
                                full_name: authUser.user_metadata?.full_name || authUser.user_metadata?.fullname || authUser.email?.split('@')[0],
                                status: 'active',
                                last_sign_in_at: authUser.last_sign_in_at,
                                created_at: authUser.created_at,
                                updated_at: new Date().toISOString()
                            };
                            
                            // Upsert profile
                            const { error: upsertError } = await window.App.supabase
                                .from('profiles')
                                .upsert(profileData, { onConflict: 'id' });
                            
                            if (!upsertError) {
                                console.log('‚úÖ Synced profile for:', authUser.email);
                            }
                        }
                        
                        showNotification(`Successfully synced ${authUsers.users.length} users!`, 'success');
                        setTimeout(() => loadUsersTable(), 1000);
                        return;
                    }
                } catch (adminError) {
                    console.log('Admin API not available:', adminError);
                }
                
                // Method 2: Force create profiles for known users
                console.log('üîÑ Trying alternative sync method...');
                
                // Get current session user and ensure their profile exists
                const session = await window.App.getSession();
                if (session?.user) {
                    const currentUser = session.user;
                    const profileData = {
                        id: currentUser.id,
                        email: currentUser.email,
                        full_name: currentUser.user_metadata?.full_name || currentUser.user_metadata?.fullname || currentUser.email?.split('@')[0],
                        status: 'active',
                        last_sign_in_at: new Date().toISOString(),
                        created_at: currentUser.created_at || new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    };
                    
                    const { error: createError } = await window.App.supabase
                        .from('profiles')
                        .upsert(profileData, { onConflict: 'id' });
                    
                    if (!createError) {
                        console.log('‚úÖ Ensured profile for current user:', currentUser.email);
                        showNotification('Current user profile updated. Other users will appear when they login.', 'success');
                    }
                } else {
                    showNotification('No active session. Users will be created when they login.', 'warning');
                }
                
                setTimeout(() => loadUsersTable(), 1000);
                
            } catch (error) {
                console.error('Error in user sync:', error);
                showNotification('Sync completed with limitations. Users will be created on login.', 'warning');
            }
        }
        
        // Report Management Functions
        function switchReportTab(type) {
            currentReportType = type;
            
            // Update tab styling
            const allTab = document.getElementById('allReportsTab');
            const tradeTab = document.getElementById('tradeReportTab');
            const accountTab = document.getElementById('accountReportTab');
            
            // Reset all tabs
            allTab.className = 'flex-1 py-3 font-bold text-lg border-b-2 border-transparent text-gray-500';
            tradeTab.className = 'flex-1 py-3 font-bold text-lg border-b-2 border-transparent text-gray-500';
            accountTab.className = 'flex-1 py-3 font-bold text-lg border-b-2 border-transparent text-gray-500';
            
            // Set active tab
            if (type === 'all') {
                allTab.className = 'flex-1 py-3 font-bold text-lg border-b-2 border-blue-500 text-blue-500';
            } else if (type === 'trade') {
                tradeTab.className = 'flex-1 py-3 font-bold text-lg border-b-2 border-orange-500 text-orange-500';
            } else if (type === 'account_open') {
                accountTab.className = 'flex-1 py-3 font-bold text-lg border-b-2 border-purple-500 text-purple-500';
            }
            
            loadReportsTable();
        }
        
        async function loadReportsTable() {
            try {
                console.log('Loading reports table for type:', currentReportType);
                
                // First, get all reports
                let query = window.App.supabase
                    .from('reports')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                // Apply report type filter
                if (currentReportType !== 'all') {
                    query = query.eq('report_type', currentReportType);
                }
                
                const { data: reports, error } = await query;
                
                if (error) throw error;
                
                // Get unique user IDs from reports
                const userIds = [...new Set(reports.map(r => r.user_id).filter(Boolean))];
                
                // Fetch user profiles separately
                let userProfiles = {};
                if (userIds.length > 0) {
                    const { data: profiles, error: profileError } = await window.App.supabase
                        .from('profiles')
                        .select('id, full_name, email')
                        .in('id', userIds);
                    
                    if (!profileError && profiles) {
                        profiles.forEach(profile => {
                            userProfiles[profile.id] = profile;
                        });
                    }
                }
                
                // Combine reports with user profiles
                const reportsWithProfiles = reports.map(report => ({
                    ...report,
                    profiles: userProfiles[report.user_id] || null
                }));
                
                // Store reports for filtering
                allReports = reportsWithProfiles || [];
                
                // Load filter options
                await loadFilterOptions();
                
                // Apply current filters
                const filteredReports = applyCurrentFilters(allReports);
                
                // Render table
                renderReportsTable(filteredReports);
                
                console.log(`Loaded ${allReports.length} reports, showing ${filteredReports.length} after filters`);
                
            } catch (error) {
                console.error('Error loading reports:', error);
                showNotification('Error loading reports', 'error');
                
                // Show error in table
                const tableBody = document.getElementById('reportsTable');
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="11" class="py-8 text-center text-red-500">
                            <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                            <div class="font-semibold">Error loading reports</div>
                            <div class="text-sm mt-1">${error.message}</div>
                        </td>
                    </tr>
                `;
            }
        }
        
        async function loadFilterOptions() {
            try {
                // Load unique users from reports
                const uniqueUsers = [...new Map(allReports.map(r => [r.user_id, r.profiles])).values()];
                const userFilter = document.getElementById('userFilter');
                userFilter.innerHTML = '<option value="">All Users</option>';
                uniqueUsers.forEach(user => {
                    if (user) {
                        const option = document.createElement('option');
                        option.value = user.email;
                        option.textContent = `${user.full_name || user.email} (${user.email})`;
                        userFilter.appendChild(option);
                    }
                });
                
                // Load unique application names from reports for campaign filter
                const uniqueApplications = [...new Set(allReports.map(r => r.application_name).filter(Boolean))];
                const campaignFilter = document.getElementById('campaignFilter');
                campaignFilter.innerHTML = '<option value="">All Campaigns</option>';
                uniqueApplications.forEach(appName => {
                    const option = document.createElement('option');
                    option.value = appName;
                    option.textContent = appName;
                    campaignFilter.appendChild(option);
                });
                
                // Also try to load from campaigns table if it exists
                try {
                    const { data: campaigns } = await window.App.supabase
                        .from('campaigns')
                        .select('name')
                        .eq('is_active', true);
                    
                    if (campaigns && campaigns.length > 0) {
                        campaigns.forEach(campaign => {
                            // Only add if not already in the list
                            if (!uniqueApplications.includes(campaign.name)) {
                                const option = document.createElement('option');
                                option.value = campaign.name;
                                option.textContent = campaign.name;
                                campaignFilter.appendChild(option);
                            }
                        });
                    }
                } catch (campaignError) {
                    console.log('Campaigns table not available or empty:', campaignError);
                }
                
            } catch (error) {
                console.error('Error loading filter options:', error);
            }
        }
        
        function applyCurrentFilters(reports) {
            let filtered = [...reports];
            
            // User filter
            const userFilter = document.getElementById('userFilter').value;
            if (userFilter) {
                filtered = filtered.filter(r => r.profiles?.email === userFilter);
            }
            
            // Status filter
            const statusFilter = document.getElementById('statusFilter').value;
            if (statusFilter) {
                filtered = filtered.filter(r => r.status === statusFilter);
            }
            
            // Campaign filter
            const campaignFilter = document.getElementById('campaignFilter').value;
            if (campaignFilter) {
                filtered = filtered.filter(r => r.application_name === campaignFilter);
            }
            
            // Payment filter - Updated to handle all payment status variations
            const paymentFilter = document.getElementById('paymentFilter').value;
            if (paymentFilter) {
                console.log(`üí∞ Applying payment filter: ${paymentFilter}`);
                
                if (paymentFilter === 'not_paid') {
                    // Include all variations of "not paid" including legacy "Pending" status
                    const beforeCount = filtered.length;
                    filtered = filtered.filter(r => 
                        r.payment_status === 'not_paid' || 
                        r.payment_status === 'unpaid' || 
                        r.payment_status === 'Pending' || // Legacy data
                        r.payment_status === 'pending' || // Legacy data
                        !r.payment_status
                    );
                    console.log(`‚ùå NOT PAID filter: ${beforeCount} ‚Üí ${filtered.length} (including legacy Pending)`);
                } else if (paymentFilter === 'paid') {
                    // Paid status
                    const beforeCount = filtered.length;
                    filtered = filtered.filter(r => r.payment_status === 'paid');
                    console.log(`üí∞ PAID filter: ${beforeCount} ‚Üí ${filtered.length}`);
                } else if (paymentFilter === 'partial') {
                    // Partial paid status
                    const beforeCount = filtered.length;
                    filtered = filtered.filter(r => 
                        r.payment_status === 'partial' ||
                        r.payment_status === 'partial_paid'
                    );
                    console.log(`üí∏ PARTIAL filter: ${beforeCount} ‚Üí ${filtered.length}`);
                } else {
                    // Direct match for any other status
                    const beforeCount = filtered.length;
                    filtered = filtered.filter(r => r.payment_status === paymentFilter);
                    console.log(`üîç Direct payment filter: ${beforeCount} ‚Üí ${filtered.length}`);
                }
            }
            
            // Single submission date filter - Fixed timezone handling
            const submissionDate = document.getElementById('submissionDateFilter').value;
            if (submissionDate) {
                console.log('üîç Filtering by date:', submissionDate);
                
                // Create date objects in consistent timezone
                const filterDate = new Date(submissionDate + 'T00:00:00');
                const nextDay = new Date(submissionDate + 'T23:59:59');
                
                console.log('üìÖ Filter range:', {
                    from: filterDate.toISOString(),
                    to: nextDay.toISOString(),
                    localFrom: filterDate.toLocaleString(),
                    localTo: nextDay.toLocaleString()
                });
                
                filtered = filtered.filter(r => {
                    const reportDate = new Date(r.created_at);
                    const reportDateOnly = new Date(reportDate.getFullYear(), reportDate.getMonth(), reportDate.getDate());
                    const filterDateOnly = new Date(filterDate.getFullYear(), filterDate.getMonth(), filterDate.getDate());
                    
                    const matches = reportDateOnly.getTime() === filterDateOnly.getTime();
                    
                    if (matches) {
                        console.log('‚úÖ Match found:', {
                            reportId: r.id,
                            reportDate: reportDate.toLocaleString(),
                            filterDate: submissionDate
                        });
                    }
                    
                    return matches;
                });
                
                console.log(`üìä Date filter results: ${filtered.length} reports match date ${submissionDate}`);
            }
            
            // Date range filter - Fixed timezone handling
            const fromDate = document.getElementById('fromDateFilter')?.value;
            const toDate = document.getElementById('toDateFilter')?.value;
            
            if (fromDate || toDate) {
                console.log('üóìÔ∏è Applying date range filter:', { fromDate, toDate });
                
                filtered = filtered.filter(r => {
                    const reportDate = new Date(r.created_at);
                    const reportDateOnly = new Date(reportDate.getFullYear(), reportDate.getMonth(), reportDate.getDate());
                    
                    // If both dates are provided
                    if (fromDate && toDate) {
                        const startDateOnly = new Date(fromDate + 'T00:00:00');
                        const endDateOnly = new Date(toDate + 'T23:59:59');
                        const startDateComp = new Date(startDateOnly.getFullYear(), startDateOnly.getMonth(), startDateOnly.getDate());
                        const endDateComp = new Date(endDateOnly.getFullYear(), endDateOnly.getMonth(), endDateOnly.getDate());
                        
                        const matches = reportDateOnly.getTime() >= startDateComp.getTime() && reportDateOnly.getTime() <= endDateComp.getTime();
                        
                        if (matches) {
                            console.log('‚úÖ Range match:', {
                                reportId: r.id,
                                reportDate: reportDate.toLocaleDateString(),
                                range: `${fromDate} to ${toDate}`
                            });
                        }
                        
                        return matches;
                    }
                    
                    // If only from date is provided
                    if (fromDate) {
                        const startDateOnly = new Date(fromDate + 'T00:00:00');
                        const startDateComp = new Date(startDateOnly.getFullYear(), startDateOnly.getMonth(), startDateOnly.getDate());
                        return reportDateOnly.getTime() >= startDateComp.getTime();
                    }
                    
                    // If only to date is provided
                    if (toDate) {
                        const endDateOnly = new Date(toDate + 'T23:59:59');
                        const endDateComp = new Date(endDateOnly.getFullYear(), endDateOnly.getMonth(), endDateOnly.getDate());
                        return reportDateOnly.getTime() <= endDateComp.getTime();
                    }
                    
                    return true;
                });
                
                console.log(`üìä Date range filter results: ${filtered.length} reports in range`);
            }
            
            return filtered;
        }
        
        function renderReportsTable(reports) {
            const tableBody = document.getElementById('reportsTable');
            tableBody.innerHTML = '';
            
            if (!reports || reports.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="11" class="py-8 text-center text-gray-500">
                            <i class="fas fa-clipboard-list text-3xl mb-2"></i>
                            <div class="font-semibold">No reports found</div>
                            <div class="text-sm mt-1">Reports will appear here when users submit them</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            reports.forEach(report => {
                const statusColor = getStatusColor(report.status);
                const typeColor = report.report_type === 'trade' ? 'bg-orange-100 text-orange-800' : 'bg-purple-100 text-purple-800';
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="py-3 px-4 border-b border-gray-200">
                        <div class="font-medium text-gray-900">${report.profiles?.full_name || 'Unknown'}</div>
                        <div class="text-gray-500 text-sm">${report.profiles?.email || ''}</div>
                    </td>
                    <td class="py-3 px-4 border-b border-gray-200">
                        <span class="px-2 py-1 text-xs rounded-full ${typeColor}">
                            ${report.report_type === 'trade' ? 'Trade' : 'Account Open'}
                        </span>
                    </td>
                    <td class="py-3 px-4 border-b border-gray-200 text-sm">
                        ${report.application_name || 'N/A'}
                    </td>
                    <td class="py-3 px-4 border-b border-gray-200 text-sm">
                        <div class="font-medium">${report.customer_name || 'N/A'}</div>
                    </td>
                    <td class="py-3 px-4 border-b border-gray-200 text-sm">
                        ${report.mobile_number || 'N/A'}
                    </td>
                    <td class="py-3 px-4 border-b border-gray-200 text-sm">
                        ${renderProofColumn(report)}
                    </td>
                    <td class="py-3 px-4 border-b border-gray-200 text-sm">
                        ${renderNotesColumn(report)}
                    </td>
                    <td class="py-3 px-4 border-b border-gray-200">
                        ${renderEditableStatus(report)}
                    </td>
                    <td class="py-3 px-4 border-b border-gray-200">
                        ${renderEditablePaymentStatus(report)}
                    </td>
                    <td class="py-3 px-4 border-b border-gray-200 text-sm text-gray-600">
                        ${new Date(report.created_at).toLocaleDateString()}
                    </td>
                    <td class="py-3 px-4 border-b border-gray-200">
                        <div class="flex gap-2">
                            <button onclick="openAdminNotesModal('${report.id}')" data-admin-notes="${(report.admin_notes || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}" class="${report.admin_notes && report.admin_notes.trim() ? 'bg-blue-500 hover:bg-blue-600' : 'bg-green-500 hover:bg-green-600'} text-white px-3 py-1 rounded text-xs transition-colors relative">
                                <i class="fas fa-sticky-note mr-1"></i>Notes
                                ${report.admin_notes && report.admin_notes.trim() ? '<span class="absolute -top-1 -right-1 w-3 h-3 bg-yellow-400 rounded-full border border-white"></span>' : ''}
                            </button>
                            <button onclick="deleteReport('${report.id}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-xs transition-colors">
                                <i class="fas fa-trash mr-1"></i>Delete
                            </button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        function getStatusColor(status) {
            switch(status) {
                case 'account open': return 'bg-green-100 text-green-800';
                case 'trade done': return 'bg-green-100 text-green-800';
                case 'rejected': return 'bg-red-100 text-red-800';
                case 'trade not done': return 'bg-red-100 text-red-800';
                case 'Under Review': return 'bg-blue-100 text-blue-800';
                case 'not found': return 'bg-gray-100 text-gray-800';
                case 'pending': return 'bg-yellow-100 text-yellow-800';
                default: return 'bg-yellow-100 text-yellow-800';
            }
        }
        
        function getPaymentStatusColor(paymentStatus) {
            switch(paymentStatus) {
                case 'paid': return 'bg-green-100 text-green-800';
                case 'partial': return 'bg-yellow-100 text-yellow-800';
                case 'not_paid':
                case 'unpaid':
                case null:
                case undefined:
                default: return 'bg-red-100 text-red-800';
            }
        }
        
        function renderProofColumn(report) {
            let proofHtml = '';
            
            if (report.payment_proof_url) {
                proofHtml += `<div class="mb-1">
                    <button onclick="downloadProof('${report.payment_proof_url}', 'payment_proof')" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs">
                        <i class="fas fa-download mr-1"></i>Payment
                    </button>
                </div>`;
            }
            
            if (report.trade_proof_url) {
                proofHtml += `<div class="mb-1">
                    <button onclick="downloadProof('${report.trade_proof_url}', 'trade_proof')" class="bg-orange-500 hover:bg-orange-600 text-white px-2 py-1 rounded text-xs">
                        <i class="fas fa-download mr-1"></i>Trade
                    </button>
                </div>`;
            }
            
            if (report.proof_url && !report.payment_proof_url && !report.trade_proof_url) {
                proofHtml += `<div class="mb-1">
                    <button onclick="downloadProof('${report.proof_url}', 'proof')" class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs">
                        <i class="fas fa-download mr-1"></i>Proof
                    </button>
                </div>`;
            }
            
            // Check for proof data in notes field (for trade reports)
            const proofFromNotes = extractProofFromNotes(report.notes);
            if (proofFromNotes) {
                const proofType = report.report_type === 'trade' ? 'Trade' : 'Proof';
                const buttonColor = report.report_type === 'trade' ? 'bg-orange-500 hover:bg-orange-600' : 'bg-green-500 hover:bg-green-600';
                proofHtml += `<div class="mb-1">
                    <button onclick="downloadProof('${proofFromNotes}', '${report.report_type}_proof')" class="${buttonColor} text-white px-2 py-1 rounded text-xs">
                        <i class="fas fa-download mr-1"></i>${proofType}
                    </button>
                </div>`;
            }
            
            return proofHtml || '<span class="text-gray-400 text-xs">No proof</span>';
        }
        
        function renderNotesColumn(report) {
            const cleanNotes = getCleanNotes(report.notes);
            if (cleanNotes && cleanNotes.trim()) {
                const shortNotes = cleanNotes.length > 50 ? cleanNotes.substring(0, 50) + '...' : cleanNotes;
                return `<div class="text-gray-700 text-xs" title="${cleanNotes}">${shortNotes}</div>`;
            }
            return '<span class="text-gray-400 text-xs">No notes</span>';
        }
        
        function renderEditableStatus(report) {
            // Different status options for trade reports vs account open reports
            if (report.report_type === 'trade') {
                return `
                    <select onchange="updateReportStatus('${report.id}', this.value)" class="px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 ${getStatusColor(report.status)}">
                        <option value="pending" ${report.status === 'pending' ? 'selected' : ''}>Pending</option>
                        <option value="trade done" ${report.status === 'trade done' ? 'selected' : ''}>Trade Done</option>
                        <option value="trade not done" ${report.status === 'trade not done' ? 'selected' : ''}>Trade Not Done</option>
                    </select>
                `;
            } else {
                // Account open reports
                return `
                    <select onchange="updateReportStatus('${report.id}', this.value)" class="px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 ${getStatusColor(report.status)}">
                        <option value="pending" ${report.status === 'pending' ? 'selected' : ''}>Pending</option>
                        <option value="Under Review" ${report.status === 'Under Review' ? 'selected' : ''}>Under Review</option>
                        <option value="account open" ${report.status === 'account open' ? 'selected' : ''}>Account Open</option>
                        <option value="not found" ${report.status === 'not found' ? 'selected' : ''}>Not Found</option>
                        <option value="rejected" ${report.status === 'rejected' ? 'selected' : ''}>Rejected</option>
                    </select>
                `;
            }
        }
        
        function renderEditablePaymentStatus(report) {
            return `
                <select onchange="updatePaymentStatus('${report.id}', this.value)" class="px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-green-500 ${getPaymentStatusColor(report.payment_status)}">
                    <option value="not_paid" ${(report.payment_status === 'not_paid' || report.payment_status === 'unpaid' || !report.payment_status) ? 'selected' : ''}>Not Paid</option>
                    <option value="paid" ${report.payment_status === 'paid' ? 'selected' : ''}>Paid</option>
                    <option value="partial" ${report.payment_status === 'partial' ? 'selected' : ''}>Partial Paid</option>
                </select>
            `;
        }
        
        async function updateReportStatus(reportId, newStatus) {
            try {
                showNotification('üîÑ Updating report status...', 'info');
                
                // Update the report status in database
                const { error } = await window.App.supabase
                    .from('reports')
                    .update({ 
                        status: newStatus
                    })
                    .eq('id', reportId);
                
                if (error) {
                    showNotification(`‚ùå Error updating status: ${error.message}`, 'error');
                    throw error;
                }
                
                // Verify the update was successful
                const { data: verifyData, error: verifyError } = await window.App.supabase
                    .from('reports')
                    .select('status')
                    .eq('id', reportId)
                    .single();
                
                if (verifyError) {
                    showNotification('‚ö†Ô∏è Could not verify status update', 'warning');
                } else if (verifyData.status === newStatus) {
                    showNotification(`‚úÖ Report status updated to "${newStatus}" and verified!`, 'success');
                    showNotification('üë§ User will see this update in their reports page', 'info');
                } else {
                    showNotification('‚ö†Ô∏è Status update may not have saved correctly', 'warning');
                }
                
                // Update local data if it exists
                if (typeof allReports !== 'undefined' && allReports) {
                    const reportIndex = allReports.findIndex(r => r.id === reportId);
                    if (reportIndex !== -1) {
                        allReports[reportIndex].status = newStatus;
                    }
                }
                
                // Refresh dashboard data to update counts
                if (typeof loadDashboardData === 'function') {
                    loadDashboardData();
                }
                
            } catch (error) {
                console.error('Error updating report status:', error);
                showNotification(`‚ùå Error updating status: ${error.message}`, 'error');
            }
        }
        
        async function updatePaymentStatus(reportId, newPaymentStatus) {
            try {
                showNotification('üîÑ Updating payment status...', 'info');
                
                // Update the payment status in database
                const { error } = await window.App.supabase
                    .from('reports')
                    .update({ 
                        payment_status: newPaymentStatus
                    })
                    .eq('id', reportId);
                
                if (error) {
                    showNotification(`‚ùå Error updating payment status: ${error.message}`, 'error');
                    throw error;
                }
                
                // Verify the update was successful
                const { data: verifyData, error: verifyError } = await window.App.supabase
                    .from('reports')
                    .select('payment_status')
                    .eq('id', reportId)
                    .single();
                
                if (verifyError) {
                    showNotification('‚ö†Ô∏è Could not verify payment status update', 'warning');
                } else if (verifyData.payment_status === newPaymentStatus) {
                    showNotification(`‚úÖ Payment status updated to "${newPaymentStatus}" and verified!`, 'success');
                    showNotification('üë§ User will see this update in their reports page', 'info');
                } else {
                    showNotification('‚ö†Ô∏è Payment status update may not have saved correctly', 'warning');
                }
                
                // Update local data if it exists
                if (typeof allReports !== 'undefined' && allReports) {
                    const reportIndex = allReports.findIndex(r => r.id === reportId);
                    if (reportIndex !== -1) {
                        allReports[reportIndex].payment_status = newPaymentStatus;
                    }
                }
                
                // Refresh dashboard data to update counts
                if (typeof loadDashboardData === 'function') {
                    loadDashboardData();
                }
                
            } catch (error) {
                console.error('Error updating payment status:', error);
                showNotification(`‚ùå Error updating payment status: ${error.message}`, 'error');
            }
        }
        
        async function viewReportDetails(reportId) {
            try {
                currentReportId = reportId;
                
                // Get the report
                const { data: report, error } = await window.App.supabase
                    .from('reports')
                    .select('*')
                    .eq('id', reportId)
                    .single();
                
                if (error) throw error;
                
                // Get user profile separately if user_id exists
                if (report.user_id) {
                    const { data: profile } = await window.App.supabase
                        .from('profiles')
                        .select('id, full_name, email')
                        .eq('id', report.user_id)
                        .single();
                    
                    report.profiles = profile;
                }
                
                const content = document.getElementById('reportDetailsContent');
                
                // Build comprehensive report details
                let detailsHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">User Information</label>
                                <div class="bg-gray-50 p-3 rounded-lg">
                                    <p class="font-medium text-gray-900">${report.profiles?.full_name || 'Unknown'}</p>
                                    <p class="text-gray-600 text-sm">${report.profiles?.email || 'No email'}</p>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Report Type</label>
                                <div class="bg-gray-50 p-3 rounded-lg">
                                    <span class="px-3 py-1 text-sm rounded-full ${
                                        report.report_type === 'trade' ? 'bg-orange-100 text-orange-800' : 'bg-purple-100 text-purple-800'
                                    }">
                                        ${report.report_type === 'trade' ? 'Trade Report' : 'Account Open Report'}
                                    </span>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                <div class="bg-gray-50 p-3 rounded-lg">
                                    <select id="reportStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="updateReportField('status', this.value)">
                                        <option value="pending" ${report.status === 'pending' ? 'selected' : ''}>Pending</option>
                                        <option value="approved" ${report.status === 'approved' ? 'selected' : ''}>Approved</option>
                                        <option value="rejected" ${report.status === 'rejected' ? 'selected' : ''}>Rejected</option>
                                        <option value="account_opened" ${report.status === 'account_opened' ? 'selected' : ''}>Account Opened</option>
                                        <option value="not_found" ${report.status === 'not_found' ? 'selected' : ''}>Not Found</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Submission Date</label>
                                <div class="bg-gray-50 p-3 rounded-lg">
                                    <p class="text-gray-900">${new Date(report.created_at).toLocaleString()}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Application Name</label>
                                <div class="bg-gray-50 p-3 rounded-lg">
                                    <p class="text-gray-900 font-medium">${report.application_name || 'Not specified'}</p>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Customer Name</label>
                                <div class="bg-gray-50 p-3 rounded-lg">
                                    <p class="text-gray-900">${report.customer_name || 'Not specified'}</p>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Mobile Number</label>
                                <div class="bg-gray-50 p-3 rounded-lg">
                                    <p class="text-gray-900">${report.mobile_number || 'Not specified'}</p>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Payment Status</label>
                                <div class="bg-gray-50 p-3 rounded-lg">
                                    <select id="paymentStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="updateReportField('payment_status', this.value)">
                                        <option value="not_paid" ${(report.payment_status === 'not_paid' || report.payment_status === 'unpaid' || !report.payment_status) ? 'selected' : ''}>Not Paid</option>
                                        <option value="paid" ${report.payment_status === 'paid' ? 'selected' : ''}>Paid</option>
                                        <option value="partial" ${report.payment_status === 'partial' ? 'selected' : ''}>Partial Payment</option>
                                        <option value="pending" ${report.payment_status === 'pending' ? 'selected' : ''}>Payment Pending</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add notes section if available (clean notes without proof data)
                const cleanNotes = getCleanNotes(report.notes);
                if (cleanNotes) {
                    detailsHTML += `
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">User Notes</label>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <p class="text-gray-900 whitespace-pre-wrap">${cleanNotes}</p>
                            </div>
                        </div>
                    `;
                }
                
                // Add proof images section with download functionality
                let proofSection = '';
                
                // Check for proof in various locations
                let proofUrl = report.payment_proof_url || report.trade_proof_url || report.proof_url;
                
                // If no direct proof URL, try to extract from notes
                if (!proofUrl) {
                    proofUrl = extractProofFromNotes(report.notes);
                }
                
                if (proofUrl) {
                    proofSection = '<div class="mb-6"><label class="block text-sm font-medium text-gray-700 mb-3">Submitted Proof</label><div class="grid grid-cols-1 gap-4">';
                    
                    proofSection += `
                        <div class="border rounded-lg p-3">
                            <div class="flex justify-between items-center mb-2">
                                <p class="text-sm font-medium text-gray-700">Proof Document</p>
                                <button onclick="downloadProof('${proofUrl}', 'proof')" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs">
                                    <i class="fas fa-download mr-1"></i>Download
                                </button>
                            </div>
                            <img src="${proofUrl}" alt="Proof" class="w-full h-48 object-cover rounded border cursor-pointer" onclick="window.open('${proofUrl}', '_blank')">
                        </div>
                    `;
                    
                    proofSection += '</div></div>';
                    detailsHTML += proofSection;
                }
                
                // Add admin notes from previous reviews
                if (report.admin_notes && report.admin_notes.trim()) {
                    detailsHTML += `
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Previous Admin Notes</label>
                            <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg">
                                <p class="text-gray-900 whitespace-pre-wrap leading-relaxed">${report.admin_notes}</p>
                            </div>
                        </div>
                    `;
                }
                
                content.innerHTML = detailsHTML;
                
                // Clear the admin notes textarea for new notes
                document.getElementById('adminNotes').value = '';
                document.getElementById('reportDetailsModal').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error loading report details:', error);
                showNotification('Error loading report details', 'error');
            }
        }
        
        function closeReportDetailsModal() {
            document.getElementById('reportDetailsModal').classList.add('hidden');
            currentReportId = null;
        }
        
        // Admin Notes Modal Functions
        let currentNotesReportId = null;
        
        function openAdminNotesModal(reportId) {
            console.log('üìù Opening admin notes modal for report:', reportId);
            currentNotesReportId = reportId;
            
            // Get the button that was clicked to retrieve admin notes
            const button = event.target.closest('button');
            const existingNotes = button.getAttribute('data-admin-notes') || '';
            
            // Decode HTML entities
            const decodedNotes = existingNotes.replace(/&quot;/g, '"').replace(/&#39;/g, "'");
            
            document.getElementById('adminNotesTextarea').value = decodedNotes;
            document.getElementById('adminNotesModal').classList.remove('hidden');
        }
        
        function closeAdminNotesModal() {
            document.getElementById('adminNotesModal').classList.add('hidden');
            currentNotesReportId = null;
            document.getElementById('adminNotesTextarea').value = '';
            
            // Reset button to original state when closing
            const saveButton = document.querySelector('#adminNotesModal button[type="submit"]');
            if (saveButton) {
                saveButton.innerHTML = 'üîµ Save Notes';
                saveButton.disabled = false;
                saveButton.style.backgroundColor = '';
                saveButton.style.color = '';
                saveButton.className = 'flex-1 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg';
            }
        }
        
        // Test function to verify button changes work
        function testButtonStates() {
            console.log('üß™ Testing button state changes...');
            const saveButton = document.querySelector('#adminNotesModal button[type="submit"]');
            if (!saveButton) {
                console.error('‚ùå Save button not found for testing');
                return;
            }
            
            console.log('1Ô∏è‚É£ Original state');
            setTimeout(() => {
                console.log('2Ô∏è‚É£ Loading state');
                saveButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
                saveButton.style.backgroundColor = '#6B7280';
                saveButton.disabled = true;
                
                setTimeout(() => {
                    console.log('3Ô∏è‚É£ Success state');
                    saveButton.innerHTML = '<i class="fas fa-check mr-2"></i>Saved!';
                    saveButton.style.backgroundColor = '#10B981';
                    saveButton.disabled = false;
                    
                    setTimeout(() => {
                        console.log('4Ô∏è‚É£ Reset to original');
                        saveButton.innerHTML = 'üîµ Save Notes';
                        saveButton.style.backgroundColor = '';
                        saveButton.disabled = false;
                        console.log('‚úÖ Button test complete');
                    }, 1000);
                }, 1000);
            }, 1000);
        }
        
        async function saveAdminNotes() {
            // Get notes from the textarea in report details modal
            const notes = document.getElementById('adminNotes').value.trim();
            
            if (!currentReportId) {
                showNotification('‚ùå Error: No report selected', 'error');
                return;
            }
            
            if (!notes) {
                showNotification('‚ùå Please enter admin notes before saving', 'error');
                return;
            }
            
            // Show loading state on save button
            const saveButton = document.querySelector('button[onclick="saveAdminNotes()"]');
            if (!saveButton) {
                showNotification('‚ùå Save button not found', 'error');
                return;
            }
            
            const originalButtonText = saveButton.innerHTML;
            const originalButtonClass = saveButton.className;
            
            // Show loading notification
            showNotification('üîÑ Saving admin notes...', 'info');
            saveButton.innerHTML = '<i class="fas fa-sync fa-spin mr-2"></i>üîÑ Saving...';
            saveButton.disabled = true;
            saveButton.style.backgroundColor = '#6B7280';
            saveButton.style.color = 'white';
            
            try {
                // Test database connection and admin_notes field
                showNotification('üîç Testing database connection...', 'info');
                
                const { error } = await window.App.supabase
                    .from('reports')
                    .update({ 
                        admin_notes: notes
                    })
                    .eq('id', currentReportId);
                
                if (error) {
                    console.error('‚ùå Database error:', error);
                    showNotification(`‚ùå Database Error: ${error.message}`, 'error');
                    
                    // Check if it's a schema error
                    if (error.message.includes('admin_notes') || error.message.includes('column')) {
                        showNotification('üîß Schema Issue: admin_notes column might be missing from reports table', 'warning');
                    }
                    
                    throw error;
                }
                
                // Verify the update was successful by reading back from database
                showNotification('‚úÖ Database updated! Verifying...', 'success');
                
                const { data: verifyData, error: verifyError } = await window.App.supabase
                    .from('reports')
                    .select('admin_notes')
                    .eq('id', currentReportId)
                    .single();
                
                if (verifyError) {
                    showNotification('‚ö†Ô∏è Could not verify update', 'warning');
                } else if (verifyData.admin_notes === notes) {
                    showNotification('‚úÖ Admin notes saved and verified!', 'success');
                } else {
                    showNotification('‚ö†Ô∏è Update may not have saved correctly', 'warning');
                }
                
                // Update local data
                const reportIndex = allReports.findIndex(r => r.id === currentReportId);
                if (reportIndex !== -1) {
                    allReports[reportIndex].admin_notes = notes;
                }
                
                // Show success state on button and screen
                saveButton.innerHTML = '‚úÖ Saved!';
                saveButton.style.backgroundColor = '#10B981';
                saveButton.style.color = 'white';
                saveButton.disabled = false;
                
                // Notes saved successfully - no table refresh needed since reports section was removed
                
                // Show detailed success notification
                const notePreview = notes.length > 50 ? notes.substring(0, 50) + '...' : notes;
                setTimeout(() => {
                    showNotification(`üìù Note Preview: "${notePreview}"\n\nüë§ User will see this message in their reports page.`, 'info');
                }, 500);
                
                // Reset button to original state after 1.5 seconds
                setTimeout(() => {
                    showNotification('üîÑ Button reset to original state', 'info');
                    saveButton.innerHTML = originalButtonText;
                    saveButton.style.backgroundColor = '';
                    saveButton.style.color = '';
                    saveButton.disabled = false;
                }, 1500);
                
            } catch (error) {
                // Show error notification and reset button
                showNotification(`‚ùå Error saving admin notes: ${error.message}`, 'error');
                showNotification('üîÑ Resetting button to original state', 'info');
                
                saveButton.innerHTML = originalButtonText;
                saveButton.disabled = false;
                saveButton.className = originalButtonClass;
                saveButton.style.backgroundColor = '';
                saveButton.style.color = '';
            }
        }
        
        async function approveReport() {
            if (!currentReportId) return;
            
            try {
                const adminNotes = document.getElementById('adminNotes').value;
                
                const { error } = await window.App.supabase
                    .from('reports')
                    .update({ 
                        status: 'approved', 
                        admin_notes: adminNotes,
                        approved_at: new Date().toISOString()
                    })
                    .eq('id', currentReportId);
                
                if (error) throw error;
                
                showNotification('Report approved successfully', 'success');
                closeReportDetailsModal();
                loadReportsTable();
                loadDashboardData();
            } catch (error) {
                console.error('Error approving report:', error);
                showNotification('Error approving report', 'error');
            }
        }
        
        async function rejectReport() {
            if (!currentReportId) return;
            
            try {
                const adminNotes = document.getElementById('adminNotes').value;
                
                const { error } = await window.App.supabase
                    .from('reports')
                    .update({ 
                        status: 'rejected', 
                        admin_notes: adminNotes,
                        rejected_at: new Date().toISOString()
                    })
                    .eq('id', currentReportId);
                
                if (error) throw error;
                
                showNotification('Report rejected', 'success');
                closeReportDetailsModal();
                loadReportsTable();
                loadDashboardData();
            } catch (error) {
                console.error('Error rejecting report:', error);
                showNotification('Error rejecting report', 'error');
            }
        }
        
        function applyReportFilters() {
            // Apply current filters to existing reports data
            const filteredReports = applyCurrentFilters(allReports);
            renderReportsTable(filteredReports);
            
            // Show notification about filter results
            const totalReports = allReports.length;
            const filteredCount = filteredReports.length;
            
            if (filteredCount === totalReports) {
                showNotification(`Showing all ${totalReports} reports`, 'info');
            } else {
                showNotification(`Showing ${filteredCount} of ${totalReports} reports`, 'info');
            }
        }
        
        // New functions for enhanced admin functionality
        
        async function deleteReport(reportId) {
            if (!confirm('Are you sure you want to delete this report? This action cannot be undone.')) {
                return;
            }
            
            try {
                const { error } = await window.App.supabase
                    .from('reports')
                    .delete()
                    .eq('id', reportId);
                
                if (error) throw error;
                
                showNotification('Report deleted successfully', 'success');
                loadReportsTable();
                loadDashboardData();
            } catch (error) {
                console.error('Error deleting report:', error);
                showNotification('Error deleting report', 'error');
            }
        }
        
        async function deleteCurrentReport() {
            if (!currentReportId) return;
            
            if (!confirm('Are you sure you want to delete this report? This action cannot be undone.')) {
                return;
            }
            
            try {
                const { error } = await window.App.supabase
                    .from('reports')
                    .delete()
                    .eq('id', currentReportId);
                
                if (error) throw error;
                
                showNotification('Report deleted successfully', 'success');
                closeReportDetailsModal();
                loadReportsTable();
                loadDashboardData();
            } catch (error) {
                console.error('Error deleting report:', error);
                showNotification('Error deleting report', 'error');
            }
        }
        
        async function updateReportField(field, value) {
            if (!currentReportId) {
                showNotification('‚ùå No report selected', 'error');
                return;
            }
            
            try {
                showNotification(`üîÑ Updating ${field.replace('_', ' ')}...`, 'info');
                
                const updateData = {};
                updateData[field] = value;
                
                const { error } = await window.App.supabase
                    .from('reports')
                    .update(updateData)
                    .eq('id', currentReportId);
                
                if (error) {
                    showNotification(`‚ùå Error updating ${field}: ${error.message}`, 'error');
                    throw error;
                }
                
                // Verify the update was successful
                const { data: verifyData, error: verifyError } = await window.App.supabase
                    .from('reports')
                    .select(field)
                    .eq('id', currentReportId)
                    .single();
                
                if (verifyError) {
                    showNotification(`‚ö†Ô∏è Could not verify ${field} update`, 'warning');
                } else if (verifyData[field] === value) {
                    showNotification(`‚úÖ ${field.replace('_', ' ')} updated to "${value}" and verified!`, 'success');
                    showNotification('üë§ User will see this update in their reports page', 'info');
                } else {
                    showNotification(`‚ö†Ô∏è ${field} update may not have saved correctly`, 'warning');
                }
                
            } catch (error) {
                console.error(`Error updating ${field}:`, error);
                showNotification(`‚ùå Error updating ${field}: ${error.message}`, 'error');
            }
        }
        
        async function saveAdminNotes() {
            if (!currentReportId) return;
            
            try {
                const adminNotes = document.getElementById('adminNotes').value;
                
                const { error } = await window.App.supabase
                    .from('reports')
                    .update({ 
                        admin_notes: adminNotes
                    })
                    .eq('id', currentReportId);
                
                if (error) throw error;
                
                showNotification('Admin notes saved successfully', 'success');
                
                // Refresh the modal content to show updated notes
                viewReportDetails(currentReportId);
                
            } catch (error) {
                console.error('Error saving admin notes:', error);
                showNotification('Error saving admin notes', 'error');
            }
        }
        
        function extractProofFromNotes(notes) {
            if (!notes) return null;
            
            // Look for proof data between delimiters
            const startMarker = '--- PROOF_DATA_START ---';
            const endMarker = '--- PROOF_DATA_END ---';
            
            const startIndex = notes.indexOf(startMarker);
            const endIndex = notes.indexOf(endMarker);
            
            if (startIndex !== -1 && endIndex !== -1 && endIndex > startIndex) {
                const proofData = notes.substring(startIndex + startMarker.length, endIndex).trim();
                return proofData.startsWith('data:') ? proofData : null;
            }
            
            return null;
        }
        
        function getCleanNotes(notes) {
            if (!notes) return '';
            
            // Remove proof data from notes for display
            const startMarker = '--- PROOF_DATA_START ---';
            const endMarker = '--- PROOF_DATA_END ---';
            
            const startIndex = notes.indexOf(startMarker);
            if (startIndex !== -1) {
                const endIndex = notes.indexOf(endMarker);
                if (endIndex !== -1) {
                    // Remove the proof data section
                    const beforeProof = notes.substring(0, startIndex).trim();
                    const afterProof = notes.substring(endIndex + endMarker.length).trim();
                    return (beforeProof + (beforeProof && afterProof ? '\n\n' : '') + afterProof).trim();
                }
            }
            
            return notes;
        }
        
        function downloadProof(url, type) {
            try {
                if (!url) {
                    showNotification('No proof URL available', 'error');
                    return;
                }
                
                // Check if it's base64 data
                if (url.startsWith('data:')) {
                    // Handle base64 data
                    const link = document.createElement('a');
                    link.href = url;
                    
                    // Create filename based on type and timestamp
                    const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                    const extension = url.includes('image/jpeg') || url.includes('image/jpg') ? 'jpg' : 
                                    url.includes('image/png') ? 'png' : 
                                    url.includes('application/pdf') ? 'pdf' : 'jpg';
                    const filename = `${type}_${timestamp}.${extension}`;
                    
                    link.download = filename;
                    link.target = '_blank';
                    
                    // Append to body, click, and remove
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    showNotification('Download started', 'success');
                } else {
                    // Handle regular URL
                    const link = document.createElement('a');
                    link.href = url;
                    
                    // Extract filename from URL or create a default one
                    let filename = url.split('/').pop();
                    if (!filename || !filename.includes('.')) {
                        const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                        filename = `${type}_${timestamp}.jpg`;
                    }
                    
                    link.download = filename;
                    link.target = '_blank';
                    
                    // Append to body, click, and remove
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    showNotification('Download started', 'success');
                }
                
            } catch (error) {
                console.error('Error downloading proof:', error);
                showNotification('Error downloading proof', 'error');
            }
        }
        
        function setupEventListeners() {
            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', async () => {
                try {
                    // Clear redirect flags
                    sessionStorage.removeItem('lastAdminRedirect');
                    sessionStorage.removeItem('adminRedirectCount');
                    
                    // Sign out
                    await window.App.signOut();
                    
                    // Redirect to login with logout flag
                    window.location.replace('login.html?logout=true');
                } catch (error) {
                    console.error('Error signing out:', error);
                    showNotification('Error signing out', 'error');
                    // Force redirect even if signout fails
                    window.location.replace('login.html?logout=true');
                }
            });
            
            // Edit Earnings Form
            document.getElementById('editEarningsForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const userId = document.getElementById('editUserId').value;
                const todayEarnings = parseFloat(document.getElementById('editTodayEarnings').value);
                const weekEarnings = parseFloat(document.getElementById('edit7DayEarnings').value);
                const monthEarnings = parseFloat(document.getElementById('edit30DayEarnings').value);
                const status = document.getElementById('editUserStatus').value;
                
                try {
                    // Update user status
                    const { error: profileError } = await window.App.supabase
                        .from('profiles')
                        .update({ status })
                        .eq('id', userId);
                    
                    if (profileError) throw profileError;
                    
                    // Update or create earnings record with time-based earnings
                    const { error: earningsError } = await window.App.supabase
                        .from('earnings')
                        .upsert({ 
                            user_id: userId, 
                            today_earnings: todayEarnings,
                            week_earnings: weekEarnings,
                            month_earnings: monthEarnings,
                            updated_at: new Date().toISOString()
                        });
                    
                    if (earningsError) throw earningsError;
                    
                    showNotification('User earnings updated successfully', 'success');
                    closeEditEarningsModal();
                    loadUsersTable();
                    loadDashboardData();
                } catch (error) {
                    console.error('Error updating user:', error);
                    showNotification('Error updating user', 'error');
                }
            });
            
            // Edit Campaign Form
            document.getElementById('editCampaignForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                if (!window.editingCampaignId) {
                    showNotification('No campaign selected for editing', 'error');
                    return;
                }
                
                // Prepare update data
                const updateData = {
                    name: document.getElementById('editCampaignName').value.trim(),
                    campaign_type: document.getElementById('editCampaignType').value,
                    is_active: document.getElementById('editCampaignStatus').value === 'active'
                };
                
                // Add description if provided
                const description = document.getElementById('editCampaignDescription').value.trim();
                if (description) updateData.description = description;
                
                // Add reward amount
                const rewardAmount = parseFloat(document.getElementById('editPayoutWithTrade').value);
                if (rewardAmount > 0) updateData.reward_amount = rewardAmount;
                
                // Add links if provided
                const accountOpenLink = document.getElementById('editAccountOpenLink').value.trim();
                const tradeVideoLink = document.getElementById('editTradeVideoLink').value.trim();
                const referralLink = document.getElementById('editReferralLink').value.trim();
                const campaignImage = document.getElementById('editCampaignImage').value.trim();
                const adminNotes = document.getElementById('editAdminNotes').value.trim();
                
                if (accountOpenLink) updateData.account_open_link = accountOpenLink;
                if (tradeVideoLink) updateData.trade_video_link = tradeVideoLink;
                if (referralLink) updateData.referral_link = referralLink;
                if (campaignImage) updateData.image_url = campaignImage;
                if (adminNotes) updateData.notes = adminNotes;
                
                console.log('Updating campaign with data:', updateData);
                
                // Validation
                if (!updateData.name) {
                    showNotification('Campaign name is required', 'error');
                    return;
                }
                
                if (!updateData.campaign_type) {
                    showNotification('Campaign type is required', 'error');
                    return;
                }
                
                if (!rewardAmount || rewardAmount <= 0) {
                    showNotification('Reward amount must be greater than 0', 'error');
                    return;
                }
                
                try {
                    const { error } = await window.App.supabase
                        .from('campaigns')
                        .update(updateData)
                        .eq('id', window.editingCampaignId);
                    
                    if (error) throw error;
                    
                    showNotification('Campaign updated successfully!', 'success');
                    closeEditCampaignModal();
                    loadCampaignsTable();
                    loadDashboardData();
                    
                } catch (error) {
                    console.error('Error updating campaign:', error);
                    showNotification('Error updating campaign: ' + error.message, 'error');
                }
            });
            
            // Add Campaign Form
            document.getElementById('addCampaignForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                // Start with basic required fields only
                const formData = {
                    name: document.getElementById('campaignName').value.trim(),
                    campaign_type: document.getElementById('campaignType').value,
                    is_active: document.getElementById('campaignStatus').value === 'active'
                };
                
                // Add description if provided
                const description = document.getElementById('campaignDescription').value.trim();
                if (description) formData.description = description;
                
                // Add reward amount (using the existing field name from database)
                const payoutWithTrade = parseFloat(document.getElementById('payoutWithTrade').value);
                if (payoutWithTrade > 0) formData.reward_amount = payoutWithTrade;
                
                // Add links if provided
                const accountOpenLink = document.getElementById('accountOpenLink').value.trim();
                const tradeVideoLink = document.getElementById('tradeVideoLink').value.trim();
                const referralLink = document.getElementById('referralLink').value.trim();
                
                if (accountOpenLink) formData.account_open_link = accountOpenLink;
                if (tradeVideoLink) formData.trade_video_link = tradeVideoLink;
                if (referralLink) formData.referral_link = referralLink;
                
                console.log('Sending campaign data:', formData);
                
                // Validation
                if (!formData.name) {
                    showNotification('Campaign name is required', 'error');
                    return;
                }
                
                if (!formData.campaign_type) {
                    showNotification('Campaign type is required', 'error');
                    return;
                }
                
                if (!payoutWithTrade || payoutWithTrade <= 0) {
                    showNotification('Reward amount must be greater than 0', 'error');
                    return;
                }
                
                try {
                    const { error } = await window.App.supabase
                        .from('campaigns')
                        .insert(formData);
                    
                    if (error) throw error;
                    
                    showNotification('Campaign added successfully! üéâ', 'success');
                    closeAddCampaignModal();
                    loadCampaignsTable();
                    loadDashboardData();
                    
                } catch (error) {
                    console.error('Error adding campaign:', error);
                    showNotification(`Error adding campaign: ${error.message}`, 'error');
                }
            });
        }
        
        // Campaign Management Functions
        let currentCampaignId = null;
        
        async function loadCampaignsTable() {
            try {
                const { data: campaigns, error } = await window.App.supabase
                    .from('campaigns')
                    .select('*')
                    .order('id', { ascending: false });
                
                if (error) throw error;
                
                const tableBody = document.getElementById('campaignsTable');
                tableBody.innerHTML = '';
                
                if (!campaigns || campaigns.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="py-8 text-center text-gray-500">
                                <i class="fas fa-bullhorn text-3xl mb-2"></i>
                                <div class="font-semibold">No campaigns found</div>
                                <div class="text-sm mt-1">Add your first campaign to get started</div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                campaigns.forEach(campaign => {
                    const statusColor = campaign.is_active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800';
                    const statusText = campaign.is_active ? 'Active' : 'Inactive';
                    const typeColor = campaign.campaign_type === 'trade' ? 'bg-orange-100 text-orange-800' : 
                                     campaign.campaign_type === 'account_open' ? 'bg-purple-100 text-purple-800' : 
                                     'bg-blue-100 text-blue-800';
                    
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="py-3 px-4 border-b border-gray-200">
                            <div class="font-medium text-gray-900">${campaign.name || 'Unnamed Campaign'}</div>
                            <div class="text-gray-500 text-sm">${(campaign.description || '').substring(0, 50)}${campaign.description && campaign.description.length > 50 ? '...' : ''}</div>
                        </td>
                        <td class="py-3 px-4 border-b border-gray-200">
                            <span class="px-2 py-1 text-xs rounded-full ${typeColor}">
                                ${campaign.campaign_type === 'trade' ? 'Trade' : campaign.campaign_type === 'account_open' ? 'Account Open' : 'Both'}
                            </span>
                        </td>
                        <td class="py-3 px-4 border-b border-gray-200 text-sm">
                            <div class="font-medium text-green-600">‚Çπ${(campaign.reward_amount || 0).toFixed(0)}</div>
                            <div class="text-gray-500">Base Reward</div>
                        </td>
                        <td class="py-3 px-4 border-b border-gray-200 text-xs">
                            ${renderCampaignLinks(campaign)}
                        </td>
                        <td class="py-3 px-4 border-b border-gray-200">
                            <span class="px-2 py-1 text-xs rounded-full ${statusColor}">${statusText}</span>
                        </td>
                        <td class="py-3 px-4 border-b border-gray-200 text-sm text-gray-600">
                            ${campaign.created_at ? new Date(campaign.created_at).toLocaleDateString() : 'N/A'}
                        </td>
                        <td class="py-3 px-4 border-b border-gray-200">
                            <div class="flex gap-1">
                                <button onclick="viewCampaignDetails('${campaign.id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="editCampaign('${campaign.id}')" class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs" title="Edit Campaign">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="toggleCampaignStatus('${campaign.id}', ${!campaign.is_active})" class="bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 rounded text-xs" title="${campaign.is_active ? 'Deactivate' : 'Activate'}">
                                    <i class="fas fa-toggle-${campaign.is_active ? 'off' : 'on'}"></i>
                                </button>
                                <button onclick="deleteCampaign('${campaign.id}')" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                
            } catch (error) {
                console.error('Error loading campaigns:', error);
                showNotification('Error loading campaigns', 'error');
                
                const tableBody = document.getElementById('campaignsTable');
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="py-8 text-center text-red-500">
                            <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                            <div class="font-semibold">Error loading campaigns</div>
                            <div class="text-sm mt-1">${error.message}</div>
                        </td>
                    </tr>
                `;
            }
        }
        
        function renderCampaignLinks(campaign) {
            let linksHtml = '';
            
            // Check for any link fields that might exist in database
            const possibleLinkFields = ['account_open_url', 'account_open_link', 'trade_video_url', 'trade_video_link', 'referral_url', 'referral_link'];
            
            possibleLinkFields.forEach(field => {
                if (campaign[field]) {
                    if (field.includes('account')) {
                        linksHtml += `<div><a href="${campaign[field]}" target="_blank" class="text-blue-600 hover:text-blue-800"><i class="fas fa-user-plus mr-1"></i>Account</a></div>`;
                    } else if (field.includes('video')) {
                        linksHtml += `<div><a href="${campaign[field]}" target="_blank" class="text-red-600 hover:text-red-800"><i class="fas fa-video mr-1"></i>Video</a></div>`;
                    } else if (field.includes('referral')) {
                        linksHtml += `<div><a href="${campaign[field]}" target="_blank" class="text-green-600 hover:text-green-800"><i class="fas fa-link mr-1"></i>Referral</a></div>`;
                    }
                }
            });
            
            return linksHtml || '<span class="text-gray-400">No links</span>';
        }
        
        function openAddCampaignModal() {
            document.getElementById('addCampaignModal').classList.remove('hidden');
        }
        
        function closeAddCampaignModal() {
            document.getElementById('addCampaignModal').classList.add('hidden');
            document.getElementById('addCampaignForm').reset();
        }
        
        function closeEditCampaignModal() {
            document.getElementById('editCampaignModal').classList.add('hidden');
            document.getElementById('editCampaignForm').reset();
            window.editingCampaignId = null;
        }
        
        async function viewCampaignDetails(campaignId) {
            try {
                currentCampaignId = campaignId;
                
                const { data: campaign, error } = await window.App.supabase
                    .from('campaigns')
                    .select('*')
                    .eq('id', campaignId)
                    .single();
                
                if (error) throw error;
                
                const content = document.getElementById('campaignDetailsContent');
                
                const detailsHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Campaign Name</label>
                                <div class="bg-gray-50 p-3 rounded-lg">
                                    <p class="font-medium text-gray-900">${campaign.name || 'Unnamed Campaign'}</p>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Campaign Type</label>
                                <div class="bg-gray-50 p-3 rounded-lg">
                                    <span class="px-3 py-1 text-sm rounded-full ${
                                        campaign.type === 'trade' ? 'bg-orange-100 text-orange-800' :
                                        campaign.type === 'account_open' ? 'bg-purple-100 text-purple-800' :
                                        'bg-blue-100 text-blue-800'
                                    }">
                                        ${campaign.type === 'trade' ? 'Trade Report' : campaign.type === 'account_open' ? 'Account Open Report' : 'Both Types'}
                                    </span>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                <div class="bg-gray-50 p-3 rounded-lg">
                                    <span class="px-3 py-1 text-sm rounded-full ${
                                        campaign.is_active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'
                                    }">
                                        ${campaign.is_active ? 'Active' : 'Inactive'}
                                    </span>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Created Date</label>
                                <div class="bg-gray-50 p-3 rounded-lg">
                                    <p class="text-gray-900">${new Date(campaign.created_at).toLocaleString()}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Payout Structure</label>
                                <div class="bg-gray-50 p-3 rounded-lg space-y-2">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">With Trade:</span>
                                        <span class="font-medium text-green-600">‚Çπ${(campaign.reward_with_trade || 0).toFixed(2)}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Without Trade:</span>
                                        <span class="font-medium text-blue-600">‚Çπ${(campaign.reward_without_trade || 0).toFixed(2)}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Campaign Links</label>
                                <div class="bg-gray-50 p-3 rounded-lg space-y-2">
                                    ${campaign.account_open_url ? `
                                        <div class="flex items-center gap-2">
                                            <i class="fas fa-user-plus text-blue-500"></i>
                                            <a href="${campaign.account_open_url}" target="_blank" class="text-blue-600 hover:text-blue-800 text-sm truncate">Account Open Link</a>
                                        </div>
                                    ` : ''}
                                    ${campaign.trade_video_url ? `
                                        <div class="flex items-center gap-2">
                                            <i class="fas fa-video text-red-500"></i>
                                            <a href="${campaign.trade_video_url}" target="_blank" class="text-red-600 hover:text-red-800 text-sm truncate">Trade Video Link</a>
                                        </div>
                                    ` : ''}
                                    ${campaign.referral_url ? `
                                        <div class="flex items-center gap-2">
                                            <i class="fas fa-link text-green-500"></i>
                                            <a href="${campaign.referral_url}" target="_blank" class="text-green-600 hover:text-green-800 text-sm truncate">Referral Link</a>
                                        </div>
                                    ` : ''}
                                    ${!campaign.account_open_url && !campaign.trade_video_url && !campaign.referral_url ? '<span class="text-gray-400 text-sm">No links provided</span>' : ''}
                                </div>
                            </div>
                            
                            ${campaign.image_url ? `
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Campaign Image</label>
                                    <div class="bg-gray-50 p-3 rounded-lg">
                                        <img src="${campaign.image_url}" alt="Campaign Image" class="w-full h-32 object-cover rounded border cursor-pointer" onclick="window.open('${campaign.image_url}', '_blank')">
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    ${campaign.description ? `
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Campaign Description</label>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <p class="text-gray-900 whitespace-pre-wrap">${campaign.description}</p>
                            </div>
                        </div>
                    ` : ''}
                `;
                
                content.innerHTML = detailsHTML;
                
                // Load existing admin notes
                document.getElementById('campaignAdminNotes').value = campaign.notes || '';
                
                document.getElementById('campaignDetailsModal').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error loading campaign details:', error);
                showNotification('Error loading campaign details', 'error');
            }
        }
        
        function closeCampaignDetailsModal() {
            document.getElementById('campaignDetailsModal').classList.add('hidden');
            currentCampaignId = null;
        }
        
        async function saveCampaignNotes() {
            if (!currentCampaignId) return;
            
            try {
                const notes = document.getElementById('campaignAdminNotes').value;
                
                const { error } = await window.App.supabase
                    .from('campaigns')
                    .update({ 
                        notes: notes
                    })
                    .eq('id', currentCampaignId);
                
                if (error) throw error;
                
                showNotification('Admin notes saved successfully', 'success');
                
            } catch (error) {
                console.error('Error saving campaign notes:', error);
                showNotification('Error saving notes', 'error');
            }
        }
        
        async function editCampaign(campaignId) {
            try {
                // Fetch campaign details
                const { data: campaign, error } = await window.App.supabase
                    .from('campaigns')
                    .select('*')
                    .eq('id', campaignId)
                    .single();
                
                if (error) throw error;
                
                console.log('Campaign data for edit:', campaign);
                
                // Populate edit form with existing data - use correct database column names
                const nameField = document.getElementById('editCampaignName');
                if (nameField) nameField.value = campaign.name || '';
                
                const typeField = document.getElementById('editCampaignType');
                if (typeField) typeField.value = campaign.campaign_type || 'account_open';
                
                const statusField = document.getElementById('editCampaignStatus');
                if (statusField) statusField.value = campaign.is_active ? 'active' : 'inactive';
                
                const accountLinkField = document.getElementById('editAccountOpenLink');
                if (accountLinkField) accountLinkField.value = campaign.account_open_link || campaign.account_open_url || '';
                
                const tradeLinkField = document.getElementById('editTradeVideoLink');
                if (tradeLinkField) tradeLinkField.value = campaign.trade_video_link || campaign.trade_video_url || '';
                
                const referralField = document.getElementById('editReferralLink');
                if (referralField) referralField.value = campaign.referral_link || campaign.referral_url || '';
                
                const imageField = document.getElementById('editCampaignImage');
                if (imageField) imageField.value = campaign.image_url || campaign.campaign_image || '';
                
                const rewardField = document.getElementById('editPayoutWithTrade');
                if (rewardField) rewardField.value = campaign.reward_amount || campaign.reward_with_trade || campaign.payout_with_trade || '';
                
                // Note: editPayoutWithoutTrade doesn't exist in the form, so we skip it
                
                const descField = document.getElementById('editCampaignDescription');
                if (descField) descField.value = campaign.description || '';
                
                const notesField = document.getElementById('editAdminNotes');
                if (notesField) notesField.value = campaign.notes || campaign.admin_notes || '';
                
                // Store campaign ID for update
                window.editingCampaignId = campaignId;
                
                // Show edit modal
                document.getElementById('editCampaignModal').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error loading campaign for edit:', error);
                showNotification('Error loading campaign details', 'error');
            }
        }
        
        async function toggleCampaignStatus(campaignId, newStatus) {
            try {
                const { error } = await window.App.supabase
                    .from('campaigns')
                    .update({ 
                        is_active: newStatus
                    })
                    .eq('id', campaignId);
                
                if (error) throw error;
                
                showNotification(`Campaign ${newStatus ? 'activated' : 'deactivated'} successfully`, 'success');
                loadCampaignsTable();
                loadDashboardData();
            } catch (error) {
                console.error('Error updating campaign status:', error);
                showNotification('Error updating campaign status', 'error');
            }
        }
        
        async function deleteCampaign(campaignId) {
            if (!confirm('Are you sure you want to delete this campaign? This action cannot be undone.')) {
                return;
            }
            
            try {
                const { error } = await window.App.supabase
                    .from('campaigns')
                    .delete()
                    .eq('id', campaignId);
                
                if (error) throw error;
                
                showNotification('Campaign deleted successfully', 'success');
                loadCampaignsTable();
                loadDashboardData();
            } catch (error) {
                console.error('Error deleting campaign:', error);
                showNotification('Error deleting campaign', 'error');
            }
        }
        
        // CSV Download Function
        async function downloadReportsCSV() {
            try {
                showNotification('üìä Preparing CSV download...', 'info');
                
                // Build query based on current filters
                let query = window.App.supabase
                    .from('reports')
                    .select(`
                        *,
                        profiles:user_id (
                            full_name,
                            email
                        )
                    `);
                
                // Apply filters if they exist
                const userFilter = document.getElementById('userFilter')?.value;
                const statusFilter = document.getElementById('statusFilter')?.value;
                const campaignFilter = document.getElementById('campaignFilter')?.value;
                const paymentFilter = document.getElementById('paymentFilter')?.value;
                const dateFilter = document.getElementById('submissionDateFilter')?.value;
                
                if (userFilter) {
                    query = query.eq('user_id', userFilter);
                    console.log('üìä Applied user filter:', userFilter);
                }
                
                if (statusFilter) {
                    query = query.eq('status', statusFilter);
                    console.log('üìä Applied status filter:', statusFilter);
                }
                
                if (campaignFilter) {
                    query = query.eq('campaign_id', campaignFilter);
                    console.log('üìä Applied campaign filter:', campaignFilter);
                }
                
                if (paymentFilter) {
                    query = query.eq('payment_status', paymentFilter);
                    console.log('üìä Applied payment filter:', paymentFilter);
                }
                
                if (dateFilter) {
                    const startDate = new Date(dateFilter);
                    const endDate = new Date(dateFilter);
                    endDate.setDate(endDate.getDate() + 1); // Include full day
                    
                    query = query.gte('created_at', startDate.toISOString())
                                 .lt('created_at', endDate.toISOString());
                    console.log('üìä Applied date filter:', dateFilter);
                }
                
                // Execute query
                const { data: reportsToDownload, error } = await query.order('created_at', { ascending: false });
                
                if (error) {
                    console.error('Error fetching reports for CSV:', error);
                    showNotification('‚ùå Error fetching reports data', 'error');
                    return;
                }
                
                if (!reportsToDownload || reportsToDownload.length === 0) {
                    showNotification('üìã No reports found to download', 'warning');
                    return;
                }
                
                // Fetch campaign names separately if needed
                let campaignMap = {};
                try {
                    const { data: campaigns } = await window.App.supabase
                        .from('campaigns')
                        .select('id, name');
                    
                    if (campaigns) {
                        campaigns.forEach(campaign => {
                            campaignMap[campaign.id] = campaign.name;
                        });
                    }
                } catch (campaignError) {
                    console.log('Could not fetch campaign names:', campaignError);
                }
                
                // Prepare clean CSV headers (only required fields)
                const headers = [
                    'User Name',
                    'User Email', 
                    'Customer Name',
                    'Customer Mobile',
                    'Report Type',
                    'Campaign Name',
                    'Status',
                    'Payment Status',
                    'Submission Date',
                    'User Notes'
                ];
                
                // Prepare clean CSV data
                const csvData = reportsToDownload.map(report => [
                    report.profiles?.full_name || report.user_name || 'Unknown',
                    report.profiles?.email || report.user_email || 'Unknown',
                    report.customer_name || '',
                    report.mobile_number || '',
                    getReportTypeLabel(report.report_type) || '',
                    campaignMap[report.campaign_id] || report.campaign_id || '',
                    getStatusLabel(report.status) || '',
                    getPaymentStatusLabel(report.payment_status) || '',
                    formatDateForCSV(report.created_at),
                    cleanNotesForCSV(report.notes) || ''
                ]);
                
                // Create CSV content with better escaping
                const csvContent = [
                    headers.join(','),
                    ...csvData.map(row => row.map(field => {
                        // Clean and escape field data
                        let cleanField = String(field || '').trim();
                        
                        // Remove any remaining problematic characters
                        cleanField = cleanField.replace(/[\r\n\t]/g, ' ');
                        cleanField = cleanField.replace(/\s+/g, ' ');
                        
                        // Escape quotes and wrap in quotes
                        return `"${cleanField.replace(/"/g, '""')}"`;
                    }).join(','))
                ].join('\n');
                
                // Create and download file
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `reports_${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    showNotification(`‚úÖ CSV downloaded successfully! (${reportsToDownload.length} reports)`, 'success');
                    console.log(`üìä CSV downloaded with ${reportsToDownload.length} reports`);
                } else {
                    showNotification('‚ùå CSV download not supported in this browser', 'error');
                }
                
            } catch (error) {
                console.error('Error downloading CSV:', error);
                showNotification('‚ùå Error downloading CSV file', 'error');
            }
        }
        
        // Helper functions for CSV formatting
        function getReportTypeLabel(type) {
            switch(type?.toLowerCase()) {
                case 'trade': return 'Trade Report';
                case 'account_open': return 'Account Open Report';
                default: return type || '';
            }
        }
        
        function getStatusLabel(status) {
            switch(status?.toLowerCase()) {
                case 'pending': return 'Pending';
                case 'approved': return 'Approved';
                case 'account open': return 'Account Open';
                case 'trade done': return 'Trade Done';
                case 'rejected': return 'Rejected';
                case 'not found': return 'Not Found';
                case 'under review': return 'Under Review';
                default: return status || '';
            }
        }
        
        function getPaymentStatusLabel(paymentStatus) {
            switch(paymentStatus?.toLowerCase()) {
                case 'paid': return 'Paid';
                case 'not_paid': 
                case 'unpaid': return 'Not Paid';
                case 'partial': return 'Partial Payment';
                case 'pending': return 'Payment Pending';
                default: return paymentStatus || 'Not Paid';
            }
        }
        
        // Helper function to clean notes for CSV
        function cleanNotesForCSV(notes) {
            if (!notes) return '';
            
            let cleanNotes = notes;
            
            // Remove all URLs (http, https, data URLs)
            cleanNotes = cleanNotes.replace(/https?:\/\/[^\s,\n\r]+/g, '');
            cleanNotes = cleanNotes.replace(/data:image\/[^,\s\n\r]+,[^\s,\n\r]+/g, '');
            
            // Remove common proof-related text patterns
            cleanNotes = cleanNotes.replace(/Payment\s*Proof\s*:/gi, '');
            cleanNotes = cleanNotes.replace(/Trade\s*Proof\s*:/gi, '');
            cleanNotes = cleanNotes.replace(/Proof\s*:/gi, '');
            cleanNotes = cleanNotes.replace(/Screenshot\s*:/gi, '');
            
            // Remove file extensions and encoded data
            cleanNotes = cleanNotes.replace(/\.(jpg|jpeg|png|gif|webp|pdf)[^\s]*/gi, '');
            cleanNotes = cleanNotes.replace(/%[0-9A-F]{2}/g, ''); // Remove URL encoding
            cleanNotes = cleanNotes.replace(/[A-Za-z0-9+\/]{20,}={0,2}/g, ''); // Remove base64-like strings
            
            // Remove special characters and clean up
            cleanNotes = cleanNotes.replace(/[^\w\s\u0900-\u097F.,!?()-]/g, ' '); // Keep only letters, numbers, spaces, Hindi chars, basic punctuation
            cleanNotes = cleanNotes.replace(/\s+/g, ' '); // Replace multiple spaces with single space
            cleanNotes = cleanNotes.trim();
            
            // If the cleaned note is too short or just numbers/symbols, return empty
            if (cleanNotes.length < 3 || /^[\d\s.,!?()-]+$/.test(cleanNotes)) {
                return '';
            }
            
            return cleanNotes;
        }
        
        // Helper function to format date for CSV
        function formatDateForCSV(dateString) {
            if (!dateString) return '';
            
            try {
                const date = new Date(dateString);
                return date.toLocaleString('en-IN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            } catch (error) {
                return dateString;
            }
        }
        
        // Date Range Filter Functions
        function toggleDateRangeFilter() {
            const panel = document.getElementById('dateRangePanel');
            if (panel.classList.contains('hidden')) {
                panel.classList.remove('hidden');
            } else {
                panel.classList.add('hidden');
            }
        }
        
        function closeDateRangeFilter() {
            const panel = document.getElementById('dateRangePanel');
            panel.classList.add('hidden');
        }
        
        function setDatePreset(preset) {
            const fromDate = document.getElementById('fromDateFilter');
            const toDate = document.getElementById('toDateFilter');
            const today = new Date();
            let startDate, endDate;
            
            switch(preset) {
                case 'today':
                    startDate = new Date(today);
                    endDate = new Date(today);
                    break;
                case 'yesterday':
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - 1);
                    endDate = new Date(startDate);
                    break;
                case 'thisWeek':
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - today.getDay());
                    endDate = new Date(today);
                    break;
                case 'lastWeek':
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - today.getDay() - 7);
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6);
                    break;
                case 'thisMonth':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = new Date(today);
                    break;
                case 'lastMonth':
                    startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    endDate = new Date(today.getFullYear(), today.getMonth(), 0);
                    break;
            }
            
            fromDate.value = startDate.toISOString().split('T')[0];
            toDate.value = endDate.toISOString().split('T')[0];
            
            updateDateRangeInfo();
        }
        
        function updateDateRangeInfo() {
            const fromDate = document.getElementById('fromDateFilter').value;
            const toDate = document.getElementById('toDateFilter').value;
            const infoElement = document.getElementById('dateRangeInfo');
            
            if (fromDate && toDate) {
                infoElement.textContent = `From ${fromDate} to ${toDate}`;
            } else if (fromDate) {
                infoElement.textContent = `From ${fromDate} onwards`;
            } else if (toDate) {
                infoElement.textContent = `Up to ${toDate}`;
            } else {
                infoElement.textContent = 'No date range selected';
            }
        }
        
        function applyDateRangeFilter() {
            const fromDate = document.getElementById('fromDateFilter').value;
            const toDate = document.getElementById('toDateFilter').value;
            const submissionDate = document.getElementById('submissionDateFilter').value;
            
            // Apply the date filters to the reports
            applyReportFilters();
            
            // Close the date range panel
            closeDateRangeFilter();
            
            showNotification('Date range filter applied successfully', 'success');
        }
        
        function clearDateRangeFilter() {
            document.getElementById('fromDateFilter').value = '';
            document.getElementById('toDateFilter').value = '';
            document.getElementById('submissionDateFilter').value = '';
            updateDateRangeInfo();
            
            // Reapply filters without date range
            applyReportFilters();
            
            showNotification('Date range filter cleared', 'success');
        }
        
        // Add event listeners for date inputs
        function initializeDateFilters() {
            const fromDate = document.getElementById('fromDateFilter');
            const toDate = document.getElementById('toDateFilter');
            
            if (fromDate) {
                fromDate.addEventListener('change', updateDateRangeInfo);
            }
            if (toDate) {
                toDate.addEventListener('change', updateDateRangeInfo);
            }
        }

        // Initialize earnings form when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listener for earnings form
            const earningsForm = document.getElementById('editEarningsForm');
            if (earningsForm) {
                earningsForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveUserEarnings();
                });
                console.log('‚úÖ Earnings form event listener added');
            }
            
            // Add event listener for admin notes form
            const adminNotesForm = document.getElementById('adminNotesForm');
            if (adminNotesForm) {
                adminNotesForm.addEventListener('submit', function(e) {
                    console.log('üìù Admin notes form submitted');
                    e.preventDefault();
                    const notes = document.getElementById('adminNotesTextarea').value.trim();
                    console.log('üìù Notes content:', notes);
                    console.log('üìù Current report ID:', currentNotesReportId);
                    
                    if (!notes) {
                        console.warn('‚ö†Ô∏è Empty notes, not saving');
                        showNotification('Please enter some notes before saving', 'error');
                        return;
                    }
                    
                    if (!currentNotesReportId) {
                        console.error('‚ùå No report ID set');
                        showNotification('Error: No report selected', 'error');
                        return;
                    }
                    
                    console.log('üöÄ Calling saveAdminNotes function...');
                    saveAdminNotes(notes);
                });
                console.log('‚úÖ Admin notes form event listener added');
            } else {
                console.error('‚ùå Admin notes form not found');
            }
            
            // Initialize date filters
            initializeDateFilters();
        });
    </script>

</body>
</html>