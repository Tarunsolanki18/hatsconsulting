<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel Error Fix Verification</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .check-item { border: 1px solid #e5e5e5; border-radius: 8px; padding: 16px; margin-bottom: 12px; }
        .check-pass { background-color: #f0fdf4; border-color: #22c55e; }
        .check-fail { background-color: #fef2f2; border-color: #ef4444; }
        .check-warning { background-color: #fffbeb; border-color: #f59e0b; }
    </style>
</head>
<body class="bg-gray-50 p-6">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-6">
                <i class="fas fa-tools mr-3 text-blue-600"></i>
                Admin Panel Error Fix Verification
            </h1>
            
            <div class="mb-6">
                <p class="text-gray-600">This tool verifies that all the recent JavaScript and template literal fixes have been applied correctly to resolve admin panel errors.</p>
            </div>

            <button onclick="runAllChecks()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors mb-6">
                <i class="fas fa-play mr-2"></i>Run All Checks
            </button>

            <div id="results" class="space-y-4">
                <!-- Results will be populated here -->
            </div>
        </div>
    </div>

    <script>
        async function runAllChecks() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-2xl text-blue-600"></i><p class="mt-2">Running checks...</p></div>';
            
            const checks = [
                checkAdminHtmlProofFunctions(),
                checkCampaignImageUrls(),
                checkTemplateLangualIssues(),
                checkGlobalErrorHandler(),
                checkConsoleErrors()
            ];
            
            const results = await Promise.all(checks);
            displayResults(results);
        }

        async function checkAdminHtmlProofFunctions() {
            try {
                const response = await fetch('./admin.html');
                const html = await response.text();
                
                // Check if the new DOM manipulation approach is present
                const hasNewImageModal = html.includes('const modalContent = document.createElement') && html.includes('modalContent.appendChild(header)');
                const hasNewPdfViewer = html.includes('newWindow.onload = function()') && html.includes('iframe.src = base64Data');
                const hasOldTemplateLiterals = html.includes('innerHTML = `') && html.includes('${base64Data}');
                
                if (hasNewImageModal && hasNewPdfViewer && !hasOldTemplateLiterals) {
                    return {
                        title: 'Admin.html Proof File Functions',
                        status: 'pass',
                        message: 'Template literal fixes applied correctly - using safe DOM manipulation'
                    };
                } else if (hasNewImageModal || hasNewPdfViewer) {
                    return {
                        title: 'Admin.html Proof File Functions',
                        status: 'warning',
                        message: 'Partial fix detected - some template literals may still exist'
                    };
                } else {
                    return {
                        title: 'Admin.html Proof File Functions',
                        status: 'fail',
                        message: 'Old template literal approach still present - fix not applied'
                    };
                }
            } catch (error) {
                return {
                    title: 'Admin.html Proof File Functions',
                    status: 'fail',
                    message: 'Could not read admin.html file: ' + error.message
                };
            }
        }

        async function checkCampaignImageUrls() {
            try {
                const adminResponse = await fetch('./admin.html');
                const adminHtml = await adminResponse.text();
                
                const campaignResponse = await fetch('./campaign.html');
                const campaignHtml = await campaignResponse.text();
                
                // Check for malformed ${campaign.image_url} references
                const hasMalformedUrls = adminHtml.includes('$%7Bcampaign.image_url%7D') || 
                                       campaignHtml.includes('$%7Bcampaign.image_url%7D');
                
                // Check for proper null checking
                const hasProperNullCheck = campaignHtml.includes('(campaign.image_url && campaign.image_url.trim())');
                const hasSafeImageHandling = adminHtml.includes('window.open(this.src');
                
                if (!hasMalformedUrls && hasProperNullCheck && hasSafeImageHandling) {
                    return {
                        title: 'Campaign Image URL References',
                        status: 'pass',
                        message: 'All image URL references are properly handled'
                    };
                } else {
                    return {
                        title: 'Campaign Image URL References',
                        status: 'fail',
                        message: 'Campaign image URL issues detected - check for malformed URLs'
                    };
                }
            } catch (error) {
                return {
                    title: 'Campaign Image URL References',
                    status: 'fail',
                    message: 'Could not verify image URL fixes: ' + error.message
                };
            }
        }

        async function checkTemplateLangualIssues() {
            try {
                const checkReportsResponse = await fetch('./check-reports.html');
                const checkReportsHtml = await checkReportsResponse.text();
                
                const adminResponse = await fetch('./admin.html');
                const adminHtml = await adminResponse.text();
                
                // Look for potential template literal issues with base64 data
                const hasRiskyBase64Templates = checkReportsHtml.includes('${base64Data.replace') || 
                                              adminHtml.includes('${base64Data.replace');
                
                // Check for safe DOM approaches
                const hasSafeProofViewing = checkReportsHtml.includes('downloadBtn.onclick = () => downloadProofFile(base64Data, fileName)') &&
                                           adminHtml.includes('downloadBtn.onclick = () => downloadProofFile(base64Data, fileName)');
                
                if (!hasRiskyBase64Templates && hasSafeProofViewing) {
                    return {
                        title: 'Template Literal Safety',
                        status: 'pass',
                        message: 'No risky template literals with base64 data found'
                    };
                } else {
                    return {
                        title: 'Template Literal Safety',
                        status: 'warning',
                        message: 'Some template literals with base64 data may still exist'
                    };
                }
            } catch (error) {
                return {
                    title: 'Template Literal Safety',
                    status: 'fail',
                    message: 'Could not verify template literal safety: ' + error.message
                };
            }
        }

        async function checkGlobalErrorHandler() {
            try {
                const adminResponse = await fetch('./admin.html');
                const adminHtml = await adminResponse.text();
                
                // Check for global error handler
                const hasGlobalErrorHandler = adminHtml.includes('window.addEventListener(\'error\'') ||
                                             adminHtml.includes('Global error caught:');
                
                if (hasGlobalErrorHandler) {
                    return {
                        title: 'Global Error Handler',
                        status: 'pass',
                        message: 'Global error handling is present'
                    };
                } else {
                    return {
                        title: 'Global Error Handler',
                        status: 'warning',
                        message: 'No global error handler detected - consider adding one'
                    };
                }
            } catch (error) {
                return {
                    title: 'Global Error Handler',
                    status: 'fail',
                    message: 'Could not check for error handler: ' + error.message
                };
            }
        }

        async function checkConsoleErrors() {
            // This checks for any current console errors
            const errors = [];
            
            // Override console.error temporarily to catch errors
            const originalError = console.error;
            console.error = function(...args) {
                errors.push(args.join(' '));
                originalError.apply(console, args);
            };
            
            // Wait a bit to see if any errors occur
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Restore original console.error
            console.error = originalError;
            
            if (errors.length === 0) {
                return {
                    title: 'Current Console Errors',
                    status: 'pass',
                    message: 'No console errors detected'
                };
            } else {
                return {
                    title: 'Current Console Errors',
                    status: 'fail',
                    message: `${errors.length} console error(s) detected: ${errors.slice(0,2).join(', ')}`
                };
            }
        }

        function displayResults(results) {
            const resultsDiv = document.getElementById('results');
            let html = '';
            let passCount = 0;
            let failCount = 0;
            let warningCount = 0;
            
            results.forEach(result => {
                const statusClass = result.status === 'pass' ? 'check-pass' : 
                                   result.status === 'fail' ? 'check-fail' : 'check-warning';
                const statusIcon = result.status === 'pass' ? 'fa-check-circle text-green-600' : 
                                  result.status === 'fail' ? 'fa-times-circle text-red-600' : 'fa-exclamation-triangle text-yellow-600';
                
                if (result.status === 'pass') passCount++;
                else if (result.status === 'fail') failCount++;
                else warningCount++;
                
                html += `
                    <div class="check-item ${statusClass}">
                        <div class="flex items-start justify-between">
                            <div class="flex items-start space-x-3">
                                <i class="fas ${statusIcon} text-xl mt-1"></i>
                                <div>
                                    <h3 class="font-semibold text-gray-900">${result.title}</h3>
                                    <p class="text-gray-600 text-sm mt-1">${result.message}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            // Add summary
            html = `
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <h2 class="text-lg font-semibold text-blue-900 mb-2">
                        <i class="fas fa-chart-bar mr-2"></i>Check Summary
                    </h2>
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div class="bg-green-100 rounded p-3">
                            <div class="text-2xl font-bold text-green-800">${passCount}</div>
                            <div class="text-sm text-green-700">Passed</div>
                        </div>
                        <div class="bg-yellow-100 rounded p-3">
                            <div class="text-2xl font-bold text-yellow-800">${warningCount}</div>
                            <div class="text-sm text-yellow-700">Warnings</div>
                        </div>
                        <div class="bg-red-100 rounded p-3">
                            <div class="text-2xl font-bold text-red-800">${failCount}</div>
                            <div class="text-sm text-red-700">Failed</div>
                        </div>
                    </div>
                </div>
            ` + html;
            
            // Add next steps if there are issues
            if (failCount > 0 || warningCount > 0) {
                html += `
                    <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 mt-6">
                        <h3 class="text-lg font-semibold text-orange-900 mb-2">
                            <i class="fas fa-wrench mr-2"></i>Next Steps
                        </h3>
                        <ul class="text-orange-800 text-sm space-y-1">
                            ${failCount > 0 ? '<li>• Address failed checks by applying the recommended fixes</li>' : ''}
                            ${warningCount > 0 ? '<li>• Review warning items for potential improvements</li>' : ''}
                            <li>• Test the admin panel functionality after applying fixes</li>
                            <li>• Check browser console for any remaining errors</li>
                        </ul>
                    </div>
                `;
            } else {
                html += `
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mt-6 text-center">
                        <i class="fas fa-check-circle text-green-600 text-3xl mb-2"></i>
                        <h3 class="text-lg font-semibold text-green-900">All Checks Passed!</h3>
                        <p class="text-green-700">Your admin panel fixes have been successfully applied.</p>
                    </div>
                `;
            }
            
            resultsDiv.innerHTML = html;
        }
    </script>
</body>
</html>