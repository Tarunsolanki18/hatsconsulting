<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Users Management - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="assets/config.js"></script>
    <script src="assets/app.js"></script>
    <script src="assets/security.js"></script>
    <script src="auth-fix.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <header class="bg-purple-600 text-white p-4">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <a href="admin.html" class="text-white hover:text-gray-200">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <h1 class="text-2xl font-bold">Users Management</h1>
            </div>
            <button onclick="logout()" class="bg-red-500 px-4 py-2 rounded">Logout</button>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <div class="bg-white rounded-lg shadow-md p-6">
            <!-- Search and Export Controls -->
            <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                <div class="w-full md:w-1/2 mb-4 md:mb-0">
                    <div class="relative">
                        <input id="search-input" type="text" placeholder="Search users by name or email..." 
                            class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <div class="absolute left-3 top-2.5 text-gray-400">
                            <i class="fas fa-search"></i>
                        </div>
                    </div>
                </div>
                <button id="export-csv" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center">
                    <i class="fas fa-file-export mr-2"></i> Export CSV
                </button>
            </div>
            
            <!-- Loading Indicator -->
            <div id="loading-indicator" class="flex justify-center items-center py-10">
                <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-purple-500"></div>
                <span class="ml-3 text-gray-600">Loading users...</span>
            </div>
            
            <!-- Users Table -->
            <div id="users-table" class="overflow-x-auto hidden">
                <table class="min-w-full bg-white">
                    <thead>
                        <tr class="bg-gray-100 text-gray-600 uppercase text-sm leading-normal">
                            <th class="py-3 px-6 text-left">User</th>
                            <th class="py-3 px-6 text-left">Email</th>
                            <th class="py-3 px-6 text-right">Today</th>
                            <th class="py-3 px-6 text-right">Week</th>
                            <th class="py-3 px-6 text-right">Total</th>
                            <th class="py-3 px-6 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body">
                        <!-- User rows will be inserted here -->
                    </tbody>
                </table>
                
                <!-- Pagination -->
                <div class="flex flex-col md:flex-row items-center justify-between mt-4 text-sm text-gray-600">
                    <div>
                        Showing <span id="pagination-start">0</span> to <span id="pagination-end">0</span> of <span id="pagination-total">0</span> users
                    </div>
                    <div class="flex mt-2 md:mt-0">
                        <button id="prev-page" class="px-3 py-1 rounded-md bg-gray-200 hover:bg-gray-300 mr-2 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas fa-chevron-left mr-1"></i> Previous
                        </button>
                        <button id="next-page" class="px-3 py-1 rounded-md bg-gray-200 hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">
                            Next <i class="fas fa-chevron-right ml-1"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Edit User Modal (Hidden by default) -->
    <div id="edit-user-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Edit User</h2>
                <button id="close-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="edit-user-form">
                <input type="hidden" id="edit-user-id">
                <div class="mb-4">
                    <label for="edit-user-name" class="block text-gray-700 font-medium mb-2">Name</label>
                    <input type="text" id="edit-user-name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div class="mb-4">
                    <label for="edit-today-earnings" class="block text-gray-700 font-medium mb-2">Today Earnings</label>
                    <input type="number" id="edit-today-earnings" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div class="mb-4">
                    <label for="edit-week-earnings" class="block text-gray-700 font-medium mb-2">Week Earnings</label>
                    <input type="number" id="edit-week-earnings" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div class="mb-4">
                    <label for="edit-total-earnings" class="block text-gray-700 font-medium mb-2">Total Earnings</label>
                    <input type="number" id="edit-total-earnings" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div class="flex justify-end">
                    <button type="button" id="cancel-edit" onclick="closeEditModal()" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-md mr-2">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-md">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Pagination variables
        let currentPage = 1;
        let usersPerPage = 10;
        let allUsers = [];
        let filteredUsers = [];
        
        // Initialize page and check authentication
        async function initPage() {
            try {
                const user = await App.requireAdmin();
                if (!user) {
                    window.location.href = 'login.html';
                    return;
                }
                
                // Set up search functionality
                document.getElementById('search-users').addEventListener('input', function() {
                    filterUsers(this.value);
                });
                
                // Set up pagination buttons
                document.getElementById('prev-page').addEventListener('click', () => {
                    if (currentPage > 1) {
                        currentPage--;
                        displayUsers(filteredUsers);
                    }
                });
                
                document.getElementById('next-page').addEventListener('click', () => {
                    const maxPage = Math.ceil(filteredUsers.length / usersPerPage);
                    if (currentPage < maxPage) {
                        currentPage++;
                        displayUsers(filteredUsers);
                    }
                });
                
                // Set up export functionality
                document.getElementById('export-csv').addEventListener('click', exportUsersToCSV);
                
                // Set up edit form submission
                document.getElementById('edit-user-form').addEventListener('submit', saveUserChanges);
                
                await loadUsers();
            } catch (error) {
                console.error('Error initializing admin page:', error);
                window.location.href = 'login.html';
            }
        }

        // Load all users from database with their earnings
        async function loadUsers() {
            try {
                document.getElementById('users-container').classList.remove('hidden');
                document.getElementById('users-table-body').innerHTML = '';
                
                // Get profiles and join with earnings
                const { data: profiles, error: profilesError } = await App.supabase
                    .from('profiles')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (profilesError) throw profilesError;
                
                // Get earnings for all users
                const { data: earnings, error: earningsError } = await App.supabase
                    .from('earnings')
                    .select('*');
                
                if (earningsError) throw earningsError;
                
                // Combine profiles with earnings
                allUsers = profiles.map(profile => {
                    const userEarnings = earnings.find(e => e.user_id === profile.id) || {
                        today: 0,
                        week: 0,
                        total: 0,
                        pending_adjustments: 0
                    };
                    
                    return {
                        ...profile,
                        earnings: userEarnings
                    };
                });
                
                filteredUsers = [...allUsers];
                displayUsers(filteredUsers);
                document.getElementById('users-container').classList.add('hidden');
            } catch (error) {
                console.error('Error loading users:', error);
                alert('Error loading users: ' + error.message);
            }
        }
        
        // Filter users based on search term
        function filterUsers(searchTerm) {
            searchTerm = searchTerm.toLowerCase();
            filteredUsers = allUsers.filter(user => 
                (user.full_name && user.full_name.toLowerCase().includes(searchTerm)) || 
                (user.email && user.email.toLowerCase().includes(searchTerm))
            );
            currentPage = 1;
            displayUsers(filteredUsers);
        }
        
        // Display users with pagination
        function displayUsers(users) {
            const tableBody = document.getElementById('users-table-body');
            tableBody.innerHTML = '';
            
            const start = (currentPage - 1) * usersPerPage;
            const end = Math.min(start + usersPerPage, users.length);
            const paginatedUsers = users.slice(start, end);
            
            if (paginatedUsers.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="py-4 text-center text-gray-500">No users found</td>
                    </tr>
                `;
            } else {
                paginatedUsers.forEach(user => {
                    const isDeleted = user.is_deleted;
                    const row = document.createElement('tr');
                    row.className = isDeleted ? 'bg-red-50' : 'border-b border-gray-200 hover:bg-gray-50';
                    
                    row.innerHTML = `
                        <td class="py-3 px-6 text-left">
                            <div class="flex items-center">
                                <div class="mr-2">
                                    <img class="w-8 h-8 rounded-full" src="${user.photo_url || 'https://via.placeholder.com/40'}" alt="User Avatar">
                                </div>
                                <span class="${isDeleted ? 'line-through text-gray-400' : ''}">${user.full_name || 'Unnamed User'}</span>
                                ${isDeleted ? '<span class="ml-2 text-xs bg-red-100 text-red-800 px-2 py-1 rounded">Deleted</span>' : ''}
                            </div>
                        </td>
                        <td class="py-3 px-6 text-left">${user.email || 'No email'}</td>
                        <td class="py-3 px-6 text-right">₹${user.earnings?.today || 0}</td>
                        <td class="py-3 px-6 text-right">₹${user.earnings?.week || 0}</td>
                        <td class="py-3 px-6 text-right">₹${user.earnings?.total || 0}</td>
                        <td class="py-3 px-6 text-center">
                            <div class="flex item-center justify-center space-x-2">
                                <button onclick="openEditModal('${user.id}')" class="transform hover:text-purple-500 hover:scale-110 transition-all" title="Edit User">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="adjustEarnings('${user.id}')" class="transform hover:text-green-500 hover:scale-110 transition-all" title="Adjust Earnings">
                                    <i class="fas fa-dollar-sign"></i>
                                </button>
                                ${!isDeleted ? 
                                    `<button onclick="deleteUser('${user.id}')" class="transform hover:text-red-500 hover:scale-110 transition-all" title="Delete User">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>` : 
                                    `<button onclick="hardDeleteUser('${user.id}')" class="transform hover:text-red-700 hover:scale-110 transition-all" title="Hard Delete User">
                                        <i class="fas fa-skull-crossbones"></i>
                                    </button>`
                                }
                            </div>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
            }
            
            // Update pagination info
            document.getElementById('pagination-start').textContent = users.length > 0 ? start + 1 : 0;
            document.getElementById('pagination-end').textContent = end;
            document.getElementById('pagination-total').textContent = users.length;
            
            // Update pagination buttons
            document.getElementById('prev-page').disabled = currentPage === 1;
            document.getElementById('next-page').disabled = end >= users.length;
        }
        
        // Open edit user modal
        async function openEditModal(userId) {
            try {
                const user = allUsers.find(u => u.id === userId);
                if (!user) throw new Error('User not found');
                
                document.getElementById('edit-user-id').value = user.id;
                document.getElementById('edit-user-name').value = user.full_name || '';
                document.getElementById('edit-today-earnings').value = user.earnings?.today || 0;
                document.getElementById('edit-week-earnings').value = user.earnings?.week || 0;
                document.getElementById('edit-total-earnings').value = user.earnings?.total || 0;
                
                document.getElementById('edit-user-modal').classList.remove('hidden');
                document.getElementById('edit-user-modal').classList.add('flex');
            } catch (error) {
                console.error('Error opening edit modal:', error);
                alert('Error opening edit modal: ' + error.message);
            }
        }
        
        // Close edit user modal
        function closeEditModal() {
            document.getElementById('edit-user-modal').classList.remove('flex');
            document.getElementById('edit-user-modal').classList.add('hidden');
        }

        // Display users in the UI
        function displayUsers(users) {
            const container = document.getElementById('users-container');
            
            if (users.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-users text-4xl text-gray-400 mb-4"></i>
                        <p class="text-gray-600">No users found</p>
                    </div>
                `;
                return;
            }

            const usersHtml = users.map(user => `
                <div class="border border-gray-200 rounded-lg p-4 mb-4 hover:shadow-lg transition-all">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-lg font-bold">${user.full_name || 'Unnamed User'}</h3>
                            <p class="text-gray-600">${user.email || 'No email'}</p>
                            <p class="text-sm text-gray-500">Joined: ${new Date(user.created_at).toLocaleDateString()}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="editUser('${user.id}')" class="text-blue-600 hover:text-blue-800">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteUser('${user.id}')" class="text-red-600 hover:text-red-800">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <span class="text-sm font-medium">Today's Earnings:</span>
                            <span class="ml-2">₹${user.today_earnings || 0}</span>
                        </div>
                        <div>
                            <span class="text-sm font-medium">Weekly Earnings:</span>
                            <span class="ml-2">₹${user.weekly_earnings || 0}</span>
                        </div>
                        <div>
                            <span class="text-sm font-medium">Total Earnings:</span>
                            <span class="ml-2">₹${user.total_earnings || 0}</span>
                        </div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = usersHtml;
        }

        // Edit user
        function editUser(userId) {
            // Fetch user details and populate form
            App.supabase
                .from('profiles')
                .select('*')
                .eq('id', userId)
                .single()
                .then(({ data, error }) => {
                    if (error) {
                        alert('Error fetching user data: ' + error.message);
                        return;
                    }
                    
                    document.getElementById('edit-user-id').value = userId;
                    document.getElementById('edit-user-name').value = data.full_name || '';
                    document.getElementById('edit-today-earnings').value = data.today_earnings || 0;
                    document.getElementById('edit-week-earnings').value = data.weekly_earnings || 0;
                    document.getElementById('edit-total-earnings').value = data.total_earnings || 0;
                    
                    document.getElementById('edit-user-modal').classList.remove('hidden');
                    document.getElementById('edit-user-modal').classList.add('flex');
                });
        }

        function closeEditModal() {
            document.getElementById('edit-user-modal').classList.add('hidden');
            document.getElementById('edit-user-modal').classList.remove('flex');
        }

        // Delete user
        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user?')) return;

            try {
                const { error } = await App.supabase
                    .from('profiles')
                    .delete()
                    .eq('id', userId);
                
                if (error) throw error;
                
                alert('User deleted successfully!');
                await loadUsers();
            } catch (error) {
                alert('Error deleting user: ' + error.message);
            }
        }

        // Handle edit user form submission
        document.getElementById('edit-user-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const userId = document.getElementById('edit-user-id').value;
            const userData = {
                full_name: document.getElementById('edit-user-name').value,
                today_earnings: parseFloat(document.getElementById('edit-today-earnings').value) || 0,
                weekly_earnings: parseFloat(document.getElementById('edit-week-earnings').value) || 0,
                total_earnings: parseFloat(document.getElementById('edit-total-earnings').value) || 0,
                updated_at: new Date()
            };

            try {
                const { error } = await App.supabase
                    .from('profiles')
                    .update(userData)
                    .eq('id', userId);
                
                if (error) throw error;
                
                alert('User updated successfully!');
                closeEditModal();
                await loadUsers();
            } catch (error) {
                alert('Error updating user: ' + error.message);
            }
        });

        // Logout function
        function logout() {
            localStorage.clear();
            sessionStorage.clear();
            window.location.href = 'login.html?logout=true';
        }

        // Initialize page when DOM is loaded
        document.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>
