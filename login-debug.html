<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Debug - HATS Consulting</title>
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè¢</text></svg>">
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>
    <style>
        .debug-panel {
            background: #1f2937;
            color: #f9fafb;
            font-family: monospace;
            font-size: 12px;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0.5rem;
            max-height: 300px;
            overflow-y: auto;
        }
        .debug-success { color: #10b981; }
        .debug-error { color: #ef4444; }
        .debug-warning { color: #f59e0b; }
        .debug-info { color: #3b82f6; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">Login System Debug Panel</h1>
        
        <!-- Debug Console -->
        <div class="debug-panel" id="debugConsole">
            <div class="debug-info">üîç Debug Console Initialized</div>
        </div>
        
        <!-- Configuration Test -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-xl font-semibold mb-4">Configuration Test</h2>
            <button onclick="testConfig()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Test Config</button>
            <div id="configResults" class="mt-4"></div>
        </div>
        
        <!-- Supabase Connection Test -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-xl font-semibold mb-4">Supabase Connection Test</h2>
            <button onclick="testSupabaseConnection()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Test Connection</button>
            <div id="supabaseResults" class="mt-4"></div>
        </div>
        
        <!-- Login Test -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-xl font-semibold mb-4">Login Test</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Email</label>
                    <input type="email" id="testEmail" class="w-full p-2 border rounded" placeholder="Enter test email">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Password</label>
                    <input type="password" id="testPassword" class="w-full p-2 border rounded" placeholder="Enter test password">
                </div>
            </div>
            <div class="mt-4">
                <label class="block text-sm font-medium mb-2">Security Code (for non-admins)</label>
                <input type="text" id="testSecurityCode" class="w-full p-2 border rounded" placeholder="Enter security code">
            </div>
            <div class="mt-4 space-x-2">
                <button onclick="testLogin()" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">Test Login</button>
                <button onclick="testAdminLogin()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">Test Admin Login</button>
            </div>
            <div id="loginResults" class="mt-4"></div>
        </div>
        
        <!-- Database Test -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-xl font-semibold mb-4">Database Test</h2>
            <button onclick="testDatabase()" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">Test Database</button>
            <div id="databaseResults" class="mt-4"></div>
        </div>
        
        <!-- Quick Actions -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4">Quick Actions</h2>
            <div class="space-x-2">
                <a href="login.html" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 inline-block">Go to Login Page</a>
                <a href="admin.html" class="bg-indigo-500 text-white px-4 py-2 rounded hover:bg-indigo-600 inline-block">Go to Admin Panel</a>
                <button onclick="clearStorage()" class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600">Clear Storage</button>
            </div>
        </div>
    </div>

    <!-- Load Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
    <script src="./assets/config.js"></script>
    <script src="./assets/app.js"></script>
    
    <script>
        let debugConsole = document.getElementById('debugConsole');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = `debug-${type}`;
            const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            debugConsole.innerHTML += `<div class="${className}">[${timestamp}] ${icon} ${message}</div>`;
            debugConsole.scrollTop = debugConsole.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function clearResults(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }
        
        function showResults(elementId, content, isError = false) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="p-3 rounded ${isError ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">${content}</div>`;
        }
        
        async function testConfig() {
            log('Testing configuration...', 'info');
            clearResults('configResults');
            
            try {
                if (!window.APP_CONFIG) {
                    throw new Error('APP_CONFIG not loaded');
                }
                
                const config = window.APP_CONFIG;
                let results = '<h3 class="font-semibold mb-2">Configuration Status:</h3><ul class="space-y-1">';
                
                results += `<li>‚úÖ SUPABASE_URL: ${config.SUPABASE_URL ? 'Present' : 'Missing'}</li>`;
                results += `<li>‚úÖ SUPABASE_ANON_KEY: ${config.SUPABASE_ANON_KEY ? 'Present' : 'Missing'}</li>`;
                results += `<li>‚úÖ ADMIN_EMAILS: ${config.ADMIN_EMAILS?.length || 0} emails</li>`;
                results += `<li>‚úÖ SECURITY_CODES: ${config.SECURITY_CODES?.length || 0} codes</li>`;
                results += '</ul>';
                
                showResults('configResults', results);
                log('Configuration test completed successfully', 'success');
                
            } catch (error) {
                const errorMsg = `Configuration test failed: ${error.message}`;
                showResults('configResults', errorMsg, true);
                log(errorMsg, 'error');
            }
        }
        
        async function testSupabaseConnection() {
            log('Testing Supabase connection...', 'info');
            clearResults('supabaseResults');
            
            try {
                if (!window.supabase) {
                    throw new Error('Supabase library not loaded');
                }
                
                if (!window.App) {
                    throw new Error('App not loaded');
                }
                
                // Test basic connection
                const { data, error } = await window.App.supabase.auth.getSession();
                
                let results = '<h3 class="font-semibold mb-2">Supabase Connection Status:</h3><ul class="space-y-1">';
                results += `<li>‚úÖ Supabase Client: Initialized</li>`;
                results += `<li>‚úÖ Auth Service: ${error ? 'Error - ' + error.message : 'Working'}</li>`;
                results += `<li>‚úÖ Current Session: ${data?.session ? 'Active' : 'None'}</li>`;
                results += '</ul>';
                
                showResults('supabaseResults', results);
                log('Supabase connection test completed', 'success');
                
            } catch (error) {
                const errorMsg = `Supabase connection failed: ${error.message}`;
                showResults('supabaseResults', errorMsg, true);
                log(errorMsg, 'error');
            }
        }
        
        async function testLogin() {
            const email = document.getElementById('testEmail').value.trim();
            const password = document.getElementById('testPassword').value;
            const securityCode = document.getElementById('testSecurityCode').value.trim();
            
            if (!email || !password) {
                alert('Please enter email and password');
                return;
            }
            
            log(`Testing login for: ${email}`, 'info');
            clearResults('loginResults');
            
            try {
                // Test login
                const { data, error } = await window.App.signInWithEmail(email, password);
                
                if (error) {
                    throw error;
                }
                
                const session = await window.App.getSession();
                const user = session?.user;
                
                if (!user) {
                    throw new Error('No user session after login');
                }
                
                let results = '<h3 class="font-semibold mb-2">Login Test Results:</h3><ul class="space-y-1">';
                results += `<li>‚úÖ Login: Successful</li>`;
                results += `<li>‚úÖ User ID: ${user.id}</li>`;
                results += `<li>‚úÖ Email: ${user.email}</li>`;
                results += `<li>‚úÖ Is Admin: ${window.App.isAdmin(user) ? 'Yes' : 'No'}</li>`;
                
                // Test security code if not admin
                if (!window.App.isAdmin(user) && securityCode) {
                    const { error: codeError } = await window.App.approveSelfWithCode(user.id, securityCode);
                    results += `<li>‚úÖ Security Code: ${codeError ? 'Invalid - ' + codeError.message : 'Valid'}</li>`;
                }
                
                results += '</ul>';
                
                showResults('loginResults', results);
                log('Login test completed successfully', 'success');
                
            } catch (error) {
                const errorMsg = `Login test failed: ${error.message}`;
                showResults('loginResults', errorMsg, true);
                log(errorMsg, 'error');
            }
        }
        
        async function testAdminLogin() {
            log('Testing admin login with configured admin email...', 'info');
            
            if (!window.APP_CONFIG?.ADMIN_EMAILS?.length) {
                log('No admin emails configured', 'error');
                return;
            }
            
            const adminEmail = window.APP_CONFIG.ADMIN_EMAILS[0];
            document.getElementById('testEmail').value = adminEmail;
            
            log(`Set admin email: ${adminEmail}`, 'info');
            alert(`Admin email set to: ${adminEmail}\nPlease enter the password and click "Test Login"`);
        }
        
        async function testDatabase() {
            log('Testing database connectivity...', 'info');
            clearResults('databaseResults');
            
            try {
                // Test profiles table
                const { data: profiles, error: profilesError } = await window.App.supabase
                    .from('profiles')
                    .select('count')
                    .limit(1);
                
                // Test campaigns table
                const { data: campaigns, error: campaignsError } = await window.App.supabase
                    .from('campaigns')
                    .select('count')
                    .limit(1);
                
                // Test reports table
                const { data: reports, error: reportsError } = await window.App.supabase
                    .from('reports')
                    .select('count')
                    .limit(1);
                
                let results = '<h3 class="font-semibold mb-2">Database Test Results:</h3><ul class="space-y-1">';
                results += `<li>${profilesError ? '‚ùå' : '‚úÖ'} Profiles Table: ${profilesError ? profilesError.message : 'Accessible'}</li>`;
                results += `<li>${campaignsError ? '‚ùå' : '‚úÖ'} Campaigns Table: ${campaignsError ? campaignsError.message : 'Accessible'}</li>`;
                results += `<li>${reportsError ? '‚ùå' : '‚úÖ'} Reports Table: ${reportsError ? reportsError.message : 'Accessible'}</li>`;
                results += '</ul>';
                
                showResults('databaseResults', results);
                log('Database test completed', 'success');
                
            } catch (error) {
                const errorMsg = `Database test failed: ${error.message}`;
                showResults('databaseResults', errorMsg, true);
                log(errorMsg, 'error');
            }
        }
        
        function clearStorage() {
            localStorage.clear();
            sessionStorage.clear();
            log('Storage cleared', 'success');
            alert('Storage cleared successfully');
        }
        
        // Initialize tests on page load
        window.addEventListener('load', function() {
            log('Debug panel loaded', 'success');
            setTimeout(() => {
                testConfig();
                testSupabaseConnection();
            }, 1000);
        });
    </script>
</body>
</html>
