<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- CSP Temporarily Disabled for Testing -->
    <!-- <meta http-equiv="Content-Security-Policy" content="..."> -->
    <title>Dashboard - HATS Consulting</title>
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè¢</text></svg>">
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@600;700&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        // Check if Supabase is loaded
        if (!window.supabase) {
            console.error('Supabase not loaded!');
            document.body.innerHTML = `
                <div style="font-family: Arial, sans-serif; padding: 40px; text-align: center;">
                    <h1>Error Loading Application</h1>
                    <p>Failed to load required resources. Please check your internet connection and refresh the page.</p>
                    <p>If the problem persists, please contact support.</p>
                    <button onclick="window.location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #4F46E5; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Refresh Page
                    </button>
                </div>
            `;
            throw new Error('Supabase not loaded');
        }
    </script>
    <script src="assets/config.js"></script>
    <script>
        // Create global App object that will be populated by app.js
        window.App = window.App || {};
        
        // Check if config is loaded
        if (!window.APP_CONFIG) {
            console.error('Configuration not loaded!');
            throw new Error('Configuration not loaded');
        }
    </script>
    <script src="assets/app.js"></script>
    <script src="assets/security.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif'],
                        'jakarta': ['"Plus Jakarta Sans"', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#8B5CF6',
                        'accent': '#E11D48',
                        'accent-hover': '#F43F5E',
                        'light-bg': '#F8FAFC',
                        'text-dark': '#0F172A',
                        'text-medium': '#334155',
                        'text-light': '#FFFFFF',
                    }
                }
            }
        }
    </script>
    <style>
        .counter-animation {
            animation: countUp 2s ease-out forwards;
        }
        @keyframes countUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .counter-animation {
            animation: countUp 2s ease-out forwards;
        }
        
        .fade-in {
            animation: fadeInUp 0.6s ease-out forwards;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
    </style>
</head>
<body class="font-inter bg-light-bg min-h-screen">
    <!-- Header -->
    <header class="bg-primary shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center">
                        <i class="fas fa-rocket text-primary text-xl"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-white font-jakarta">HATS Consulting</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-white text-sm">
                        <span id="user-name">Loading...</span>
                    </div>
                    <button onclick="logout()" class="bg-accent text-white px-4 py-2 rounded-lg hover:bg-accent-hover transition-colors">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Loading Indicator -->
    <div id="loading-indicator" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
        <div class="text-center">
            <div class="w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-text-medium">Loading dashboard...</p>
        </div>
    </div>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Profile Section -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
            <div class="flex items-center space-x-6">
                <div class="relative">
                    <div id="profile-photo" class="w-20 h-20 rounded-full border-4 border-primary bg-gradient-to-br from-primary to-purple-600 flex items-center justify-center cursor-pointer hover:opacity-80 transition-opacity">
                        <i class="fas fa-user text-white text-2xl"></i>
                    </div>
                    <input type="file" id="photo-upload" accept="image/*" class="hidden" onchange="uploadProfilePhoto()">
                    <div class="absolute -bottom-2 -right-2 bg-primary text-white rounded-full p-2 cursor-pointer hover:bg-purple-600 transition-colors" onclick="document.getElementById('photo-upload').click()">
                        <i class="fas fa-camera text-sm"></i>
                    </div>
                </div>
                                <div class="flex-1">
                    <div class="flex items-center space-x-2">
                        <h2 id="user-full-name" class="text-2xl font-bold text-text-dark font-jakarta">Loading...</h2>
                        <button id="update-name-btn" class="text-accent hover:text-accent-hover transition-colors" title="Update name">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                        </button>
                    </div>
                    <p class="text-primary font-semibold text-lg">100% Zero Investment Online Platform</p>
                    <p class="text-text-medium">Welcome to your dashboard</p>
                </div>
            </div>
        </div>

        <!-- Earnings Section (Initially Hidden) -->
        <div id="earnings-section" class="bg-gradient-to-r from-primary to-purple-600 rounded-2xl shadow-lg p-6 mb-8 text-white hidden">
            <h3 class="text-xl font-bold font-jakarta mb-4">Your Earnings</h3>
            <div class="space-y-6">
                <!-- Today Earnings -->
                <div class="bg-white/10 rounded-xl p-4 text-center">
                    <div class="text-3xl md:text-4xl font-bold counter-animation" id="today-earnings">‚Çπ0</div>
                    <div class="text-purple-200 text-lg font-medium mt-1">Today's Earnings</div>
                </div>
                
                <!-- This Week Earnings -->
                <div class="bg-white/10 rounded-xl p-4 text-center">
                    <div class="text-3xl md:text-4xl font-bold counter-animation" id="week-earnings">‚Çπ0</div>
                    <div class="text-purple-200 text-lg font-medium mt-1">This Week</div>
                </div>
                
                <!-- This Month Earnings -->
                <div class="bg-white/10 rounded-xl p-4 text-center">
                    <div class="text-3xl md:text-4xl font-bold counter-animation" id="month-earnings">‚Çπ0</div>
                    <div class="text-purple-200 text-lg font-medium mt-1">This Month</div>
                </div>
                
                <!-- All Time Earnings -->
                <div class="bg-white/10 rounded-xl p-4 text-center border-2 border-white/20">
                    <div class="text-4xl md:text-5xl font-bold counter-animation" id="total-earnings">‚Çπ0</div>
                    <div class="text-purple-200 text-xl font-medium mt-1">All Time Earnings</div>
                </div>
            </div>
        </div>

        <!-- Main Cards -->
        <div id="main-cards" class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Dashboard Card -->
            <div class="bg-white rounded-2xl shadow-lg p-6 card-hover cursor-pointer" onclick="showDashboard()">
                <div class="flex items-center space-x-4">
                    <div class="w-16 h-16 bg-primary/10 rounded-2xl flex items-center justify-center">
                        <i class="fas fa-tachometer-alt text-primary text-2xl"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-text-dark font-jakarta">Dashboard</h3>
                        <p class="text-text-medium">View your performance and stats</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-lg p-6 card-hover cursor-pointer" onclick="showSubmitWork()">
                <div class="flex items-center space-x-4">
                    <div class="w-16 h-16 bg-green-100 rounded-2xl flex items-center justify-center">
                        <i class="fas fa-upload text-green-600 text-2xl"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-text-dark font-jakarta">Submit Work Report</h3>
                        <p class="text-text-medium">Submit your completed work</p>
                    </div>
                </div>
            </div>


            <!-- Check Reports Card -->
            <div class="bg-white rounded-2xl shadow-lg p-6 card-hover cursor-pointer" onclick="showMyReports()">
                <div class="flex items-center space-x-4">
                    <div class="w-16 h-16 bg-blue-100 rounded-2xl flex items-center justify-center">
                        <i class="fas fa-file-alt text-blue-600 text-2xl"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-text-dark font-jakarta">Check Reports</h3>
                        <p class="text-text-medium">View your submitted reports</p>
                    </div>
                </div>
            </div>

            <!-- Live Campaign Card -->
            <div class="bg-white rounded-2xl shadow-lg p-6 card-hover cursor-pointer" onclick="showLiveCampaigns()">
                <div class="flex items-center space-x-4">
                    <div class="w-16 h-16 bg-orange-100 rounded-2xl flex items-center justify-center">
                        <i class="fas fa-bullhorn text-orange-600 text-2xl"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-text-dark font-jakarta">Live Campaign</h3>
                        <p class="text-text-medium">View active campaigns</p>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <script>
        let currentUser = null;
        let userEarnings = null;

        // Initialize dashboard
        async function initDashboard() {
            try {
                // Check if user is authenticated
                const session = await App.getSession();
                if (!session) {
                    window.location.href = 'login.html';
                    return;
                }
                
                // Get current user from session
                currentUser = session.user;
                
                // Load user profile first
                console.log('üîç Fetching user profile from database...');
                const { data: profile, error: profileError } = await App.supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();
                    
                console.log('Profile fetch result:', { profile, profileError });
                
                if (profileError && profileError.code !== 'PGRST116') {
                    console.error('‚ùå Error fetching profile:', profileError);
                }
                    
                // If no profile exists, create one with user data
                if (!profile) {
                    const fullName = currentUser.user_metadata?.full_name || 
                                   currentUser.user_metadata?.fullname || 
                                   currentUser.email.split('@')[0];
                    
                    console.log('üìù Creating new profile with data:', {
                        id: currentUser.id,
                        email: currentUser.email,
                        full_name: fullName,
                        status: 'active',
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    });
                    
                    const { data: newProfile, error: profileError } = await App.supabase
                        .from('profiles')
                        .upsert({
                            id: currentUser.id,
                            email: currentUser.email,
                            full_name: fullName,
                            status: 'active',
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        })
                        .select()
                        .single();
                    
                    console.log('Profile creation result:', { newProfile, profileError });
                    
                    if (profileError) {
                        console.error('‚ùå Error creating user profile:', profileError);
                    }
                    
                    // Reload the profile after creation
                    const { data: reloadedProfile } = await App.supabase
                        .from('profiles')
                        .select('*')
                        .eq('id', currentUser.id)
                        .single();
                    
                    console.log('Reloaded profile after creation:', reloadedProfile);
                    
                    // Update profile reference
                    if (reloadedProfile) {
                        profile = reloadedProfile;
                        console.log('‚úÖ Profile loaded after creation');
                    }
                }
                
                // Update last login time
                await App.supabase
                    .from('profiles')
                    .update({ 
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', currentUser.id);

                // Enhanced name resolution with detailed logging and fallbacks
                console.group('üîç Name Resolution');
                
                // Log all available name sources
                console.log('Available name sources:', {
                    'profile.full_name': profile?.full_name,
                    'user_metadata.full_name': currentUser.user_metadata?.full_name,
                    'user_metadata.fullname': currentUser.user_metadata?.fullname,
                    'localStorage.user_full_name': localStorage.getItem('user_full_name'),
                    'email_username': currentUser.email?.split('@')[0]
                });
                
                let displayName = 'User';
                let nameSource = 'default';
                
                // 1. Check profile.full_name first (most reliable - from database)
                if (profile?.full_name?.trim()) {
                    displayName = profile.full_name.trim();
                    nameSource = 'profile.full_name';
                    console.log('‚úÖ Using name from database profile.full_name:', displayName);
                } 
                // 2. Check user_metadata.full_name (from auth)
                else if (currentUser.user_metadata?.full_name?.trim()) {
                    displayName = currentUser.user_metadata.full_name.trim();
                    nameSource = 'user_metadata.full_name';
                    console.log('‚ÑπÔ∏è Using name from user_metadata.full_name:', displayName);
                    
                    // Sync metadata name to database
                    try {
                        await App.supabase
                            .from('profiles')
                            .update({ 
                                full_name: displayName,
                                updated_at: new Date().toISOString() 
                            })
                            .eq('id', currentUser.id);
                        console.log('‚úÖ Synced metadata name to database');
                        
                        // Verify sync worked
                        const { data: verifyProfile } = await App.supabase
                            .from('profiles')
                            .select('full_name')
                            .eq('id', currentUser.id)
                            .single();
                        
                        if (verifyProfile?.full_name === displayName) {
                            console.log('‚úÖ Metadata sync verified');
                        } else {
                            console.warn('‚ö†Ô∏è Metadata sync may have failed verification');
                        }
                    } catch (updateError) {
                        console.warn('‚ö†Ô∏è Could not sync metadata name to database:', updateError);
                    }
                }
                // 3. Check user_metadata.fullname (lowercase version)
                else if (currentUser.user_metadata?.fullname?.trim()) {
                    displayName = currentUser.user_metadata.fullname.trim();
                    nameSource = 'user_metadata.fullname';
                    console.log('‚ÑπÔ∏è Using name from user_metadata.fullname:', displayName);
                    
                    // Sync metadata name to database
                    try {
                        await App.supabase
                            .from('profiles')
                            .update({ 
                                full_name: displayName,
                                updated_at: new Date().toISOString() 
                            })
                            .eq('id', currentUser.id);
                        console.log('‚úÖ Synced metadata name (fullname) to database');
                    } catch (updateError) {
                        console.warn('‚ö†Ô∏è Could not sync metadata name (fullname) to database:', updateError);
                    }
                }
                // 4. Check localStorage as last resort
                else if (localStorage.getItem('user_full_name')?.trim()) {
                    displayName = localStorage.getItem('user_full_name').trim();
                    nameSource = 'localStorage';
                    console.log('‚ÑπÔ∏è Using name from localStorage:', displayName);
                    
                    // Sync localStorage name to database
                    try {
                        await App.supabase
                            .from('profiles')
                            .update({ 
                                full_name: displayName,
                                updated_at: new Date().toISOString() 
                            })
                            .eq('id', currentUser.id);
                        console.log('‚úÖ Synced localStorage name to database');
                        
                        // Verify the update worked by re-querying
                        const { data: verifyProfile } = await App.supabase
                            .from('profiles')
                            .select('full_name')
                            .eq('id', currentUser.id)
                            .single();
                        
                        if (verifyProfile?.full_name === displayName) {
                            console.log('‚úÖ Verified database update successful');
                        } else {
                            console.warn('‚ö†Ô∏è Database update may have failed - verification mismatch');
                        }
                    } catch (updateError) {
                        console.warn('‚ö†Ô∏è Could not sync localStorage name to database:', updateError);
                    }
                }
                // 5. Last resort: use email username
                else if (currentUser.email) {
                    displayName = currentUser.email.split('@')[0];
                    nameSource = 'email_username';
                    console.warn('‚ö†Ô∏è No full name found, falling back to email username:', displayName);
                }
                
                console.log('‚úÖ Final selected name:', displayName, 'from source:', nameSource);
                
                console.groupEnd();
                
                // Update all name elements on the page
                document.querySelectorAll('[id^="user"][id$="name"]').forEach(el => {
                    if (el) {
                        console.log(`Updating element ${el.id} with:`, displayName);
                        el.textContent = displayName;
                    }
                });
                
                // Update the profile in the database if needed
                if (profile && (!profile.full_name || profile.full_name !== displayName) && displayName !== 'User') {
                    console.log('üîÑ Updating profile to match display name:', displayName);
                    console.log('Current profile state:', {
                        id: profile.id,
                        full_name: profile.full_name,
                        displayName: displayName
                    });
                    
                    try {
                        // Update the profile in the profiles table
                        const { data: updateResult, error: updateError } = await App.supabase
                            .from('profiles')
                            .update({ 
                                full_name: displayName,
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', currentUser.id)
                            .select()
                            .single();
                            
                        console.log('Profile update result:', { updateResult, updateError });
                        
                        if (updateError) {
                            console.error('‚ùå Profile update failed:', updateError);
                            throw updateError;
                        }
                        
                        if (updateResult?.full_name === displayName) {
                            console.log('‚úÖ Profile update verified successfully');
                        } else {
                            console.warn('‚ö†Ô∏è Profile update verification mismatch');
                        }
                        
                        // Also update the user's metadata
                        const { error: metaError } = await App.supabase.auth.updateUser({
                            data: { 
                                full_name: displayName,
                                email: currentUser.email
                            }
                        });
                        
                        if (metaError) {
                            console.error('‚ùå Metadata update failed:', metaError);
                            throw metaError;
                        }
                        
                        console.log('‚úÖ Successfully updated profile and metadata with full name');
                        
                    } catch (updateError) {
                        console.error('‚ùå Error updating user profile and metadata:', updateError);
                        // Store in localStorage as fallback
                        localStorage.setItem('user_full_name', displayName);
                    }
                } else {
                    console.log('‚ÑπÔ∏è Profile update not needed - name already matches or conditions not met');
                }
                    
                    // Load saved profile photo with localStorage fallback
                    const profileDiv = document.getElementById('profile-photo');
                    let photoUrl = profile.photo_url;
                    
                    // If no photo in database, check localStorage
                    if (!photoUrl) {
                        photoUrl = localStorage.getItem(`profile_photo_${currentUser.id}`);
                        console.log('üîç Checking localStorage for profile photo:', photoUrl ? 'Found' : 'Not found');
                    }
                    
                    if (photoUrl) {
                        console.log('‚úÖ Loading saved profile photo:', photoUrl);
                        profileDiv.innerHTML = `<img src="${photoUrl}" alt="Profile" class="w-full h-full rounded-full object-cover">`;
                        
                        // If photo was from localStorage, update database
                        if (!profile.photo_url && photoUrl) {
                            console.log('üíæ Syncing localStorage photo to database...');
                            try {
                                await App.supabase
                                    .from('profiles')
                                    .update({ photo_url: photoUrl })
                                    .eq('id', currentUser.id);
                                console.log('‚úÖ Photo synced to database');
                            } catch (syncError) {
                                console.log('‚ö†Ô∏è Could not sync photo to database:', syncError);
                            }
                        }
                    } else {
                        console.log('üì∑ No profile photo found, using default icon');
                    }

                // Update last login time for this dashboard visit
                try {
                    await App.supabase
                        .from('profiles')
                        .upsert({ 
                            id: currentUser.id,
                            email: currentUser.email,
                            full_name: profile?.full_name || currentUser.user_metadata?.full_name || currentUser.user_metadata?.fullname || currentUser.email.split('@')[0],
                            last_sign_in_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        });
                    console.log('Dashboard visit logged');
                } catch (updateError) {
                    console.error('Error updating login time:', updateError);
                }

                // Load earnings
                await loadEarnings();
                
                // Start real-time earnings monitoring
                startEarningsMonitoring();
                
                // Hide loading indicator
                document.getElementById('loading-indicator').style.display = 'none';
                
            } catch (error) {
                console.error('Error initializing dashboard:', error);
                await App.signOut();
            }
        }

        // ENHANCED Load user earnings with real-time updates including All Time Earnings
        async function loadEarnings() {
            try {
                console.log('Loading earnings for user:', currentUser.id);
                
                // First, log the structure of the earnings table for debugging
                const { data: allEarnings, error: fetchError } = await window.App.supabase
                    .from('earnings')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .limit(1);
                
                console.log('Initial earnings table structure:', allEarnings);
                
                // Then fetch the latest earnings
                const { data: earnings, error } = await window.App.supabase
                    .from('earnings')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('updated_at', { ascending: false })
                    .limit(1)
                    .single();
                
                if (error && error.code !== 'PGRST116') { // PGRST116 = no rows returned
                    throw error;
                }
                
                userEarnings = earnings;
                
                if (earnings) {
                    // Use new column names if available, fall back to old ones
                    const todayEarnings = earnings.today_earnings !== undefined ? earnings.today_earnings : (earnings.today || 0);
                    const weekEarnings = earnings.week_earnings !== undefined ? earnings.week_earnings : (earnings.week || 0);
                    const monthEarnings = earnings.month_earnings !== undefined ? earnings.month_earnings : (earnings.total || 0);
                    const allTimeEarnings = earnings.all_time_earnings !== undefined ? earnings.all_time_earnings : (earnings.total || 0);
                    
                    console.log('Current earnings:', {
                        today: todayEarnings,
                        week: weekEarnings,
                        month: monthEarnings,
                        allTime: allTimeEarnings,
                        updated: earnings.updated_at
                    });
                    
                    // Animate counters with values
                    animateCounter('today-earnings', todayEarnings);
                    animateCounter('week-earnings', weekEarnings);
                    animateCounter('month-earnings', monthEarnings);
                    animateCounter('alltime-earnings', allTimeEarnings);
                    
                    // Store last update time for change detection
                    window.lastEarningsUpdate = earnings.updated_at;
                } else {
                    console.log('No earnings record found, showing zeros');
                    // If no earnings record exists, show zeros
                    animateCounter('today-earnings', 0);
                    animateCounter('week-earnings', 0);
                    animateCounter('month-earnings', 0);
                    animateCounter('alltime-earnings', 0);
                }
            } catch (error) {
                console.error('Error loading earnings:', error);
                // Show zeros on error
                animateCounter('today-earnings', 0);
                animateCounter('week-earnings', 0);
                animateCounter('month-earnings', 0);
                animateCounter('alltime-earnings', 0);
            }
        }
        
        // REAL-TIME EARNINGS MONITORING - Checks for updates from admin including All Time
        async function startEarningsMonitoring() {
            console.log('Starting real-time earnings monitoring...');
            
            // Check for updates every 5 seconds
            setInterval(async () => {
                try {
                    // First, let's log the structure of the earnings table for debugging
                    const { data: allEarnings, error: fetchError } = await window.App.supabase
                        .from('earnings')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .limit(1);
                    
                    console.log('Earnings table structure:', allEarnings);
                    
                    // Then fetch the latest earnings
                    const { data: latestEarnings, error } = await window.App.supabase
                        .from('earnings')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .order('updated_at', { ascending: false })
                        .limit(1)
                        .single();
                    
                    if (!error && latestEarnings) {
                        // Check if earnings were updated since last check
                        if (window.lastEarningsUpdate !== latestEarnings.updated_at) {
                            // Use the correct column names from the database
                            const todayEarnings = latestEarnings.today || 0;
                            const weekEarnings = latestEarnings.week || 0;
                            const monthEarnings = latestEarnings.total || 0;
                            const allTimeEarnings = latestEarnings.total || 0;
                            
                            console.log('Earnings updated by admin! Triggering counter animation...');
                            console.log('New values:', {
                                today: todayEarnings,
                                week: weekEarnings,
                                month: monthEarnings,
                                allTime: allTimeEarnings
                            });
                            
                            // Show notification
                            if (window.showEarningsUpdatedNotification) {
                                showNotification('Earnings updated!', 'success');
                            }
                            
                            // Re-animate counters with new values including all time
                            animateCounter('today-earnings', todayEarnings);
                            animateCounter('week-earnings', weekEarnings);
                            animateCounter('month-earnings', monthEarnings);
                            animateCounter('alltime-earnings', allTimeEarnings);
                            
                            // Update stored values
                            userEarnings = latestEarnings;
                            window.lastEarningsUpdate = latestEarnings.updated_at;
                        }
                    }
                } catch (monitorError) {
                    // Silently handle monitoring errors to avoid spam
                    console.log('Earnings monitoring check failed:', monitorError);
                }
            }, 5000); // Check every 5 seconds
        }

        // Animate counter
        function animateCounter(elementId, targetValue) {
            const element = document.getElementById(elementId);
            const startValue = 0;
            const duration = 2000;
            const increment = targetValue / (duration / 16);
            let currentValue = startValue;

            const timer = setInterval(() => {
                currentValue += increment;
                if (currentValue >= targetValue) {
                    currentValue = targetValue;
                    clearInterval(timer);
                }
                element.textContent = `‚Çπ${Math.floor(currentValue)}`;
            }, 16);
        }

        // Enhanced profile photo upload with better error handling
        async function uploadProfilePhoto() {
            const fileInput = document.getElementById('photo-upload');
            const file = fileInput.files[0];
            
            if (!file) return;

            // Validate file type
            const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
            if (!validTypes.includes(file.type)) {
                alert('Please upload a valid image file (JPG, PNG, GIF, or WEBP)');
                return;
            }

            // Validate file size (2MB max)
            const maxSize = 2 * 1024 * 1024; // 2MB
            if (file.size > maxSize) {
                alert('Image is too large. Please use an image smaller than 2MB');
                return;
            }

            // Show loading state
            const profileDiv = document.getElementById('profile-photo');
            const originalContent = profileDiv.innerHTML;
            profileDiv.style.opacity = '0.5';
            profileDiv.innerHTML = '<i class="fas fa-spinner fa-spin text-white text-2xl"></i>';
            
            // Add loading indicator to upload button area
            const uploadArea = profileDiv.parentElement.querySelector('.bg-primary');
            const originalUploadContent = uploadArea.innerHTML;
            uploadArea.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                console.log('üîÑ Starting profile photo upload...');
                
                let uploadResult;
                
                try {
                    // Method 1: Try Supabase storage upload
                    const fileName = `${currentUser.id}/${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.-]/g, '_')}`;
                    
                    const { data, error } = await App.supabase.storage
                        .from('avatars')
                        .upload(fileName, file, { 
                            upsert: true,
                            contentType: file.type
                        });

                    if (error) throw error;

                    // Get public URL
                    const { data: urlData } = App.supabase.storage
                        .from('avatars')
                        .getPublicUrl(data.path);

                    uploadResult = { publicUrl: urlData.publicUrl };
                    console.log('‚úÖ Storage upload successful!');

                } catch (storageError) {
                    console.log('‚ö†Ô∏è Storage upload failed, using base64 fallback...');
                    
                    // Method 2: Base64 fallback
                    const base64 = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    });
                    
                    uploadResult = { publicUrl: base64 };
                    console.log('‚úÖ Base64 fallback successful!');
                }

                // Update profile in database
                await App.supabase
                    .from('profiles')
                    .update({ 
                        photo_url: uploadResult.publicUrl,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', currentUser.id);

                // Save to localStorage as backup
                localStorage.setItem(`profile_photo_${currentUser.id}`, uploadResult.publicUrl);
                console.log('üíæ Profile photo saved to localStorage as backup');

                // Update UI - convert div to img for uploaded photo
                profileDiv.innerHTML = `<img src="${uploadResult.publicUrl}" alt="Profile" class="w-full h-full rounded-full object-cover">`;
                profileDiv.style.opacity = '1';
                
                alert('Profile photo updated successfully! üì∏');
                console.log('‚úÖ Profile photo upload complete!');

            } catch (error) {
                console.error('‚ùå Profile photo upload failed:', error);
                
                // Reset UI
                profileDiv.innerHTML = originalContent;
                profileDiv.style.opacity = '1';
                
                // Show user-friendly error message
                let errorMsg = 'Failed to upload photo. Please try again.';
                
                if (error.message.includes('row-level security')) {
                    errorMsg = 'Storage permissions not set up. Please contact admin.';
                } else if (error.message.includes('bucket')) {
                    errorMsg = 'Storage not configured. Please contact admin.';
                } else if (error.message.includes('network') || error.message.includes('fetch')) {
                    errorMsg = 'Network error. Please check your connection and try again.';
                }
                
                alert(errorMsg);
            } finally {
                // Reset upload button
                uploadArea.innerHTML = originalUploadContent;
                fileInput.value = ''; // Reset file input
            }
        }

        // Navigation functions
        function showDashboard() {
            // Show earnings section and hide main cards
            const earningsSection = document.getElementById('earnings-section');
            const mainCards = document.getElementById('main-cards');
            
            if (earningsSection.classList.contains('hidden')) {
                // Hide main navigation cards
                mainCards.classList.add('hidden');
                
                // Show earnings section with animation
                earningsSection.classList.remove('hidden');
                earningsSection.classList.add('fade-in');
                console.log('üìä Earnings section displayed, main cards hidden');
                
                // Load earnings data
                loadEarnings();
                
                // Add back button to return to main view
                addBackButton();
            } else {
                // If already visible, just reload the page
                window.location.reload();
            }
        }

        // Load earnings data
        async function loadEarnings() {
            try {
                console.log('üí∞ Loading earnings data...');
                
                // Check if user exists
                if (!currentUser || !currentUser.id) {
                    console.warn('No current user found, using default earnings');
                    animateCounter('today-earnings', 0);
                    animateCounter('week-earnings', 0);
                    animateCounter('month-earnings', 0);
                    animateCounter('total-earnings', 0);
                    return;
                }
                
                const { data: earnings, error } = await App.fetchEarnings(currentUser.id);
                
                if (error) {
                    console.log('No earnings data found, using defaults');
                    // Still animate with 0 values
                    animateCounter('today-earnings', 0);
                    animateCounter('week-earnings', 0);
                    animateCounter('month-earnings', 0);
                    animateCounter('total-earnings', 0);
                    return;
                }
                
                // Update earnings display with animation
                if (earnings) {
                    console.log('Earnings data loaded:', earnings);
                    animateCounter('today-earnings', earnings.today_earnings || 0);
                    animateCounter('week-earnings', earnings.week_earnings || 0);
                    animateCounter('month-earnings', earnings.month_earnings || 0);
                    animateCounter('total-earnings', earnings.all_time_earnings || 0);
                } else {
                    // No earnings data, use defaults
                    animateCounter('today-earnings', 0);
                    animateCounter('week-earnings', 0);
                    animateCounter('month-earnings', 0);
                    animateCounter('total-earnings', 0);
                }
                
            } catch (error) {
                console.error('Error loading earnings:', error);
                // Still show default values on error
                animateCounter('today-earnings', 0);
                animateCounter('week-earnings', 0);
                animateCounter('month-earnings', 0);
                animateCounter('total-earnings', 0);
            }
        }
        
        // Animate counter numbers
        function animateCounter(elementId, targetValue) {
            const element = document.getElementById(elementId);
            
            // Check if element exists
            if (!element) {
                console.warn(`Element with ID '${elementId}' not found`);
                return;
            }
            
            const startValue = 0;
            const duration = 1000; // 1 second
            const startTime = performance.now();
            
            function updateCounter(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                const currentValue = startValue + (targetValue - startValue) * progress;
                
                // Double check element still exists
                if (element) {
                    element.textContent = '‚Çπ' + Math.floor(currentValue).toFixed(0);
                }
                
                if (progress < 1) {
                    requestAnimationFrame(updateCounter);
                }
            }
            
            requestAnimationFrame(updateCounter);
        }
        
        // Add back button to return to main view
        function addBackButton() {
            const earningsSection = document.getElementById('earnings-section');
            
            // Check if back button already exists
            if (earningsSection.querySelector('.back-button')) {
                return;
            }
            
            const backButton = document.createElement('button');
            backButton.className = 'back-button mt-4 bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg transition-colors flex items-center';
            backButton.innerHTML = '<i class="fas fa-arrow-left mr-2"></i>Back to Dashboard';
            backButton.onclick = () => {
                // Hide earnings section and show main cards
                earningsSection.classList.add('hidden');
                document.getElementById('main-cards').classList.remove('hidden');
                
                // Remove back button
                backButton.remove();
                
                console.log('üîô Returned to main dashboard view');
            };
            
            earningsSection.appendChild(backButton);
        }

        function showSubmitWork() {
            window.location.href = 'submit-report.html';
        }

        function showMyReports() {
            window.location.href = 'my-reports.html';
        }

        function showLiveCampaigns() {
            window.location.href = 'campaign.html';
        }


        async function logout() {
            try {
                console.log('Logging out...');
                // Sign out from Supabase
                const { error } = await window.App.supabase.auth.signOut();
                
                if (error) {
                    console.error('Error signing out:', error);
                    // Still redirect even if there was an error
                }
                
                // Clear any stored user data
                localStorage.removeItem('user');
                sessionStorage.clear();
                
                // Redirect to login page
                window.location.href = 'login.html';
            } catch (err) {
                console.error('Error during logout:', err);
                // Still redirect even if there was an error
                window.location.href = 'login.html';
            }
        }

        /**
         * Updates the user's full name in both profile and user metadata
         * @param {string} fullName - The full name to update
         */
        async function updateUserFullName(fullName) {
            if (!fullName?.trim()) {
                console.warn('‚ö†Ô∏è Cannot update: Invalid full name provided');
                return false;
            }
            
            // Validate currentUser exists
            if (!currentUser || !currentUser.id) {
                const errorMsg = 'Cannot update: User not authenticated or session expired';
                console.error('‚ùå', errorMsg);
                alert('Session expired. Please log in again.');
                window.location.href = 'login.html';
                throw new Error(errorMsg);
            }
            
            console.log('üîÑ Starting name update process...');
            console.log('Current user state:', {
                id: currentUser.id,
                email: currentUser.email,
                metadata: currentUser.user_metadata
            });
            
            try {
                console.log(`üîÑ Updating full name to: ${fullName}`);
                
                // 1. Update user metadata through App.supabase
                const { data: { user }, error: metaError } = await App.supabase.auth.updateUser({
                    data: { 
                        full_name: fullName,
                        email: currentUser.email
                    }
                });
                
                if (metaError) {
                    console.error('‚ùå Metadata update failed:', metaError);
                    throw new Error(`Failed to update user metadata: ${metaError.message || JSON.stringify(metaError)}`);
                }
                
                console.log('‚úÖ User metadata updated successfully');
                
                // Update the current user object with the updated metadata
                if (user) {
                    currentUser = user;
                    console.log('‚úÖ Current user object updated');
                }
                
                // 2. Update profile in database
                console.log('üíæ Updating profile in database...');
                console.log('Database update payload:', {
                    full_name: fullName,
                    updated_at: new Date().toISOString(),
                    email: currentUser.email,
                    user_id: currentUser.id
                });
                
                const { data: profileData, error: profileError } = await App.supabase
                    .from('profiles')
                    .update({ 
                        full_name: fullName,
                        updated_at: new Date().toISOString(),
                        email: currentUser.email  // Ensure email is also updated
                    })
                    .eq('id', currentUser.id)
                    .select()
                    .single();
                
                console.log('Database response:', { profileData, profileError });
                
                if (profileError) {
                    console.error('‚ùå Profile database update failed:', profileError);
                    console.error('Error details:', {
                        message: profileError.message,
                        code: profileError.code,
                        details: profileError.details,
                        hint: profileError.hint
                    });
                    throw new Error(`Failed to update profile in database: ${profileError.message || JSON.stringify(profileError)}`);
                }
                
                if (!profileData) {
                    console.error('‚ùå No profile data returned from database update');
                    throw new Error('Database update succeeded but no data returned');
                }
                
                console.log('‚úÖ Profile updated in database:', profileData);
                
                // Verify the database update worked
                console.log('üîç Verifying database update...');
                const { data: verifyProfile, error: verifyError } = await App.supabase
                    .from('profiles')
                    .select('full_name, updated_at')
                    .eq('id', currentUser.id)
                    .single();
                
                if (verifyError) {
                    console.error('‚ùå Could not verify database update:', verifyError);
                } else if (verifyProfile?.full_name === fullName) {
                    console.log('‚úÖ Database update verified successfully:', verifyProfile);
                } else {
                    console.error('‚ùå Database update verification failed:', {
                        expected: fullName,
                        actual: verifyProfile?.full_name,
                        profile: verifyProfile
                    });
                    throw new Error('Database update succeeded but verification failed');
                }
                
                // 3. Update localStorage
                localStorage.setItem('user_full_name', fullName);
                console.log('‚úÖ localStorage updated');
                
                // 4. Update current user object
                if (!currentUser.user_metadata) {
                    currentUser.user_metadata = {};
                }
                currentUser.user_metadata.full_name = fullName;
                
                console.log('‚úÖ Successfully updated full name to:', fullName);
                console.log('‚úÖ Name update process completed successfully');
                
                // Final verification - make sure the profile reflects the update
                console.log('üîç Final verification of profile data...');
                const { data: finalProfile } = await App.supabase
                    .from('profiles')
                    .select('full_name, updated_at')
                    .eq('id', currentUser.id)
                    .single();
                
                console.log('Final profile state:', finalProfile);
                if (finalProfile?.full_name === fullName) {
                    console.log('‚úÖ Final verification successful - name is persisted in database');
                } else {
                    console.error('‚ùå Final verification failed - name not properly persisted');
                }
                
                return true;
                
            } catch (error) {
                console.error('‚ùå Error updating full name:', {
                    message: error?.message || 'Unknown error',
                    name: error?.name || 'Error',
                    stack: error?.stack || 'No stack trace',
                    fullError: error,
                    errorString: String(error),
                    currentUser: currentUser ? {
                        id: currentUser.id,
                        email: currentUser.email
                    } : null
                });
                throw error; // Re-throw to be caught by the caller
            }
        }
        
        // Add event listener for name update button if it exists
        document.addEventListener('DOMContentLoaded', () => {
            const updateNameBtn = document.getElementById('update-name-btn');
            if (updateNameBtn) {
                updateNameBtn.addEventListener('click', async () => {
                    // Get current name from the displayed element as a fallback
                    const currentName = document.getElementById('user-full-name')?.textContent || '';
                    const newName = prompt('Enter your full name:', currentName);
                    
                    if (newName && newName.trim()) {
                        try {
                            console.log('Attempting to update name to:', newName.trim());
                            const success = await updateUserFullName(newName.trim());
                            if (success) {
                                // Update the UI immediately
                                const nameElement = document.getElementById('user-full-name');
                                if (nameElement) {
                                    nameElement.textContent = newName.trim();
                                }
                                // Show success message
                                alert('Name updated successfully!');
                            } else {
                                throw new Error('Failed to update name - function returned false');
                            }
                        } catch (error) {
                            console.error('Error updating name:', {
                                message: error?.message || 'Unknown error',
                                error: error,
                                errorString: String(error)
                            });
                            alert(`Failed to update name: ${error?.message || 'Unknown error'}. Please try again or check console for details.`);
                        }
                    }
                });
            }
        });

        // Initialize on page load after all scripts are loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initDashboard);
        } else {
            // DOMContentLoaded has already fired
            setTimeout(initDashboard, 0);
        }
    </script>
</body>
</html>
