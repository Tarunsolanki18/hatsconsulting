<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Earnings</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    .income-card {
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      color: white;
    }
    .income-card h2 {
      font-size: 40px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .income-card p {
      margin-bottom: 20px;
    }
    .income-card .view-details {
      text-align: right;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-top: 1px solid rgba(255, 255, 255, 0.2);
      padding-top: 10px;
      margin-top: 10px;
    }
    .profile-container {
      background-color: #0039CB;
      border-radius: 12px;
      padding: 30px 20px;
      margin-bottom: 20px;
      color: white;
      text-align: center;
      position: relative;
    }
    .profile-pic {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background-color: #f0f0ff;
      margin: 0 auto 15px;
      position: relative;
      overflow: hidden;
      border: 3px solid white;
    }
    .profile-pic img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .profile-pic .change-photo {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.6);
      color: white;
      padding: 5px;
      font-size: 12px;
      cursor: pointer;
    }
    .package-badge {
      background-color: white;
      color: black;
      border-radius: 20px;
      padding: 5px 15px;
      display: inline-block;
      margin-top: 10px;
      font-weight: 500;
    }
  </style>
</head>
<body class="bg-gray-100 font-[Inter]">
  <div class="max-w-md mx-auto p-4">
    <div class="flex items-center justify-between mb-4">
      <a href="dashboard.html" class="text-blue-600">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
      </a>
      <h1 class="text-xl font-bold">My Earnings</h1>
      <div></div>
    </div>

    <!-- Profile Section -->
    <div class="profile-container">
      <div class="profile-pic">
        <img id="profile-image" src="https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png" alt="Profile Picture">
        <div class="change-photo" id="change-photo-btn">Change Photo</div>
        <input type="file" id="photo-upload" accept="image/*" style="display: none;">
      </div>
      <h2 id="user-name" class="text-2xl font-bold">User Name</h2>
      <div class="package-badge">MASTER PACKAGE</div>
    </div>

    <!-- Today's Income -->
    <div class="income-card" style="background-color: #9C0058;">
      <h2 id="today-income">₹ 0</h2>
      <p>Today's Income</p>
      <div class="view-details">
        <span>View details</span>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </div>
    </div>

    <!-- 7 Days Income -->
    <div class="income-card" style="background-color: #A67C00;">
      <h2 id="week-income">₹ 0</h2>
      <p>7 Days Income</p>
      <div class="view-details">
        <span>View details</span>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </div>
    </div>

    <!-- 30 Days Income -->
    <div class="income-card" style="background-color: #00008B;">
      <h2 id="month-income">₹ 0</h2>
      <p>30 Days Income</p>
      <div class="view-details">
        <span>View details</span>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </div>
    </div>

    <!-- All Time Income -->
    <div class="income-card" style="background-color: #4B0082;">
      <h2 id="total-income">₹ 0</h2>
      <p>All Time Income</p>
      <div class="view-details">
        <span>View details</span>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script src="./assets/config.js"></script>
  <script src="./assets/app.js"></script>
  <script>
    (async function() {
      const session = await App.requireAuth({ redirectTo: 'login.html' });
      const user = session.user;
      
      // Set user name
      const userName = user.user_metadata?.fullname || user.email.split('@')[0];
      document.getElementById('user-name').textContent = userName;
      
      // Fetch earnings data with all time earnings
      const { data: earnings } = await App.supabase
        .from('earnings')
        .select('today_earnings, week_earnings, month_earnings, all_time_earnings, today, week, total')
        .eq('user_id', user.id)
        .single();
      
      // Use new column names if available, fallback to old ones
      const todayEarnings = earnings?.today_earnings || earnings?.today || 0;
      const weekEarnings = earnings?.week_earnings || earnings?.week || 0;
      const monthEarnings = earnings?.month_earnings || earnings?.total || 0;
      const allTimeEarnings = earnings?.all_time_earnings || earnings?.total || 0;
      
      document.getElementById('today-income').textContent = `₹ ${todayEarnings}`;
      document.getElementById('week-income').textContent = `₹ ${weekEarnings}`;
      document.getElementById('month-income').textContent = `₹ ${monthEarnings}`;
      document.getElementById('total-income').textContent = `₹ ${allTimeEarnings}`;
      
      // Profile photo functionality
      const changePhotoBtn = document.getElementById('change-photo-btn');
      const photoUpload = document.getElementById('photo-upload');
      const profileImage = document.getElementById('profile-image');
      
      // Add status message element
      const statusContainer = document.createElement('div');
      statusContainer.style.position = 'fixed';
      statusContainer.style.top = '20px';
      statusContainer.style.left = '50%';
      statusContainer.style.transform = 'translateX(-50%)';
      statusContainer.style.padding = '10px 20px';
      statusContainer.style.borderRadius = '5px';
      statusContainer.style.color = 'white';
      statusContainer.style.fontWeight = 'bold';
      statusContainer.style.zIndex = '1000';
      statusContainer.style.display = 'none';
      document.body.appendChild(statusContainer);
      
      // Show status message function
      const showStatus = (message, type) => {
        statusContainer.textContent = message;
        statusContainer.style.backgroundColor = type === 'success' ? '#4CAF50' : '#F44336';
        statusContainer.style.display = 'block';
        
        setTimeout(() => {
          statusContainer.style.display = 'none';
        }, 3000);
      };
      
      // Check if user has a profile photo
      const { data: profile } = await App.supabase
        .from('profiles')
        .select('avatar_url')
        .eq('id', user.id)
        .single();
        
      if (profile?.avatar_url) {
        profileImage.src = profile.avatar_url;
      }
      
      // Handle photo change
      changePhotoBtn.addEventListener('click', () => {
        photoUpload.click();
      });
      
      photoUpload.addEventListener('change', async (event) => {
        const file = event.target.files[0];
        if (!file) return;
        
        // Validate file type
        const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
        if (!validTypes.includes(file.type)) {
          showStatus('Invalid file type. Please use JPG, PNG, GIF or WEBP.', 'error');
          return;
        }
        
        // Validate file size (max 2MB)
        const maxSize = 2 * 1024 * 1024; // 2MB
        if (file.size > maxSize) {
          showStatus('Image too large. Maximum size is 2MB.', 'error');
          return;
        }
        
        // Show loading state
        changePhotoBtn.textContent = 'Uploading...';
        changePhotoBtn.style.backgroundColor = 'rgba(0,0,0,0.8)';
        
        try {
          // Convert image to base64 instead of using storage
          const reader = new FileReader();
          reader.readAsDataURL(file);
          
          reader.onload = async () => {
            const base64Image = reader.result;
            
            try {
              // Update profile with base64 image
              const { error: updateError } = await App.supabase
                .from('profiles')
                .update({ avatar_url: base64Image })
                .eq('id', user.id);
                
              if (updateError) throw updateError;
              
              // Update UI
              profileImage.src = base64Image;
              changePhotoBtn.textContent = 'Change Photo';
              changePhotoBtn.style.backgroundColor = 'rgba(0,0,0,0.6)';
              
              // Show success message
              showStatus('Profile photo updated successfully!', 'success');
            } catch (error) {
              console.error('Error updating profile:', error);
              changePhotoBtn.textContent = 'Failed - Try Again';
              showStatus('Failed to update profile. Please try again.', 'error');
            }
          };
          
          reader.onerror = (error) => {
            console.error('Error reading file:', error);
            changePhotoBtn.textContent = 'Failed - Try Again';
            showStatus('Failed to read image file. Please try again.', 'error');
          };
        } catch (error) {
          console.error('Error uploading image:', error);
          changePhotoBtn.textContent = 'Failed - Try Again';
          showStatus('Failed to upload image. Please try again.', 'error');
        }
      });
    })();
  </script>
</body>
</html>